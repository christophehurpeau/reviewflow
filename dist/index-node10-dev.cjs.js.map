{"version":3,"file":"index-node10-dev.cjs.js","sources":["../src/auth/github.ts","../src/views/Layout.tsx","../src/app/auth.tsx","../src/app/home.tsx","../src/accountConfigs/christophehurpeau.ts","../src/accountConfigs/defaultConfig.ts","../src/accountConfigs/ornikar.ts","../src/accountConfigs/reviewflow.ts","../src/accountConfigs/index.ts","../src/dm/defaultDmSettings.ts","../src/dm/getUserDmSettings.ts","../src/events/account-handlers/actions/syncOrg.ts","../src/events/account-handlers/actions/syncTeams.ts","../src/app/org-settings.tsx","../src/app/repository.tsx","../src/events/account-handlers/actions/syncUser.ts","../src/app/user-settings.tsx","../src/appRouter.tsx","../src/utils/Excludes.ts","../src/context/getOrCreateAccount.ts","../src/context/utils.ts","../src/context/voidTeamSlack.ts","../src/context/initTeamSlack.ts","../src/context/accountContext.ts","../src/events/account-handlers/utils/handler.ts","../src/events/pr-handlers/actions/utils/body/prOptions.ts","../src/events/pr-handlers/actions/utils/body/parseBody.ts","../src/events/pr-handlers/actions/utils/hasLabelInPR.ts","../src/events/pr-handlers/actions/autoMergeIfPossible.ts","../src/events/pr-handlers/actions/utils/body/updateBody.ts","../src/events/pr-handlers/utils/reviewflowComment.ts","../src/events/pr-handlers/utils/createPullRequestContext.ts","../src/events/pr-handlers/utils/fetchPr.ts","../src/context/initRepoLabels.ts","../src/context/repoContext.ts","../src/events/repository-handlers/utils/createRepoHandler.ts","../src/events/pr-handlers/utils/createPullRequestHandler.ts","../src/events/pr-handlers/checkrunCompleted.ts","../src/events/pr-handlers/checksuiteCompleted.ts","../src/events/pr-handlers/actions/utils/createStatus.ts","../src/events/pr-handlers/actions/updateStatusCheckFromLabels.ts","../src/events/pr-handlers/actions/updateReviewStatus.ts","../src/events/pr-handlers/closed.ts","../src/slack/utils.ts","../src/events/pr-handlers/utils/createSlackMessageWithSecondaryBlock.ts","../src/events/pr-handlers/utils/getPullRequestFromPayload.ts","../src/events/pr-handlers/utils/getReviewersAndReviewStates.ts","../src/events/pr-handlers/utils/isBotUser.ts","../src/events/pr-handlers/utils/parseMentions.ts","../src/events/pr-handlers/utils/slackifyCommentBody.ts","../src/events/pr-handlers/commentCreated.ts","../src/events/pr-handlers/actions/updatePrCommentBody.ts","../src/events/pr-handlers/actions/utils/syncLabel.ts","../src/events/pr-handlers/actions/syncLabelsAfterCommentBodyEdited.ts","../src/events/pr-handlers/commentEditedOrDeleted.ts","../src/events/pr-handlers/actions/readCommitsAndUpdateInfos.ts","../src/events/pr-handlers/actions/updatePr.ts","../src/events/pr-handlers/actions/utils/cleanTitle.ts","../src/events/pr-handlers/actions/editOpenedPR.ts","../src/events/pr-handlers/edited.ts","../src/events/pr-handlers/actions/updateBranch.ts","../src/events/pr-handlers/labelsChanged.ts","../src/events/pr-handlers/actions/autoApproveAndAutoMerge.ts","../src/events/pr-handlers/actions/autoAssignPRToCreator.ts","../src/events/pr-handlers/opened.ts","../src/events/pr-handlers/reopened.ts","../src/events/pr-handlers/reviewDismissed.ts","../src/events/pr-handlers/reviewRequestRemoved.ts","../src/events/pr-handlers/reviewRequested.ts","../src/events/pr-handlers/reviewSubmitted.ts","../src/events/pr-handlers/status.ts","../src/events/pr-handlers/synchronize.ts","../src/events/repository-handlers/repoEdited.ts","../src/initApp.ts","../src/mongo.ts","../src/slack/home.ts","../src/index.ts"],"sourcesContent":["import { create } from 'simple-oauth2';\n\nif (!process.env.GITHUB_CLIENT_ID) {\n  throw new Error('Missing env variable: GITHUB_CLIENT_ID');\n}\n\nif (!process.env.GITHUB_CLIENT_SECRET) {\n  throw new Error('Missing env variable: GITHUB_CLIENT_SECRET');\n}\n\nexport const oauth2 = create({\n  client: {\n    id: process.env.GITHUB_CLIENT_ID,\n    secret: process.env.GITHUB_CLIENT_SECRET,\n  },\n  auth: {\n    tokenHost: 'https://github.com',\n    tokenPath: '/login/oauth/access_token',\n    authorizePath: '/login/oauth/authorize',\n  },\n});\n","import type { ReactElement, ReactNode } from 'react';\nimport React from 'react';\n\ninterface LayoutProps {\n  lang?: string;\n  title?: string;\n  children: ReactNode;\n}\n\nexport default function Layout({\n  lang = 'en',\n  title = process.env.REVIEWFLOW_NAME,\n  children,\n}: LayoutProps): ReactElement {\n  return (\n    <html lang={lang}>\n      <head>\n        <meta charSet=\"UTF-8\" />\n        <meta name=\"robots\" content=\"noindex\" />\n        <title>{title}</title>\n        <link\n          rel=\"stylesheet\"\n          type=\"text/css\"\n          href=\"https://christophe.hurpeau.com/index.css\"\n        />\n        <style>{`html,body,html body\n            #container{height:100%} footer{position:absolute;bottom:5px;left:0;right:0;}`}</style>\n      </head>\n      <body>\n        <div style={{ padding: '24px 48px' }}>{children}</div>\n      </body>\n    </html>\n  );\n}\n","import { promisify } from 'util';\nimport type { Router, Request, Response } from 'express';\nimport { sign, verify } from 'jsonwebtoken';\nimport type { ProbotOctokit } from 'probot';\nimport React from 'react';\nimport { renderToStaticMarkup } from 'react-dom/server';\nimport * as githubAuth from '../auth/github';\nimport Layout from '../views/Layout';\n\nif (!process.env.AUTH_SECRET_KEY) {\n  throw new Error('Missing env variable: AUTH_SECRET_KEY');\n}\n\nconst AUTH_SECRET_KEY: string = process.env.AUTH_SECRET_KEY;\n\nconst signPromisified: any = promisify(sign);\nconst verifyPromisified: any = promisify(verify);\n\nconst secure =\n  !!process.env.SECURE_COOKIE && process.env.SECURE_COOKIE !== 'false';\n\nconst createRedirectUri = (req: Request): string => {\n  const host = `http${secure ? 's' : ''}://${req.hostname}${\n    req.hostname === 'localhost' ? `:${process.env.PORT}` : ''\n  }`;\n  return `${host}/app/login-response`;\n};\n\ninterface AuthInfo {\n  id: number;\n  login: string;\n  accessToken: string;\n  time: number;\n}\n\nconst readAuthCookie = (\n  req: Request,\n  strategy: string,\n): undefined | Promise<undefined | AuthInfo> => {\n  const cookie = req.cookies[`auth_${strategy}`];\n  if (!cookie) return;\n\n  return verifyPromisified(cookie, AUTH_SECRET_KEY, {\n    algorithm: 'HS512',\n    audience: req.headers['user-agent'],\n  });\n};\n\nconst getAuthInfoFromCookie = async (\n  req: Request,\n  res: Response,\n): Promise<undefined | AuthInfo> => {\n  const strategy = 'gh'; // req.params.strategy\n  const authInfo = await readAuthCookie(req, strategy);\n\n  if (authInfo?.id) {\n    return authInfo;\n  }\n\n  res.clearCookie(`auth_${strategy}`);\n  return undefined;\n};\n\nasync function createApi(\n  octokitApp: InstanceType<typeof ProbotOctokit>,\n  accessToken: string,\n): Promise<InstanceType<typeof ProbotOctokit>> {\n  return (await octokitApp.auth({\n    type: 'token',\n    token: accessToken,\n  })) as InstanceType<typeof ProbotOctokit>;\n}\n\nexport const getUser = async (\n  req: Request,\n  res: Response,\n  octokit: InstanceType<typeof ProbotOctokit>,\n): Promise<{\n  authInfo: AuthInfo;\n  api: InstanceType<typeof ProbotOctokit>;\n} | null> => {\n  const authInfo = await getAuthInfoFromCookie(req, res);\n  if (!authInfo) {\n    res.redirect('/app/login');\n    return null;\n  }\n\n  const api = await createApi(octokit, authInfo.accessToken);\n\n  return {\n    authInfo,\n    api,\n  };\n};\n\nexport default function auth(\n  router: Router,\n  octokitApp: InstanceType<typeof ProbotOctokit>,\n): void {\n  router.get('/login', async (req: Request, res: Response) => {\n    if (await getAuthInfoFromCookie(req, res)) {\n      return res.redirect('/app');\n    }\n\n    // const state = await randomHex(8);\n    // res.cookie(`auth_${strategy}_${state}`, strategy, {\n    //   maxAge: 10 * 60 * 1000,\n    //   httpOnly: true,\n    //   secure,\n    // });\n\n    const redirectUri = githubAuth.oauth2.authorizationCode.authorizeURL({\n      redirect_uri: createRedirectUri(req),\n      scope: 'read:user,repo',\n      // state,\n      // grant_type: options.grantType,\n      // access_type: options.accessType,\n      // login_hint: req.query.loginHint,\n      // include_granted_scopes: options.includeGrantedScopes,\n    });\n\n    // console.log(redirectUri);\n\n    res.redirect(redirectUri);\n  });\n\n  router.get('/login-response', async (req, res) => {\n    if (req.query.error) {\n      res.send(req.query.error_description);\n      return;\n    }\n\n    const strategy = 'gh';\n    const code: string = req.query.code as string;\n    // const state = req.query.state;\n    // const cookieName = `auth_${strategy}_${state}`;\n    // const cookie = req.cookies && req.cookies[cookieName];\n    // if (!cookie) {\n    //   // res.redirect(`/${strategy}/login`);\n    //   res.send(\n    //     '<html><body>No cookie for this state. <a href=\"/app/login\">Retry ?</a></body></html>',\n    //   );\n    //   return;\n    // }\n    // res.clearCookie(cookieName);\n\n    const result = await githubAuth.oauth2.authorizationCode.getToken({\n      code,\n      redirect_uri: createRedirectUri(req),\n    });\n\n    if (!result) {\n      res.send(\n        renderToStaticMarkup(\n          <Layout>\n            <div>\n              Could not get access token. <a href=\"/app/login\">Retry ?</a>\n            </div>\n          </Layout>,\n        ),\n      );\n      return;\n    }\n\n    const accessToken = result.access_token;\n    const api = await createApi(octokitApp, accessToken);\n    const user = await api.users.getAuthenticated({});\n    const id = user.data.id;\n    const login = user.data.login;\n\n    const authInfo: AuthInfo = { id, login, accessToken, time: Date.now() };\n    const token = await signPromisified(authInfo, AUTH_SECRET_KEY, {\n      algorithm: 'HS512',\n      audience: req.headers['user-agent'],\n      expiresIn: '10 days',\n    });\n\n    res.cookie(`auth_${strategy}`, token, {\n      httpOnly: true,\n      secure,\n    });\n\n    res.redirect('/app');\n  });\n}\n","import type { Router } from 'express';\nimport type { ProbotOctokit } from 'probot';\nimport React from 'react';\nimport { renderToStaticMarkup } from 'react-dom/server';\nimport type { MongoStores } from '../mongo';\nimport Layout from '../views/Layout';\nimport { getUser } from './auth';\n\nexport default function home(\n  router: Router,\n  octokitApp: InstanceType<typeof ProbotOctokit>,\n  mongoStores: MongoStores,\n): void {\n  router.get('/', async (req, res) => {\n    const user = await getUser(req, res, octokitApp);\n    if (!user) return;\n\n    const orgs = await user.api.orgs.listForAuthenticatedUser();\n\n    res.send(\n      renderToStaticMarkup(\n        <Layout>\n          <div>\n            <h1>{process.env.REVIEWFLOW_NAME}</h1>\n            <div style={{ display: 'flex' }}>\n              <div style={{ flexGrow: 1 }}>\n                <h4>Choose your account</h4>\n                <ul>\n                  <li>\n                    <a href=\"/app/user\">{user.authInfo.login}</a>\n                  </li>\n                  {orgs.data.map((org) => (\n                    <li key={org.id}>\n                      <a href={`/app/org/${org.login}`}>{org.login}</a>\n                    </li>\n                  ))}\n                </ul>\n              </div>\n            </div>\n          </div>\n        </Layout>,\n      ),\n    );\n  });\n}\n","import type { Config } from './types';\n\nconst config: Config<'dev', never> = {\n  autoAssignToCreator: true,\n  trimTitle: true,\n  requiresReviewRequest: false,\n  prDefaultOptions: {\n    featureBranch: false,\n    autoMergeWithSkipCi: false,\n    autoMerge: false,\n    deleteAfterMerge: true,\n  },\n  parsePR: {\n    title: [\n      {\n        regExp:\n          // eslint-disable-next-line unicorn/no-unsafe-regex\n          /^(revert: )?(build|chore|ci|docs|feat|fix|perf|refactor|style|test)(\\(([/a-z-]*)\\))?(!)?:\\s/,\n        error: {\n          title: 'Title does not match commitlint conventional',\n          summary:\n            'https://github.com/marionebl/commitlint/tree/master/%40commitlint/config-conventional',\n        },\n      },\n    ],\n  },\n  groups: {\n    dev: {\n      christophehurpeau: 'christophe@hurpeau.com',\n      tilap: 'jlavinh@gmail.com',\n    },\n  },\n  waitForGroups: {\n    dev: [],\n  },\n  teams: {},\n  labels: {\n    list: {\n      // /* ci */\n      // 'ci/in-progress': { name: ':green_heart: ci/in-progress', color: '#0052cc' },\n      // 'ci/fail': { name: ':green_heart: ci/fail', color: '#e11d21' },\n      // 'ci/passed': { name: ':green_heart: ci/passed', color: '#86f9b4' },\n\n      /* code */\n      'code/needs-review': {\n        name: ':ok_hand: code/needs-review',\n        color: '#FFD57F',\n      },\n      'code/review-requested': {\n        name: ':ok_hand: code/review-requested',\n        color: '#B2E1FF',\n      },\n      'code/changes-requested': {\n        name: ':ok_hand: code/changes-requested',\n        color: '#e11d21',\n      },\n      'code/approved': {\n        name: ':ok_hand: code/approved',\n        color: '#64DD17',\n      },\n\n      /* auto merge */\n      'merge/automerge': {\n        name: ':soon: automerge',\n        color: '#64DD17',\n      },\n      'merge/skip-ci': {\n        name: 'automerge/skip-ci',\n        color: '#e1e8ed',\n      },\n      'merge/update-branch': {\n        name: ':arrows_counterclockwise: update branch',\n        color: '#64DD17',\n      },\n\n      /* feature-branch */\n      'feature-branch': {\n        name: 'feature-branch',\n        color: '#7FCEFF',\n      },\n\n      /* infos */\n      'breaking-changes': {\n        name: ':warning: Breaking Changes',\n        color: '#ef7934',\n      },\n    },\n\n    review: {\n      ci: {\n        inProgress: 'ci/in-progress',\n        succeeded: 'ci/success',\n        failed: 'ci/fail',\n      },\n      dev: {\n        needsReview: 'code/needs-review',\n        requested: 'code/review-requested',\n        changesRequested: 'code/changes-requested',\n        approved: 'code/approved',\n      },\n    },\n  },\n};\n\nexport default config;\n","import type { Config } from './types';\n\nconst config: Config<never, never> = {\n  autoAssignToCreator: true,\n  trimTitle: true,\n  requiresReviewRequest: false,\n  prDefaultOptions: {\n    featureBranch: false,\n    autoMergeWithSkipCi: false,\n    autoMerge: false,\n    deleteAfterMerge: true,\n  },\n  parsePR: {\n    title: [],\n  },\n  groups: {},\n  waitForGroups: {},\n  teams: {},\n  labels: {\n    list: {\n      // /* ci */\n      // 'ci/in-progress': { name: ':green_heart: ci/in-progress', color: '#0052cc' },\n      // 'ci/fail': { name: ':green_heart: ci/fail', color: '#e11d21' },\n      // 'ci/passed': { name: ':green_heart: ci/passed', color: '#86f9b4' },\n\n      /* infos */\n      'breaking-changes': {\n        name: ':warning: Breaking Changes',\n        color: '#ef7934',\n      },\n    },\n\n    review: {\n      ci: {\n        inProgress: 'ci/in-progress',\n        succeeded: 'ci/success',\n        failed: 'ci/fail',\n      },\n    },\n  },\n};\n\nexport default config;\n","import type { Config } from './types';\n\nconst config: Config<'dev' | 'design', 'ops' | 'frontends' | 'backends'> = {\n  autoAssignToCreator: true,\n  trimTitle: true,\n  ignoreRepoPattern: '(infra-.*|devenv)',\n  requiresReviewRequest: true,\n  autoMergeRenovateWithSkipCi: false,\n  prDefaultOptions: {\n    featureBranch: false,\n    autoMergeWithSkipCi: false,\n    autoMerge: false,\n    deleteAfterMerge: true,\n  },\n  parsePR: {\n    title: [\n      {\n        regExp:\n          // eslint-disable-next-line unicorn/no-unsafe-regex\n          /^(revert: )?(build|chore|ci|docs|feat|fix|perf|refactor|style|test)(\\(([/a-z-]*)\\))?:\\s/,\n        error: {\n          title: 'Title does not match commitlint conventional',\n          summary:\n            'https://github.com/marionebl/commitlint/tree/master/%40commitlint/config-conventional',\n        },\n      },\n      {\n        bot: false,\n        regExp: /\\s([A-Z][\\dA-Z]+-(\\d+)|\\[no issue])$/,\n        error: {\n          title: 'Title does not have JIRA issue',\n          summary: 'The PR title should end with ONK-0000, or [no issue]',\n        },\n        status: 'jira-issue',\n        statusInfoFromMatch: (match) => {\n          const issue = match[1];\n          if (issue === '[no issue]') {\n            return {\n              title: 'No issue',\n              summary: '',\n            };\n          }\n          return {\n            inBody: true,\n            url: `https://ornikar.atlassian.net/browse/${issue}`,\n            title: `JIRA issue: ${issue}`,\n            summary: `[${issue}](https://ornikar.atlassian.net/browse/${issue})`,\n          };\n        },\n      },\n    ],\n  },\n\n  botUsers: ['michael-robot'],\n\n  groups: {\n    dev: {\n      /* ops */\n      JulienBreux: `julien.breux${process.env.ORNIKAR_EMAIL_DOMAIN}`,\n      TheR3aLp3nGuinJM: `jean-michel${process.env.ORNIKAR_EMAIL_DOMAIN}`,\n\n      /* back */\n      abarreir: `alexandre${process.env.ORNIKAR_EMAIL_DOMAIN}`,\n      damienorny: `damien.orny${process.env.ORNIKAR_EMAIL_DOMAIN}`,\n      'Thierry-girod': `thierry${process.env.ORNIKAR_EMAIL_DOMAIN}`,\n      darame07: `kevin${process.env.ORNIKAR_EMAIL_DOMAIN}`,\n      Pixy: `pierre-alexis${process.env.ORNIKAR_EMAIL_DOMAIN}`,\n      machartier: `marie-anne${process.env.ORNIKAR_EMAIL_DOMAIN}`,\n\n      /* front */\n      christophehurpeau: `christophe${process.env.ORNIKAR_EMAIL_DOMAIN}`,\n      HugoGarrido: `hugo${process.env.ORNIKAR_EMAIL_DOMAIN}`,\n      CorentinAndre: `corentin${process.env.ORNIKAR_EMAIL_DOMAIN}`,\n      Mxime: `maxime${process.env.ORNIKAR_EMAIL_DOMAIN}`,\n      vlbr: `valerian${process.env.ORNIKAR_EMAIL_DOMAIN}`,\n      'budet-b': `benjamin.budet${process.env.ORNIKAR_EMAIL_DOMAIN}`,\n      mdcarter: `maxime.dehaye${process.env.ORNIKAR_EMAIL_DOMAIN}`,\n      ChibiBlasphem: `christopher${process.env.ORNIKAR_EMAIL_DOMAIN}`,\n      PSniezak: `paul.sniezak${process.env.ORNIKAR_EMAIL_DOMAIN}`,\n    },\n    design: {\n      jperriere: `julien${process.env.ORNIKAR_EMAIL_DOMAIN}`,\n      CoralineColasse: `coraline${process.env.ORNIKAR_EMAIL_DOMAIN}`,\n      Lenamari: `lena${process.env.ORNIKAR_EMAIL_DOMAIN}`,\n      loicleser: null,\n    },\n  },\n\n  teams: {\n    ops: {\n      logins: ['JulienBreux', 'Alan-pad', 'CamilSadiki', 'busser'],\n      labels: ['teams/ops'],\n    },\n\n    backends: {\n      logins: [\n        'abarreir',\n        'arthurflachs',\n        'damienorny',\n        'Thierry-girod',\n        'darame07',\n        'Pixy',\n        'Radyum',\n      ],\n      labels: ['teams/backend'],\n    },\n\n    frontends: {\n      logins: [\n        'christophehurpeau',\n        'HugoGarrido',\n        'LentnerStefan',\n        'CorentinAndre',\n        'Mxime',\n        'vlbr',\n        'budet-b',\n        'mdcarter',\n        'ChibiBlasphem',\n        'PSniezak',\n      ],\n      labels: ['teams/frontend'],\n    },\n  },\n\n  waitForGroups: {\n    dev: [],\n    design: ['dev'],\n  },\n  labels: {\n    list: {\n      // /* ci */\n      // 'ci/in-progress': { name: ':green_heart: ci/in-progress', color: '#0052cc' },\n      // 'ci/fail': { name: ':green_heart: ci/fail', color: '#e11d21' },\n      // 'ci/passed': { name: ':green_heart: ci/passed', color: '#86f9b4' },\n\n      /* code */\n      'code/needs-review': {\n        name: ':ok_hand: code/needs-review',\n        color: '#FFC44C',\n      },\n      'code/review-requested': {\n        name: ':ok_hand: code/review-requested',\n        color: '#DAE1E6',\n      },\n      'code/changes-requested': {\n        name: ':ok_hand: code/changes-requested',\n        color: '#e11d21',\n      },\n      'code/approved': {\n        name: ':ok_hand: code/approved',\n        color: '#64DD17',\n      },\n\n      /* design */\n      'design/needs-review': {\n        name: ':art: design/needs-review',\n        color: '#FFC44C',\n      },\n      'design/review-requested': {\n        name: ':art: design/review-requested',\n        color: '#DAE1E6',\n      },\n      'design/changes-requested': {\n        name: ':art: design/changes-requested',\n        color: '#e11d21',\n      },\n      'design/approved': {\n        name: ':art: design/approved',\n        color: '#64DD17',\n      },\n\n      /* teams */\n      'teams/ops': {\n        name: 'ops',\n        color: '#003b55',\n      },\n      'teams/backend': {\n        name: 'backend',\n        color: '#6ad8cb',\n      },\n      'teams/frontend': {\n        name: 'frontend',\n        color: '#8a5abc',\n      },\n\n      /* auto merge */\n      'merge/automerge': {\n        name: ':soon: automerge',\n        color: '#64DD17',\n      },\n      'merge/skip-ci': {\n        name: 'automerge/skip-ci',\n        color: '#e1e8ed',\n      },\n      'merge/update-branch': {\n        name: ':arrows_counterclockwise: update branch',\n        color: '#e1e8ed',\n      },\n\n      /* feature-branch */\n      'feature-branch': {\n        name: 'feature-branch',\n        color: '#7FCEFF',\n      },\n\n      /* infos */\n      'breaking-changes': {\n        name: ':warning: Breaking Changes',\n        description: 'This issue or pull request will need a new major version',\n        color: '#FF6F00',\n      },\n      duplicate: {\n        name: 'duplicate',\n        description: 'This issue or pull request already exists',\n        color: '#ECEFF1',\n      },\n      documentation: {\n        name: 'documentation',\n        description: 'Improvements or additions to documentation',\n        color: '#7FCEFF',\n      },\n      rfc: {\n        name: 'RFC',\n        description: 'Request For Comments',\n        color: '#FFD3B2',\n      },\n      bug: {\n        name: 'bug',\n        description: \"Something isn't working\",\n        color: '#FF3D00',\n      },\n      enhancement: {\n        name: 'enhancement',\n        description: 'New feature or request',\n        color: '#7FCEFF',\n      },\n      'help-wanted': {\n        name: 'help wanted',\n        description: 'Extra attention is needed',\n        color: '#B1EE8B',\n      },\n      question: {\n        name: 'question',\n        description: 'Further information is requested',\n        color: '#F860A4',\n      },\n      wontfix: {\n        name: 'wontfix',\n        description: 'This will not be worked on',\n        color: '#ECEFF1',\n      },\n    },\n\n    review: {\n      ci: {\n        inProgress: 'ci/in-progress',\n        succeeded: 'ci/success',\n        failed: 'ci/fail',\n      },\n      dev: {\n        needsReview: 'code/needs-review',\n        requested: 'code/review-requested',\n        changesRequested: 'code/changes-requested',\n        approved: 'code/approved',\n      },\n      design: {\n        needsReview: 'design/needs-review',\n        requested: 'design/review-requested',\n        changesRequested: 'design/changes-requested',\n        approved: 'design/approved',\n      },\n    },\n  },\n};\n\nexport default config;\n","import chrisconfig from './christophehurpeau';\nimport type { Config } from './types';\n\nconst config: Config<'dev', never> = {\n  ...chrisconfig,\n  requiresReviewRequest: true,\n  groups: {\n    dev: {\n      christophehurpeau: 'christophe@hurpeau.com',\n      'chris-reviewflow': 'christophe.hurpeau+reviewflow@gmail.com',\n    },\n  },\n};\nexport default config;\n","import christophehurpeau from './christophehurpeau';\nimport defaultConfig from './defaultConfig';\nimport ornikar from './ornikar';\nimport reviewflow from './reviewflow';\nimport type { Config as ConfigType } from './types';\n\nexport type Config<\n  GroupNames extends string = any,\n  TeamNames extends string = any\n> = ConfigType<GroupNames, TeamNames>;\n\nexport const accountConfigs: { [owner: string]: Config } = {\n  ornikar,\n  christophehurpeau,\n  reviewflow,\n};\n\nexport { defaultConfig };\n\n// flat requires node 11\n// export const getMembers = <GroupNames extends string = any>(\n//   groups: Record<GroupNames, Group>,\n// ): string[] => {\n//   return Object.values(groups).flat(1);\n// };\n","import type { MessageCategory } from './MessageCategory';\n\nexport const defaultDmSettings: Record<MessageCategory, boolean> = {\n  'pr-review': true,\n  'pr-review-follow': true,\n  'pr-comment': true,\n  'pr-comment-bots': true,\n  'pr-comment-follow': true,\n  'pr-comment-follow-bots': false,\n  'pr-comment-mention': true,\n  'pr-comment-thread': true,\n  'pr-merge-conflicts': true,\n  'issue-comment-mention': true,\n};\n","import { accountConfigs, defaultConfig } from '../accountConfigs';\nimport type { MongoStores } from '../mongo';\nimport type { MessageCategory } from './MessageCategory';\nimport { defaultDmSettings } from './defaultDmSettings';\n\nexport type UserDmSettings = Record<MessageCategory, boolean>;\nconst cache = new Map<string, Map<number, UserDmSettings>>();\n\nconst getDefaultDmSettings = (org: string): UserDmSettings => {\n  const accountConfig = accountConfigs[org] || defaultConfig;\n  return accountConfig.defaultDmSettings\n    ? { ...defaultDmSettings, ...accountConfig.defaultDmSettings }\n    : defaultDmSettings;\n};\n\nexport const updateCache = (\n  org: string,\n  userId: number,\n  newSettings: Partial<UserDmSettings>,\n): void => {\n  let orgCache = cache.get(org);\n  if (!orgCache) {\n    orgCache = new Map();\n    cache.set(org, orgCache);\n  }\n  orgCache.set(userId, { ...getDefaultDmSettings(org), ...newSettings });\n};\n\nexport const getUserDmSettings = async (\n  mongoStores: MongoStores,\n  org: string,\n  orgId: number,\n  userId: number,\n): Promise<UserDmSettings> => {\n  const orgDefaultDmSettings = getDefaultDmSettings(org);\n\n  const userDmSettingsConfig = await mongoStores.userDmSettings.findOne({\n    orgId,\n    userId,\n  });\n\n  const config = userDmSettingsConfig\n    ? {\n        ...orgDefaultDmSettings,\n        ...userDmSettingsConfig.settings,\n      }\n    : orgDefaultDmSettings;\n\n  updateCache(org, userId, config);\n  return config;\n};\n","import type { Octokit } from '@octokit/core';\nimport type { RestEndpointMethodTypes } from '@octokit/plugin-rest-endpoint-methods';\nimport type { MongoStores, Org } from '../../../mongo';\n\ninterface OrgInfo {\n  login: string;\n  id: number;\n}\n\nexport const syncOrg = async (\n  mongoStores: MongoStores,\n  github: Octokit,\n  installationId: number,\n  org: OrgInfo,\n): Promise<Org> => {\n  const orgInStore = await mongoStores.orgs.upsertOne({\n    _id: org.id as any, // TODO _id is number\n    login: org.login,\n    installationId,\n  });\n\n  const orgEmbed = { id: org.id, login: org.login };\n\n  const memberIds: number[] = [];\n\n  await Promise.all(\n    await github.paginate(\n      github.orgs.listMembers.endpoint.merge({\n        org: org.login,\n      }),\n      ({\n        data,\n      }: RestEndpointMethodTypes['orgs']['listMembers']['response']) => {\n        return Promise.all(\n          data.map(async (member) => {\n            memberIds.push(member.id);\n            return Promise.all([\n              mongoStores.orgMembers.upsertOne({\n                _id: `${org.id}_${member.id}`,\n                org: orgEmbed,\n                user: {\n                  id: member.id,\n                  login: member.login,\n                },\n              }),\n              mongoStores.users.upsertOne({\n                _id: member.id as any,\n                login: member.login,\n                type: member.type,\n              }),\n            ]);\n          }),\n        );\n      },\n    ),\n  );\n\n  await mongoStores.orgMembers.deleteMany({\n    'org.id': org.id,\n    'user.id': { $not: { $in: memberIds } },\n  });\n\n  return orgInStore;\n};\n","import type { Octokit } from '@octokit/core';\nimport type { RestEndpointMethodTypes } from '@octokit/plugin-rest-endpoint-methods';\nimport type { MongoStores } from '../../../mongo';\n\nexport const syncTeams = async (\n  mongoStores: MongoStores,\n  github: Octokit,\n  org: { login: string; id: number },\n): Promise<void> => {\n  const orgEmbed = { id: org.id, login: org.login };\n\n  const teamIds: number[] = [];\n\n  await Promise.all(\n    await github.paginate(\n      github.teams.list.endpoint.merge({\n        org: org.login,\n      }),\n      ({ data }: RestEndpointMethodTypes['teams']['list']['response']) => {\n        return Promise.all(\n          data.map((team) => {\n            teamIds.push(team.id);\n            return mongoStores.orgTeams.upsertOne({\n              _id: team.id,\n              org: orgEmbed,\n              name: team.name,\n              slug: team.slug,\n              description: team.description,\n            });\n          }),\n        );\n      },\n    ),\n  );\n\n  await mongoStores.orgTeams.deleteMany({\n    'org.id': org.id,\n    _id: { $not: { $in: teamIds } },\n  });\n};\n","import bodyParser from 'body-parser';\nimport type { Router } from 'express';\nimport type { ProbotOctokit } from 'probot';\nimport React from 'react';\nimport { renderToStaticMarkup } from 'react-dom/server';\nimport { accountConfigs } from '../accountConfigs';\nimport type { MessageCategory } from '../dm/MessageCategory';\nimport { getUserDmSettings, updateCache } from '../dm/getUserDmSettings';\nimport { syncOrg } from '../events/account-handlers/actions/syncOrg';\nimport { syncTeams } from '../events/account-handlers/actions/syncTeams';\nimport type { MongoStores } from '../mongo';\nimport Layout from '../views/Layout';\nimport { getUser } from './auth';\n\nconst dmMessages: Record<MessageCategory, string> = {\n  'pr-review': 'You are assigned to a review, someone reviewed your PR',\n  'pr-review-follow': \"Someone reviewed a PR you're also reviewing\",\n  'pr-comment': 'Someone commented on your PR',\n  'pr-comment-bots': 'A bot commented on your PR',\n  'pr-comment-follow': \"Someone commented on a PR you're reviewing\",\n  'pr-comment-follow-bots': \"A bot commented on a PR you're reviewing\",\n  'pr-comment-mention': 'Someone mentioned you in a PR',\n  'pr-comment-thread': \"Someone replied to a discussion you're in\",\n  'pr-merge-conflicts': 'Your PR has a merge conflict (not implemented)',\n  'issue-comment-mention':\n    'Someone mentioned you in an issue (not implemented)',\n};\n\nexport default function orgSettings(\n  router: Router,\n  octokitApp: InstanceType<typeof ProbotOctokit>,\n  mongoStores: MongoStores,\n): void {\n  router.get('/org/:org/force-sync', async (req, res) => {\n    const user = await getUser(req, res, octokitApp);\n    if (!user) return;\n\n    const orgs = await user.api.orgs.listForAuthenticatedUser();\n    const org = orgs.data.find((o) => o.login === req.params.org);\n    if (!org) return res.redirect('/app');\n\n    const o = await mongoStores.orgs.findByKey(org.id);\n    if (!o) return res.redirect('/app');\n\n    await syncOrg(mongoStores, user.api, o.installationId as number, org);\n    await syncTeams(mongoStores, user.api, org);\n\n    res.redirect(`/app/org/${req.params.org}`);\n  });\n\n  router.get('/org/:org', async (req, res) => {\n    const user = await getUser(req, res, octokitApp);\n    if (!user) return;\n\n    const orgs = await user.api.orgs.listForAuthenticatedUser();\n    const org = orgs.data.find((o) => o.login === req.params.org);\n    if (!org) return res.redirect('/app');\n\n    const installation = await octokitApp.apps\n      .getOrgInstallation({ org: org.login })\n      .catch((err) => {\n        return { status: err.status, data: undefined };\n      });\n\n    if (!installation) {\n      return res.send(\n        renderToStaticMarkup(\n          <Layout>\n            <div>\n              {process.env.REVIEWFLOW_NAME}{' '}\n              {\"isn't installed for this user. Go to \"}\n              <a\n                href={`https://github.com/settings/apps/${process.env.REVIEWFLOW_NAME}/installations/new`}\n              >\n                Github Configuration\n              </a>{' '}\n              to install it.\n            </div>\n          </Layout>,\n        ),\n      );\n    }\n\n    const accountConfig = accountConfigs[org.login];\n    const userDmSettings = await getUserDmSettings(\n      mongoStores,\n      org.login,\n      org.id,\n      user.authInfo.id,\n    );\n\n    res.send(\n      renderToStaticMarkup(\n        <Layout>\n          <div>\n            <h1>{process.env.REVIEWFLOW_NAME}</h1>\n            <div style={{ display: 'flex' }}>\n              <h2 style={{ flexGrow: 1 }}>{org.login}</h2>\n              <a href=\"/app\">Switch account</a>\n            </div>\n\n            <div style={{ display: 'flex' }}>\n              <div style={{ flexGrow: 1 }}>\n                <h4>Information</h4>\n                {!accountConfig\n                  ? 'Default config is used: https://github.com/christophehurpeau/reviewflow/blob/master/src/accountConfigs/defaultConfig.ts'\n                  : `Custom config: https://github.com/christophehurpeau/reviewflow/blob/master/src/accountConfigs/${org.login}.ts`}\n              </div>\n              <div style={{ width: '380px' }}>\n                <h4>My DM Settings</h4>\n                {Object.entries(dmMessages).map(([key, name]) => (\n                  <div key={key}>\n                    <label htmlFor={key}>\n                      <span\n                        // eslint-disable-next-line react/no-danger\n                        dangerouslySetInnerHTML={{\n                          __html: `<input id=\"${key}\" type=\"checkbox\" autocomplete=\"off\" ${\n                            userDmSettings[key as MessageCategory]\n                              ? 'checked=\"checked\" '\n                              : ''\n                          }onclick=\"fetch(location.pathname, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ key: '${key}', value: event.currentTarget.checked }) })\" />`,\n                        }}\n                      />\n                      {name}\n                    </label>\n                  </div>\n                ))}\n              </div>\n            </div>\n          </div>\n        </Layout>,\n      ),\n    );\n  });\n\n  router.patch('/org/:org', bodyParser.json(), async (req, res) => {\n    if (!req.body) {\n      res.status(400).send('not ok');\n      return;\n    }\n\n    const user = await getUser(req, res, octokitApp);\n    if (!user) return;\n\n    const orgs = await user.api.orgs.listForAuthenticatedUser();\n    const org = orgs.data.find((o) => o.login === req.params.org);\n    if (!org) return res.redirect('/app');\n\n    (await mongoStores.userDmSettings.collection).updateOne(\n      {\n        _id: `${org.id}_${user.authInfo.id}`,\n      },\n      {\n        $set: {\n          [`settings.${req.body.key}`]: req.body.value,\n          updated: new Date(),\n        },\n        $setOnInsert: {\n          orgId: org.id,\n          userId: user.authInfo.id,\n          created: new Date(),\n        },\n      },\n      { upsert: true },\n    );\n\n    const userDmSettingsConfig = await mongoStores.userDmSettings.findOne({\n      orgId: org.id,\n      userId: user.authInfo.id,\n    });\n\n    if (userDmSettingsConfig) {\n      updateCache(org.login, user.authInfo.id, userDmSettingsConfig.settings);\n    }\n\n    res.send('ok');\n  });\n}\n","import type { Router } from 'express';\nimport type { ProbotOctokit } from 'probot';\nimport React from 'react';\nimport { renderToStaticMarkup } from 'react-dom/server';\nimport Layout from '../views/Layout';\nimport { getUser } from './auth';\n\nexport default function repository(\n  router: Router,\n  octokitApp: InstanceType<typeof ProbotOctokit>,\n): void {\n  router.get('/repositories', async (req, res) => {\n    const user = await getUser(req, res, octokitApp);\n    if (!user) return;\n    const { data } = await user.api.repos.list({ per_page: 100 });\n\n    res.send(\n      renderToStaticMarkup(\n        <Layout>\n          <div>\n            <h4>Your repositories</h4>\n            <ul>\n              {data.map((repo: any) => (\n                <li key={repo.id}>\n                  <a href={`/app/repository/${repo.owner.login}/${repo.name}`}>\n                    {repo.name}\n                  </a>\n                </li>\n              ))}\n            </ul>\n\n            {data.length === 100 && (\n              <div>We currently have a limit to 100 repositories</div>\n            )}\n          </div>\n        </Layout>,\n      ),\n    );\n  });\n\n  router.get('/repository/:owner/:repository', async (req, res) => {\n    const user = await getUser(req, res, octokitApp);\n    if (!user) return;\n    const { data } = await user.api.repos.get({\n      owner: req.params.owner,\n      repo: req.params.repository,\n    });\n\n    if (!data) {\n      res.status(404).send(\n        renderToStaticMarkup(\n          <Layout>\n            <div>repo not found</div>\n          </Layout>,\n        ),\n      );\n      return;\n    }\n\n    if (!data.permissions.admin) {\n      res.status(401).send(\n        renderToStaticMarkup(\n          <Layout>\n            <div>\n              not authorized to see this repo, you need to have admin permission\n            </div>\n          </Layout>,\n        ),\n      );\n      return;\n    }\n\n    const { data: data2 } = await octokitApp.apps\n      .getRepoInstallation({\n        owner: req.params.owner,\n        repo: req.params.repository,\n      })\n      .catch((err) => {\n        return { status: err.status, data: undefined };\n      });\n\n    if (!data2) {\n      res.send(\n        renderToStaticMarkup(\n          <Layout>\n            <div>\n              {process.env.REVIEWFLOW_NAME}{' '}\n              {\"isn't installed on this repo. Go to \"}\n              <a\n                href={`https://github.com/apps/${process.env.REVIEWFLOW_NAME}/installations/new`}\n              >\n                Github Configuration\n              </a>{' '}\n              to add it.\n            </div>\n          </Layout>,\n        ),\n      );\n      return;\n    }\n\n    res.send(\n      renderToStaticMarkup(\n        <Layout>\n          <div>\n            <h4>{req.params.repository}</h4>\n          </div>\n        </Layout>,\n      ),\n    );\n  });\n}\n","import type { Octokit } from '@octokit/core';\nimport type { MongoStores, User } from '../../../mongo';\n\ninterface UserInfo {\n  login: string;\n  id: number;\n}\n\nexport const syncUser = async (\n  mongoStores: MongoStores,\n  github: Octokit,\n  installationId: number,\n  userInfo: UserInfo,\n): Promise<User> => {\n  const user = await mongoStores.users.upsertOne({\n    _id: userInfo.id,\n    login: userInfo.login,\n    type: 'User',\n    installationId,\n  });\n\n  return user;\n};\n","import type { Router } from 'express';\nimport type { ProbotOctokit } from 'probot';\nimport React from 'react';\nimport { renderToStaticMarkup } from 'react-dom/server';\nimport { syncUser } from '../events/account-handlers/actions/syncUser';\nimport type { MongoStores } from '../mongo';\nimport Layout from '../views/Layout';\nimport { getUser } from './auth';\n\nexport default function userSettings(\n  router: Router,\n  octokitApp: InstanceType<typeof ProbotOctokit>,\n  mongoStores: MongoStores,\n): void {\n  router.get('/user/force-sync', async (req, res) => {\n    const user = await getUser(req, res, octokitApp);\n    if (!user) return;\n\n    // const { data: installation } = await api.apps\n    //   .getUserInstallation({\n    //     username: user.authInfo.login,\n    //   })\n    //   .catch((err) => {\n    //     return { status: err.status, data: undefined };\n    //   });\n\n    // console.log(installation);\n\n    const u = await mongoStores.users.findByKey(user.authInfo.id);\n    if (!u || !u.installationId) return res.redirect('/app');\n\n    await syncUser(\n      mongoStores,\n      user.api,\n      u.installationId as number,\n      user.authInfo,\n    );\n\n    res.redirect('/app/user');\n  });\n\n  router.get('/user', async (req, res) => {\n    const user = await getUser(req, res, octokitApp);\n    if (!user) return;\n\n    const { data: installation } = await octokitApp.apps\n      .getUserInstallation({\n        username: user.authInfo.login,\n      })\n      .catch((err) => {\n        return { status: err.status, data: undefined };\n      });\n\n    if (!installation) {\n      return res.send(\n        renderToStaticMarkup(\n          <Layout>\n            <div>\n              {process.env.REVIEWFLOW_NAME}{' '}\n              {\"isn't installed for this user. Go to \"}\n              <a\n                href={`https://github.com/settings/apps/${process.env.REVIEWFLOW_NAME}/installations/new`}\n              >\n                Github Configuration\n              </a>{' '}\n              to install it.\n            </div>\n          </Layout>,\n        ),\n      );\n    }\n\n    return res.send(\n      renderToStaticMarkup(\n        <Layout>\n          <div>{process.env.REVIEWFLOW_NAME} is installed for this user</div>\n        </Layout>,\n      ),\n    );\n  });\n}\n","import cookieParser from 'cookie-parser';\nimport type { Probot, run } from 'probot';\nimport auth from './app/auth';\nimport home from './app/home';\nimport orgSettings from './app/org-settings';\nimport repository from './app/repository';\nimport userSettings from './app/user-settings';\nimport type { AppContext } from './context/AppContext';\n\nexport default async function appRouter(\n  app: Probot,\n  getRouter: Parameters<\n    // eslint-disable-next-line @typescript-eslint/ban-types\n    Extract<Parameters<typeof run>[0], Function>\n  >[0]['getRouter'],\n  { mongoStores }: AppContext,\n): Promise<void> {\n  const router = getRouter('/app');\n  const octokitApp = await app.auth();\n\n  router.use(cookieParser());\n\n  auth(router, octokitApp);\n  repository(router, octokitApp);\n  home(router, octokitApp, mongoStores);\n  orgSettings(router, octokitApp, mongoStores);\n  userSettings(router, octokitApp, mongoStores);\n}\n","export const ExcludesFalsy = (Boolean as any) as <T>(\n  x: T | false | null | undefined,\n) => x is T;\n\nexport const ExcludesNullish = (((res: any) => res !== null) as any) as <T>(\n  x: T | null,\n) => x is T;\n","import type { Octokit } from '@octokit/core';\nimport { syncOrg } from '../events/account-handlers/actions/syncOrg';\nimport { syncTeams } from '../events/account-handlers/actions/syncTeams';\nimport { syncUser } from '../events/account-handlers/actions/syncUser';\nimport type { Org, User } from '../mongo';\nimport type { AppContext } from './AppContext';\n\nexport interface AccountInfo {\n  id: number;\n  login: string;\n  type: string;\n}\n\nexport const getOrCreateAccount = async (\n  { mongoStores }: AppContext,\n  github: Octokit,\n  installationId: number,\n  accountInfo: AccountInfo,\n): Promise<Org | User> => {\n  switch (accountInfo.type) {\n    case 'Organization': {\n      let org = await mongoStores.orgs.findByKey(accountInfo.id);\n      if (org?.installationId) return org;\n\n      // TODO diff org vs user...\n      org = await syncOrg(mongoStores, github, installationId, accountInfo);\n      await syncTeams(mongoStores, github, accountInfo);\n      return org;\n    }\n\n    case 'User': {\n      let user = await mongoStores.users.findByKey(accountInfo.id);\n      if (user?.installationId) return user;\n\n      user = await syncUser(mongoStores, github, installationId, accountInfo);\n      return user;\n    }\n\n    default:\n      throw new Error(`Account type not supported ${accountInfo.type}`);\n  }\n};\n","import createEmojiRegex from 'emoji-regex';\n\nexport const getKeys = <T extends Record<keyof T, unknown>>(\n  o: T,\n): (keyof T)[] => Object.keys(o) as (keyof T)[];\n\nconst emojiRegex = createEmojiRegex();\n\nexport const getEmojiFromRepoDescription = (\n  description: string | null,\n): string => {\n  if (!description) return '';\n  if (description.startsWith(':')) {\n    const [, emoji] = /^(:\\w+:)/.exec(description) || [];\n    return emoji || '';\n  }\n  const match = emojiRegex.exec(description);\n  if (match && description.startsWith(match[0])) return match[0];\n  return '';\n};\n","import type { TeamSlack } from './TeamSlack';\n\nexport const voidTeamSlack = (): TeamSlack => ({\n  mention: (): string => '',\n  postMessage: (): Promise<null> => Promise.resolve(null),\n  updateMessage: (): Promise<null> => Promise.resolve(null),\n  deleteMessage: (): Promise<undefined> => Promise.resolve(undefined),\n  addReaction: (): Promise<undefined> => Promise.resolve(undefined),\n  updateHome: (): void => undefined,\n});\n","import { WebClient } from '@slack/web-api';\nimport type { Context } from 'probot';\nimport type { Config } from '../accountConfigs';\nimport type { MessageCategory } from '../dm/MessageCategory';\nimport { getUserDmSettings } from '../dm/getUserDmSettings';\nimport type { Org, User } from '../mongo';\nimport type { AppContext } from './AppContext';\nimport type { SlackMessage } from './SlackMessage';\nimport type { TeamSlack, PostSlackMessageResult } from './TeamSlack';\nimport { getKeys } from './utils';\nimport { voidTeamSlack } from './voidTeamSlack';\n\nexport type { TeamSlack };\n\nexport const initTeamSlack = async <GroupNames extends string>(\n  { mongoStores, slackHome }: AppContext,\n  context: Context<any>,\n  config: Config<GroupNames>,\n  account: Org | User,\n): Promise<TeamSlack> => {\n  const owner = context.payload.repository.owner;\n  const slackToken = 'slackToken' in account && account.slackToken;\n\n  if (!slackToken) {\n    return voidTeamSlack();\n  }\n\n  const githubLoginToSlackEmail = getKeys(config.groups).reduce<{\n    [login: string]: string;\n  }>((acc, groupName) => {\n    Object.assign(acc, config.groups[groupName]);\n    return acc;\n  }, {});\n\n  const slackEmails = Object.values(githubLoginToSlackEmail);\n  const slackClient = new WebClient(slackToken);\n\n  const membersInDb = await mongoStores.orgMembers.findAll({\n    'org.id': account._id,\n  });\n\n  const members: [string, { member: any; im: any }][] = [];\n  const foundEmailMembers: string[] = [];\n\n  Object.entries(githubLoginToSlackEmail).forEach(([login, email]) => {\n    const member = membersInDb.find((m) => m.user.login === login);\n    if (member?.slack?.id) {\n      foundEmailMembers.push(email);\n      members.push([email, { member: { id: member.slack.id }, im: undefined }]);\n    }\n  });\n\n  if (foundEmailMembers.length !== slackEmails.length) {\n    const missingEmails = slackEmails.filter(\n      (email) => !foundEmailMembers.includes(email),\n    );\n\n    const memberEmailToMemberId = new Map<string, number>(\n      Object.entries(githubLoginToSlackEmail).map(([login, email]) => [\n        email,\n        membersInDb.find((m) => m.user.login === login)?._id as any,\n      ]),\n    );\n\n    await slackClient.paginate('users.list', {}, (page: any) => {\n      page.members.forEach((member: any) => {\n        const email = member.profile?.email;\n        if (email && missingEmails.includes(email)) {\n          members.push([email, { member, im: undefined }]);\n          if (memberEmailToMemberId.has(email)) {\n            mongoStores.orgMembers.partialUpdateMany(\n              {\n                _id: memberEmailToMemberId.get(email),\n              },\n              { $set: { slack: { id: member.id } } },\n            );\n          }\n        }\n      });\n      return false;\n    });\n  }\n\n  for (const [, user] of members) {\n    try {\n      const im: any = await slackClient.conversations.open({\n        users: user.member.id,\n      });\n      user.im = im.channel;\n    } catch (err) {\n      console.error(err);\n    }\n  }\n\n  const membersMap = new Map(members);\n\n  const getUserFromGithubLogin = (githubLogin: string) => {\n    const email = githubLoginToSlackEmail[githubLogin];\n    if (!email) return null;\n    return membersMap.get(email);\n  };\n\n  return {\n    mention: (githubLogin: string): string => {\n      const user = getUserFromGithubLogin(githubLogin);\n      if (!user) return githubLogin;\n      return `<@${user.member.id}>`;\n    },\n    postMessage: async (\n      category: MessageCategory,\n      githubId: number,\n      githubLogin: string,\n      message: SlackMessage,\n    ): Promise<PostSlackMessageResult> => {\n      context.log.debug('slack: post message', {\n        category,\n        githubLogin,\n        message,\n      });\n      if (process.env.DRY_RUN && process.env.DRY_RUN !== 'false') return null;\n\n      const userDmSettings = await getUserDmSettings(\n        mongoStores,\n        owner.login,\n        owner.id,\n        githubId,\n      );\n\n      if (!userDmSettings[category]) return null;\n\n      const user = getUserFromGithubLogin(githubLogin);\n      if (!user || !user.im) return null;\n      const result = await slackClient.chat.postMessage({\n        username: process.env.REVIEWFLOW_NAME,\n        channel: user.im.id,\n        text: message.text,\n        blocks: message.blocks,\n        attachments: message.secondaryBlocks\n          ? [{ blocks: message.secondaryBlocks }]\n          : undefined,\n        thread_ts: message.ts,\n      });\n      if (!result.ok) return null;\n      return { ts: result.ts as string, channel: result.channel as string };\n    },\n    updateMessage: async (\n      ts: string,\n      channel: string,\n      message: SlackMessage,\n    ): Promise<PostSlackMessageResult> => {\n      context.log.debug('slack: update message', { ts, channel, message });\n      if (process.env.DRY_RUN && process.env.DRY_RUN !== 'false') return null;\n\n      const result = await slackClient.chat.update({\n        ts,\n        channel,\n        text: message.text,\n        blocks: message.blocks,\n        attachments: message.secondaryBlocks\n          ? [{ blocks: message.secondaryBlocks }]\n          : undefined,\n      });\n      if (!result.ok) return null;\n      return { ts: result.ts as string, channel: result.channel as string };\n    },\n    deleteMessage: async (ts: string, channel: string): Promise<void> => {\n      context.log.debug('slack: delete message', { ts, channel });\n      await slackClient.chat.delete({\n        ts,\n        channel,\n      });\n    },\n    addReaction: async (\n      ts: string,\n      channel: string,\n      name: string,\n    ): Promise<void> => {\n      context.log.debug('slack: add reaction', { ts, channel, name });\n      await slackClient.reactions.add({\n        timestamp: ts,\n        channel,\n        name,\n      });\n    },\n\n    updateHome: (githubLogin: string): void => {\n      context.log.debug('update slack home', { githubLogin });\n      const user = getUserFromGithubLogin(githubLogin);\n      if (!user || !user.member) return;\n\n      slackHome.scheduleUpdateMember(context.github, slackClient, {\n        user: { id: null, login: githubLogin },\n        org: { id: account._id, login: account.login },\n        slack: { id: user.member.id },\n      } as any);\n    },\n  };\n};\n","import { Lock } from 'lock';\nimport type { Context } from 'probot';\nimport type { Config } from '../accountConfigs';\nimport type { Org, User, AccountEmbed, AccountType } from '../mongo';\nimport { ExcludesFalsy } from '../utils/Excludes';\nimport type { AppContext } from './AppContext';\nimport type { AccountInfo } from './getOrCreateAccount';\nimport { getOrCreateAccount } from './getOrCreateAccount';\nimport type { TeamSlack } from './initTeamSlack';\nimport { initTeamSlack } from './initTeamSlack';\nimport { getKeys } from './utils';\n\nexport interface AccountContext<\n  GroupNames extends string = any,\n  TeamNames extends string = any\n> {\n  config: Config<GroupNames, TeamNames>;\n  accountType: AccountType;\n  account: Org | User;\n  accountEmbed: AccountEmbed;\n  slack: TeamSlack;\n  getReviewerGroup: (githubLogin: string) => GroupNames | undefined;\n  getReviewerGroups: (githubLogins: string[]) => GroupNames[];\n  getTeamsForLogin: (githubLogin: string) => TeamNames[];\n  approveShouldWait: (\n    reviewerGroup: GroupNames | undefined,\n    requestedReviewers: any[],\n    {\n      includesReviewerGroup,\n      includesWaitForGroups,\n    }: { includesReviewerGroup?: boolean; includesWaitForGroups?: boolean },\n  ) => boolean;\n\n  lock: (callback: () => Promise<void> | void) => Promise<void>;\n}\n\nconst initAccountContext = async (\n  appContext: AppContext,\n  context: Context<any>,\n  config: Config,\n  accountInfo: AccountInfo,\n): Promise<AccountContext> => {\n  const account = await getOrCreateAccount(\n    appContext,\n    context.github,\n    context.payload.installation.id,\n    accountInfo,\n  );\n  const slackPromise = initTeamSlack(appContext, context, config, account);\n\n  const githubLoginToGroup = new Map<string, string>();\n  getKeys(config.groups).forEach((groupName) => {\n    Object.keys(config.groups[groupName]).forEach((login) => {\n      githubLoginToGroup.set(login, groupName);\n    });\n  });\n\n  const githubLoginToTeams = new Map<string, string[]>();\n  getKeys(config.teams || {}).forEach((teamName) => {\n    (config.teams as NonNullable<typeof config.teams>)[teamName].logins.forEach(\n      (login) => {\n        const teams = githubLoginToTeams.get(login);\n        if (teams) {\n          teams.push(teamName);\n        } else {\n          githubLoginToTeams.set(login, [teamName]);\n        }\n      },\n    );\n  });\n\n  const getReviewerGroups = (githubLogins: string[]): string[] => [\n    ...new Set(\n      githubLogins\n        .map((githubLogin) => githubLoginToGroup.get(githubLogin))\n        .filter(ExcludesFalsy),\n    ),\n  ];\n\n  const lock = Lock();\n\n  return {\n    config,\n    account,\n    accountEmbed: {\n      id: accountInfo.id,\n      login: accountInfo.login,\n      type: accountInfo.type as AccountType,\n    },\n    accountType: accountInfo.type as AccountType,\n    lock: (callback: () => Promise<void> | void): Promise<void> => {\n      return new Promise((resolve, reject) => {\n        const logInfos = { account: accountInfo.login };\n        context.log.info('lock: try to lock account', logInfos);\n        // eslint-disable-next-line @typescript-eslint/no-misused-promises\n        lock('_', async (createReleaseCallback) => {\n          const release = createReleaseCallback(() => {});\n          context.log.info('lock: lock account acquired', logInfos);\n          try {\n            await callback();\n          } catch (err) {\n            context.log.info('lock: release account (with error)', logInfos);\n            release();\n            reject(err);\n            return;\n          }\n          context.log.info('lock: release account', logInfos);\n          release();\n          resolve();\n        });\n      });\n    },\n    getReviewerGroup: (githubLogin): string | undefined =>\n      githubLoginToGroup.get(githubLogin),\n    getReviewerGroups,\n\n    getTeamsForLogin: (githubLogin): string[] =>\n      githubLoginToTeams.get(githubLogin) || [],\n\n    approveShouldWait: (\n      reviewerGroup,\n      requestedReviewers,\n      { includesReviewerGroup, includesWaitForGroups },\n    ): boolean => {\n      if (!reviewerGroup) return false;\n\n      const requestedReviewerGroups = getReviewerGroups(\n        requestedReviewers.map((request) => request.login),\n      );\n\n      // contains another request of a reviewer in the same group\n      if (\n        includesReviewerGroup &&\n        requestedReviewerGroups.includes(reviewerGroup)\n      ) {\n        return true;\n      }\n\n      // contains a request from a dependent group\n      if (config.waitForGroups && includesWaitForGroups) {\n        const waitForGroups = config.waitForGroups;\n        return requestedReviewerGroups.some((group) =>\n          waitForGroups[reviewerGroup].includes(group),\n        );\n      }\n\n      return false;\n    },\n\n    slack: await slackPromise,\n  };\n};\n\nconst accountContextsPromise = new Map();\nconst accountContexts = new Map();\n\nexport const obtainAccountContext = (\n  appContext: AppContext,\n  context: Context<any>,\n  config: Config,\n  accountInfo: AccountInfo,\n): Promise<AccountContext> => {\n  const existingAccountContext = accountContexts.get(accountInfo.login);\n  if (existingAccountContext) return existingAccountContext;\n\n  const existingPromise = accountContextsPromise.get(accountInfo.login);\n  if (existingPromise) return Promise.resolve(existingPromise);\n\n  const promise = initAccountContext(appContext, context, config, accountInfo);\n  accountContextsPromise.set(accountInfo.login, promise);\n\n  return promise.then((accountContext) => {\n    accountContextsPromise.delete(accountInfo.login);\n    accountContexts.set(accountInfo.login, accountContext);\n    return accountContext;\n  });\n};\n","import type { Context } from 'probot';\nimport { accountConfigs, defaultConfig } from '../../../accountConfigs';\nimport type { AppContext } from '../../../context/AppContext';\nimport type { AccountContext } from '../../../context/accountContext';\nimport { obtainAccountContext } from '../../../context/accountContext';\n\ntype CallbackContextAndAccountContext<T> = (\n  context: Context<T>,\n  accountContext: AccountContext,\n) => void | Promise<void>;\n\nexport const handlerOrgChange = async <\n  T extends { organization?: { id: number; login: string } }\n>(\n  appContext: AppContext,\n  context: Context<T>,\n  callback: CallbackContextAndAccountContext<T>,\n): Promise<void> => {\n  const org = context.payload.organization;\n  if (!org) return;\n  const config = accountConfigs[org.login] || defaultConfig;\n  const accountContext = await obtainAccountContext(\n    appContext,\n    context,\n    config,\n    { ...org, type: 'Organization' },\n  );\n  if (!accountContext) return;\n\n  return accountContext.lock(async () => {\n    await callback(context, accountContext);\n  });\n};\n\nexport const createHandlerOrgChange = <\n  T extends { organization?: { id: number; login: string } }\n>(\n  appContext: AppContext,\n  callback: CallbackContextAndAccountContext<T>,\n) => (context: Context<T>) => {\n  return handlerOrgChange(appContext, context, callback);\n};\n","export type OptionsKeys =\n  | 'featureBranch'\n  | 'autoMergeWithSkipCi'\n  | 'autoMerge'\n  | 'deleteAfterMerge';\n\nexport type Options = Record<OptionsKeys, boolean>;\n\nexport const options: OptionsKeys[] = [\n  'featureBranch',\n  'autoMergeWithSkipCi',\n  'autoMerge',\n  'deleteAfterMerge',\n];\nexport const optionsRegexps: {\n  key: OptionsKeys;\n  regexp: RegExp;\n}[] = options.map((option) => ({\n  key: option,\n  regexp: new RegExp(`\\\\[([ xX]?)]\\\\s*<!-- reviewflow-${option} -->`),\n}));\n\nexport const optionsLabels: { key: OptionsKeys; label: string }[] = [\n  { key: 'featureBranch', label: 'This PR is a feature branch' },\n  {\n    key: 'autoMergeWithSkipCi',\n    label: 'Add `[skip ci]` on merge commit',\n  },\n  {\n    key: 'autoMerge',\n    label:\n      'Auto merge when this PR is ready and has no failed statuses. (Also has a queue per repo to prevent multiple useless \"Update branch\" triggers)',\n  },\n  {\n    key: 'deleteAfterMerge',\n    label: 'Automatic branch delete after this PR is merged',\n  },\n];\n","import { optionsRegexps } from './prOptions';\nimport type { Options } from './prOptions';\n\nexport type { Options } from './prOptions';\n\nexport const parseOptions = (\n  content: string,\n  defaultOptions: Options,\n): Options => {\n  return optionsRegexps.reduce<any>((acc, { key, regexp }) => {\n    const match = regexp.exec(content);\n    acc[key] = !match\n      ? defaultOptions[key] || false\n      : match[1] === 'x' || match[1] === 'X';\n    return acc;\n  }, {}) as Options;\n};\n\nexport const parseCommitNotes = (content: string): string => {\n  const commitNotes = content.replace(\n    /^.*#### Commits Notes:(.*)#### Options:.*$/s,\n    '$1',\n  );\n\n  if (commitNotes === content) {\n    return '';\n  } else {\n    return commitNotes.trim();\n  }\n};\n\ninterface ParsedBody {\n  options: Options;\n  commitNotes: string;\n}\n\nexport const parseBody = (\n  content: string,\n  defaultOptions: Options,\n): ParsedBody => {\n  return {\n    options: parseOptions(content, defaultOptions),\n    commitNotes: parseCommitNotes(content),\n  };\n};\n","import type { PullRequestLabels } from 'events/pr-handlers/utils/PullRequestData';\nimport type { LabelResponse } from '../../../../context/initRepoLabels';\n\nexport default function hasLabelInPR(\n  prLabels: PullRequestLabels,\n  label: LabelResponse,\n): boolean {\n  if (!label) return false;\n  return prLabels.some((l): boolean => l.id === label.id);\n}\n","import type { Context } from 'probot';\nimport type { RepoContext } from 'context/repoContext';\nimport type { AutomergeLog } from 'mongo';\nimport type {\n  PullRequestData,\n  PullRequestFromRestEndpoint,\n  PullRequestLabels,\n} from '../utils/PullRequestData';\nimport type { ReviewflowPrContext } from '../utils/createPullRequestContext';\nimport { parseBody } from './utils/body/parseBody';\nimport hasLabelInPR from './utils/hasLabelInPR';\n\nconst hasFailedStatusOrChecks = async (\n  pr: PullRequestData,\n  context: Context<any>,\n): Promise<boolean> => {\n  const checks = await context.octokit.checks.listForRef(\n    context.repo({\n      ref: pr.head.sha,\n      per_page: 100,\n    }),\n  );\n\n  const failedChecks = checks.data.check_runs.filter(\n    (check) => check.conclusion === 'failure',\n  );\n\n  if (failedChecks.length > 0) {\n    context.log.info(`automerge not possible: failed check pr ${pr.id}`, {\n      checks: failedChecks.map((check) => check.name),\n    });\n    return true;\n  }\n\n  const combinedStatus = await context.octokit.repos.getCombinedStatusForRef(\n    context.repo({\n      ref: pr.head.sha,\n      per_page: 100,\n    }),\n  );\n\n  if (combinedStatus.data.state === 'failure') {\n    const failedStatuses = combinedStatus.data.statuses.filter(\n      (status) => status.state === 'failure' || status.state === 'error',\n    );\n\n    context.log.info(`automerge not possible: failed status pr ${pr.id}`, {\n      statuses: failedStatuses.map((status) => status.context),\n    });\n\n    return true;\n  }\n\n  return false;\n};\n\nexport const autoMergeIfPossible = async (\n  pullRequest: PullRequestFromRestEndpoint,\n  context: Context<any>,\n  repoContext: RepoContext,\n  reviewflowPrContext: ReviewflowPrContext,\n  prLabels: PullRequestLabels = pullRequest.labels,\n): Promise<boolean> => {\n  if (reviewflowPrContext === null) return false;\n\n  const autoMergeLabel = repoContext.labels['merge/automerge'];\n\n  if (!hasLabelInPR(prLabels, autoMergeLabel)) {\n    repoContext.removePrFromAutomergeQueue(\n      context,\n      pullRequest.number,\n      'no automerge label',\n    );\n    return false;\n  }\n\n  const isRenovatePr = pullRequest.head.ref.startsWith('renovate/');\n\n  const createMergeLockPrFromPr = () => ({\n    id: pullRequest.id,\n    number: pullRequest.number,\n    branch: pullRequest.head.ref,\n  });\n\n  if (pullRequest.state !== 'open') {\n    repoContext.removePrFromAutomergeQueue(\n      context,\n      pullRequest.number,\n      'pr is not opened',\n    );\n  }\n\n  const addLog = (\n    type: AutomergeLog['type'],\n    action: AutomergeLog['action'],\n  ): void => {\n    const repoFullName = pullRequest.head.repo.full_name;\n    context.log.info(`automerge: ${repoFullName}#${pullRequest.id} ${type}`);\n    repoContext.appContext.mongoStores.automergeLogs.insertOne({\n      account: repoContext.accountEmbed,\n      repoFullName,\n      pr: {\n        id: pullRequest.id,\n        number: pullRequest.number,\n        isRenovate: isRenovatePr,\n        mergeableState: pullRequest.mergeable_state,\n      },\n      type,\n      action,\n    });\n  };\n\n  if (\n    repoContext.hasNeedsReview(prLabels) ||\n    repoContext.hasRequestedReview(prLabels)\n  ) {\n    repoContext.removePrFromAutomergeQueue(\n      context,\n      pullRequest.number,\n      'blocking labels',\n    );\n    return false;\n  }\n\n  if (pullRequest.requested_reviewers.length > 0) {\n    repoContext.removePrFromAutomergeQueue(\n      context,\n      pullRequest.number,\n      'still has requested reviewers',\n    );\n    return false;\n  }\n\n  const lockedPr = repoContext.getMergeLockedPr();\n  if (lockedPr && String(lockedPr.number) !== String(pullRequest.number)) {\n    context.log.info('automerge not possible: locked pr', {\n      prId: pullRequest.id,\n      prNumber: pullRequest.number,\n    });\n    repoContext.pushAutomergeQueue(createMergeLockPrFromPr());\n    return false;\n  }\n\n  repoContext.addMergeLockPr(createMergeLockPrFromPr());\n\n  if (pullRequest.mergeable == null) {\n    const prResult = await context.octokit.pulls.get(\n      context.repo({\n        pull_number: pullRequest.number,\n      }),\n    );\n    pullRequest = prResult.data;\n  }\n\n  if (pullRequest.merged) {\n    addLog('already merged', 'remove');\n    repoContext.removePrFromAutomergeQueue(\n      context,\n      pullRequest.number,\n      'pr already merged',\n    );\n    return false;\n  }\n\n  context.log.info(\n    `automerge?: ${pullRequest.id}, #${pullRequest.number}, mergeable=${pullRequest.mergeable} state=${pullRequest.mergeable_state}`,\n  );\n\n  // https://github.com/octokit/octokit.net/issues/1763\n  if (\n    !(\n      pullRequest.mergeable_state === 'clean' ||\n      pullRequest.mergeable_state === 'has_hooks' ||\n      pullRequest.mergeable_state === 'unstable'\n    )\n  ) {\n    if (\n      !pullRequest.mergeable_state ||\n      pullRequest.mergeable_state === 'unknown'\n    ) {\n      addLog('unknown mergeable_state', 'reschedule');\n      // GitHub is determining whether the pull request is mergeable\n      repoContext.reschedule(context, createMergeLockPrFromPr());\n      return false;\n    }\n\n    if (isRenovatePr) {\n      if (\n        pullRequest.mergeable_state === 'behind' ||\n        pullRequest.mergeable_state === 'dirty'\n      ) {\n        addLog('rebase-renovate', 'wait');\n\n        // TODO check if has commits not made by renovate https://github.com/ornikar/shared-configs/pull/47#issuecomment-445767120\n        if (pullRequest.body.includes('<!-- rebase-check -->')) {\n          if (pullRequest.body.includes('[x] <!-- rebase-check -->')) {\n            return false;\n          }\n\n          const renovateRebaseBody = pullRequest.body.replace(\n            '[ ] <!-- rebase-check -->',\n            '[x] <!-- rebase-check -->',\n          );\n          await context.octokit.issues.update(\n            context.repo({\n              issue_number: pullRequest.number,\n              body: renovateRebaseBody,\n            }),\n          );\n        } else if (!pullRequest.title.startsWith('rebase!')) {\n          await context.octokit.issues.update(\n            context.repo({\n              issue_number: pullRequest.number,\n              title: `rebase!${pullRequest.title}`,\n            }),\n          );\n        }\n        return false;\n      }\n\n      if (await hasFailedStatusOrChecks(pullRequest, context)) {\n        addLog('failed status or checks', 'remove');\n        repoContext.removePrFromAutomergeQueue(\n          context,\n          pullRequest.number,\n          'failed status or checks',\n        );\n        return false;\n      } else if (pullRequest.mergeable_state === 'blocked') {\n        addLog('blocked mergeable_state', 'wait');\n        // waiting for reschedule in status (pr-handler/status.ts)\n        return false;\n      }\n\n      context.log.info(\n        `automerge not possible: renovate with mergeable_state=${pullRequest.mergeable_state}`,\n      );\n      return false;\n    }\n\n    if (pullRequest.mergeable_state === 'blocked') {\n      if (await hasFailedStatusOrChecks(pullRequest, context)) {\n        addLog('failed status or checks', 'remove');\n        repoContext.removePrFromAutomergeQueue(\n          context,\n          pullRequest.number,\n          'failed status or checks',\n        );\n        return false;\n      } else {\n        addLog('blocked mergeable_state', 'wait');\n        // waiting for reschedule in status (pr-handler/status.ts)\n        return false;\n      }\n    }\n\n    if (pullRequest.mergeable_state === 'behind') {\n      addLog('behind mergeable_state', 'update branch');\n      context.log.info('automerge not possible: update branch', {\n        head: pullRequest.head.ref,\n        base: pullRequest.base.ref,\n      });\n\n      await context.octokit.repos.merge({\n        owner: pullRequest.head.repo.owner.login,\n        repo: pullRequest.head.repo.name,\n        head: pullRequest.base.ref,\n        base: pullRequest.head.ref,\n      });\n\n      return false;\n    }\n\n    addLog('not mergeable', 'remove');\n    repoContext.removePrFromAutomergeQueue(\n      context,\n      pullRequest.number,\n      `mergeable_state=${pullRequest.mergeable_state}`,\n    );\n    context.log.info(\n      `automerge not possible: not mergeable mergeable_state=${pullRequest.mergeable_state}`,\n    );\n    return false;\n  }\n\n  try {\n    context.log.info(`automerge pr #${pullRequest.number}`);\n\n    const parsedBody = parseBody(\n      reviewflowPrContext.commentBody,\n      repoContext.config.prDefaultOptions,\n    );\n    const options = parsedBody?.options || repoContext.config.prDefaultOptions;\n\n    const mergeResult = await context.octokit.pulls.merge({\n      merge_method: options.featureBranch ? 'merge' : 'squash',\n      owner: pullRequest.head.repo.owner.login,\n      repo: pullRequest.head.repo.name,\n      pull_number: pullRequest.number,\n      commit_title: options.featureBranch\n        ? undefined\n        : `${pullRequest.title}${\n            options.autoMergeWithSkipCi ? ' [skip ci]' : ''\n          } (#${pullRequest.number})`,\n      commit_message: options.featureBranch ? undefined : '', // TODO add BC\n    });\n    context.log.debug('merge result:', mergeResult.data);\n    repoContext.removePrFromAutomergeQueue(\n      context,\n      pullRequest.number,\n      'merged',\n    );\n    return Boolean('merged' in mergeResult.data && mergeResult.data.merged);\n  } catch (err) {\n    context.log.info('could not merge:', err.message);\n    repoContext.reschedule(context, createMergeLockPrFromPr());\n    return false;\n  }\n};\n","import type { StatusInfo } from 'accountConfigs/types';\nimport type { Options } from './parseBody';\nimport { parseOptions } from './parseBody';\nimport { optionsLabels } from './prOptions';\n\nexport const defaultCommentBody = 'This will be auto filled by reviewflow.';\n\nconst toMarkdownOptions = (options: Options) => {\n  return optionsLabels\n    .map(\n      ({ key, label }) =>\n        `- [${options[key] ? 'x' : ' '}] <!-- reviewflow-${key} -->${label}`,\n    )\n    .join('\\n');\n};\n\nconst toMarkdownInfos = (infos: StatusInfo[]): string => {\n  return infos\n    .map((info) => {\n      if (info.url) return `[${info.title}](${info.url})`;\n      return info.title;\n    })\n    .join('\\n');\n};\n\ninterface UpdatedBodyWithOptions {\n  commentBody: string;\n  options?: Options;\n}\n\nconst getReplacement = (infos?: StatusInfo[]): string => {\n  if (!infos) return '$1$2';\n  return infos.length > 0\n    ? `#### Infos:\\n\\n${toMarkdownInfos(infos)}\\n\\n$2`\n    : '$2';\n};\n\nconst updateOptions = (\n  options: Options,\n  optionsToUpdate?: Partial<Options>,\n): Options => {\n  if (!optionsToUpdate) return options;\n  return { ...options, ...optionsToUpdate };\n};\n\nconst internalUpdateBodyOptionsAndInfos = (\n  body: string,\n  options: Options,\n  infos?: StatusInfo[],\n): string => {\n  const infosAndCommitNotesParagraph = body.replace(\n    // eslint-disable-next-line unicorn/no-unsafe-regex\n    /^\\s*(?:(#### Infos:.*)?(#### Commits Notes:.*)?#### Options:)?.*$/s,\n    getReplacement(infos),\n  );\n\n  return `${infosAndCommitNotesParagraph}#### Options:\\n${toMarkdownOptions(\n    options,\n  )}`;\n};\n\nexport const createCommentBody = (\n  defaultOptions: Options,\n  infos?: StatusInfo[],\n): string => {\n  return internalUpdateBodyOptionsAndInfos('', defaultOptions, infos);\n};\n\nexport const updateCommentOptions = (\n  commentBody: string,\n  defaultOptions: Options,\n  optionsToUpdate?: Partial<Options>,\n): UpdatedBodyWithOptions => {\n  const options = parseOptions(commentBody, defaultOptions);\n  const updatedOptions = updateOptions(options, optionsToUpdate);\n\n  return {\n    options: updatedOptions,\n    commentBody: internalUpdateBodyOptionsAndInfos(commentBody, updatedOptions),\n  };\n};\n\nexport const updateCommentBodyInfos = (\n  commentBody: string,\n  infos?: StatusInfo[],\n): string => {\n  return commentBody.replace(\n    // *  - zero or more\n    // *? - zero or more (non-greedy)\n    // eslint-disable-next-line unicorn/no-unsafe-regex\n    /^\\s*(?:(#### Infos:.*?)?(#### Commits Notes:.*?)?(#### Options:.*?)?)?$/s,\n    `${getReplacement(infos)}$3`,\n  );\n};\n\nexport const updateCommentBodyCommitsNotes = (\n  commentBody: string,\n  commitNotes?: string,\n): string => {\n  return commentBody.replace(\n    // eslint-disable-next-line unicorn/no-unsafe-regex\n    /(?:#### Commits Notes:.*?)?(#### Options:)/s,\n    // eslint-disable-next-line no-nested-ternary\n    !commitNotes ? '$1' : `#### Commits Notes:\\n\\n${commitNotes}\\n\\n$1`,\n  );\n};\n\nexport const removeDeprecatedReviewflowInPrBody = (prBody: string): string => {\n  return prBody.replace(\n    // eslint-disable-next-line unicorn/no-unsafe-regex\n    /^(.*)<!---? do not edit after this -?-->(.*)<!---? end - don't add anything after this -?-->(.*)$/is,\n    // eslint-disable-next-line no-nested-ternary\n    '$1$3',\n  );\n};\n","import type { RestEndpointMethodTypes } from '@octokit/plugin-rest-endpoint-methods';\nimport type { Context } from 'probot';\nimport type { PullRequestWithDecentDataFromWebhook } from './PullRequestData';\n\nexport const createReviewflowComment = <T>(\n  pullRequestNumber: PullRequestWithDecentDataFromWebhook['number'],\n  context: Context<T>,\n  body: string,\n): Promise<\n  RestEndpointMethodTypes['issues']['createComment']['response']['data']\n> => {\n  return context.octokit.issues\n    .createComment(context.repo({ issue_number: pullRequestNumber, body }))\n    .then(({ data }) => data);\n};\n\nexport const getReviewflowCommentById = <T>(\n  pullRequestNumber: PullRequestWithDecentDataFromWebhook['number'],\n  context: Context<T>,\n  commentId: number,\n): Promise<\n  RestEndpointMethodTypes['issues']['getComment']['response']['data'] | null\n> => {\n  return context.octokit.issues\n    .getComment(\n      context.repo({\n        issue_number: pullRequestNumber,\n        comment_id: commentId,\n      }),\n    )\n    .then(\n      ({ data }) => data,\n      () => null,\n    );\n};\n","import type { Context } from 'probot';\nimport type { RepoContext } from 'context/repoContext';\nimport type { ReviewflowPr } from 'mongo';\nimport { defaultCommentBody } from '../actions/utils/body/updateBody';\nimport type { PullRequestWithDecentDataFromWebhook } from './PullRequestData';\nimport {\n  createReviewflowComment,\n  getReviewflowCommentById,\n} from './reviewflowComment';\n\nexport interface CreatePrContextOptions {\n  reviewflowCommentPromise?: ReturnType<typeof createReviewflowComment>;\n}\n\nexport interface ReviewflowPrContext {\n  reviewflowPr: ReviewflowPr;\n  commentBody: string;\n}\n\nexport const getReviewflowPrContext = async <T>(\n  pullRequestNumber: PullRequestWithDecentDataFromWebhook['number'],\n  context: Context<T>,\n  repoContext: RepoContext,\n  reviewflowCommentPromise?: ReturnType<typeof createReviewflowComment>,\n): Promise<ReviewflowPrContext> => {\n  const appContext = repoContext.appContext;\n  const prEmbed = { number: pullRequestNumber };\n\n  if (reviewflowCommentPromise) {\n    const comment = await reviewflowCommentPromise;\n    const reviewflowPr = await appContext.mongoStores.prs.insertOne({\n      account: repoContext.accountEmbed,\n      repo: repoContext.repoEmbed,\n      pr: prEmbed,\n      commentId: comment.id,\n    });\n    return { reviewflowPr, commentBody: comment.body };\n  }\n\n  const existing = await appContext.mongoStores.prs.findOne({\n    'account.id': repoContext.accountEmbed.id,\n    'repo.id': repoContext.repoEmbed.id,\n    'pr.number': pullRequestNumber,\n  });\n  const comment =\n    existing &&\n    (await getReviewflowCommentById(\n      pullRequestNumber,\n      context,\n      existing.commentId,\n    ));\n\n  if (!comment || !existing) {\n    const comment = await createReviewflowComment(\n      pullRequestNumber,\n      context,\n      defaultCommentBody,\n    );\n\n    if (!existing) {\n      const reviewflowPr = await appContext.mongoStores.prs.insertOne({\n        account: repoContext.accountEmbed,\n        repo: repoContext.repoEmbed,\n        pr: prEmbed,\n        commentId: comment.id,\n      });\n      return { reviewflowPr, commentBody: comment.body };\n    } else {\n      await appContext.mongoStores.prs.partialUpdateByKey(existing._id, {\n        $set: { commentId: comment.id },\n      });\n    }\n  }\n\n  return { reviewflowPr: existing, commentBody: comment!.body };\n};\n","import type { RestEndpointMethodTypes } from '@octokit/plugin-rest-endpoint-methods';\nimport type { Context } from 'probot';\n\nexport const fetchPr = async (\n  context: Context<any>,\n  prNumber: number,\n): Promise<RestEndpointMethodTypes['pulls']['get']['response']['data']> => {\n  const prResult = await context.octokit.pulls.get(\n    context.repo({ pull_number: prNumber }),\n  );\n\n  return prResult.data;\n};\n","import type { RestEndpointMethodTypes } from '@octokit/plugin-rest-endpoint-methods';\nimport type { Context } from 'probot';\nimport type { Config } from '../accountConfigs';\n\nexport interface LabelResponse {\n  id: number;\n  node_id: string;\n  url: string;\n  name: string;\n  description: string;\n  color: string;\n  default: boolean;\n}\n\nexport interface LabelsRecord {\n  [key: string]: LabelResponse;\n}\n\nexport const getLabelsForRepo = async (\n  context: Context<any>,\n): Promise<\n  RestEndpointMethodTypes['issues']['listLabelsForRepo']['response']['data']\n> => {\n  const { data: labels } = await context.octokit.issues.listLabelsForRepo(\n    context.repo({ per_page: 100 }),\n  );\n  return labels;\n};\n\nexport const initRepoLabels = async <GroupNames extends string>(\n  context: Context<any>,\n  config: Config<GroupNames>,\n): Promise<LabelsRecord> => {\n  const labels = await getLabelsForRepo(context);\n  const finalLabels: Record<string, LabelResponse> = {};\n\n  for (const [labelKey, labelConfig] of Object.entries(config.labels.list)) {\n    const labelColor = labelConfig.color.slice(1);\n    const description = labelConfig.description\n      ? `${labelConfig.description} - Synced by reviewflow`\n      : `Synced by reviewflow for ${labelKey}`;\n\n    let existingLabel = labels.find((label) => label.name === labelConfig.name);\n    if (!existingLabel) {\n      existingLabel = labels.find((label) => label.description === description);\n    }\n    if (!existingLabel) {\n      if (labelKey === 'design/needs-review') {\n        existingLabel = labels.find(\n          (label) => label.name === 'needs-design-review',\n        );\n      }\n      if (labelKey === 'design/approved') {\n        existingLabel = labels.find(\n          (label) => label.name === 'design-reviewed',\n        );\n      }\n      if (labelKey === 'teams/ops') {\n        existingLabel = labels.find((label) => label.name === 'archi');\n      }\n    }\n\n    if (!existingLabel) {\n      const result = await context.octokit.issues.createLabel(\n        context.repo({\n          name: labelConfig.name,\n          color: labelColor,\n          description,\n        }),\n      );\n      finalLabels[labelKey] = result.data;\n    } else if (\n      existingLabel.name !== labelConfig.name ||\n      existingLabel.color !== labelColor ||\n      existingLabel.description !== description\n    ) {\n      context.log.info('Needs to update label', {\n        current_name: existingLabel.name,\n        name: existingLabel.name !== labelConfig.name && labelConfig.name,\n        color: existingLabel.color !== labelColor && labelColor,\n        description: existingLabel.description !== description && description,\n      });\n\n      const result = await context.octokit.issues.updateLabel(\n        context.repo({\n          current_name: existingLabel.name,\n          name: labelConfig.name,\n          color: labelColor,\n          description,\n        }),\n      );\n      finalLabels[labelKey] = result.data;\n    } else {\n      finalLabels[labelKey] = existingLabel;\n    }\n  }\n\n  return finalLabels;\n};\n","import { Lock } from 'lock';\nimport type { Context } from 'probot';\nimport type { Config } from '../accountConfigs';\nimport { accountConfigs, defaultConfig } from '../accountConfigs';\nimport type { GroupLabels } from '../accountConfigs/types';\n// eslint-disable-next-line import/no-cycle\nimport { autoMergeIfPossible } from '../events/pr-handlers/actions/autoMergeIfPossible';\nimport type {\n  PullRequestData,\n  PullRequestLabels,\n  PullRequestWithDecentData,\n} from '../events/pr-handlers/utils/PullRequestData';\nimport { getReviewflowPrContext } from '../events/pr-handlers/utils/createPullRequestContext';\nimport { fetchPr } from '../events/pr-handlers/utils/fetchPr';\nimport { ExcludesFalsy } from '../utils/Excludes';\nimport type { AppContext } from './AppContext';\nimport type { AccountContext } from './accountContext';\nimport { obtainAccountContext } from './accountContext';\nimport type { LabelResponse, LabelsRecord } from './initRepoLabels';\nimport { initRepoLabels } from './initRepoLabels';\nimport { getEmojiFromRepoDescription } from './utils';\n\nexport interface LockedMergePr {\n  id: number;\n  number: number;\n  branch: string;\n}\n\ninterface RepoContextWithoutTeamContext<GroupNames extends string> {\n  appContext: AppContext;\n  repoFullName: string;\n  repoEmbed: { id: number; name: string };\n  repoEmoji: string | undefined;\n  labels: LabelsRecord;\n  protectedLabelIds: readonly LabelResponse['id'][];\n  shouldIgnore: boolean;\n\n  hasNeedsReview: (labels: PullRequestLabels) => boolean;\n  hasRequestedReview: (labels: PullRequestLabels) => boolean;\n  hasChangesRequestedReview: (labels: PullRequestLabels) => boolean;\n  hasApprovesReview: (labels: PullRequestLabels) => boolean;\n  getNeedsReviewGroupNames: (labels: PullRequestLabels) => GroupNames[];\n\n  lockPullRequest: (\n    pullRequest: PullRequestData,\n    callback: () => Promise<void> | void,\n  ) => Promise<void>;\n\n  /** @deprecated */\n  lockPR: (\n    prId: string,\n    prNumber: number,\n    callback: () => Promise<void> | void,\n  ) => Promise<void>;\n\n  getMergeLockedPr: () => LockedMergePr;\n  addMergeLockPr: (pr: LockedMergePr) => void;\n  removePrFromAutomergeQueue: (\n    context: Context<any>,\n    prNumber: number,\n    reason: string,\n  ) => void;\n  reschedule: (context: Context<any>, pr: LockedMergePr) => void;\n  pushAutomergeQueue: (pr: LockedMergePr) => void;\n}\n\nexport type RepoContext<GroupNames extends string = any> = AccountContext<\n  GroupNames\n> &\n  RepoContextWithoutTeamContext<GroupNames>;\n\nexport const shouldIgnoreRepo = (\n  repoName: string,\n  accountConfig: Config<any, any>,\n): boolean => {\n  const ignoreRepoRegexp =\n    accountConfig.ignoreRepoPattern &&\n    new RegExp(`^${accountConfig.ignoreRepoPattern}$`);\n\n  if (repoName === 'reviewflow-test') {\n    return process.env.REVIEWFLOW_NAME !== 'reviewflow-dev';\n  }\n\n  if (ignoreRepoRegexp) {\n    return ignoreRepoRegexp.test(repoName);\n  }\n\n  return false;\n};\n\nconst createGetReviewLabelIds = <GroupNames extends string>(\n  shouldIgnore: boolean,\n  config: Config<GroupNames>,\n  reviewGroupNames: GroupNames[],\n  labels: LabelsRecord,\n): ((labelKey: GroupLabels) => number[]) => {\n  if (shouldIgnore) return (labelKey: GroupLabels): number[] => [];\n  return (labelKey: GroupLabels): number[] =>\n    reviewGroupNames\n      .map((key) => config.labels.review[key][labelKey])\n      .filter(Boolean)\n      .map((name) => labels[name].id);\n};\n\nasync function initRepoContext<GroupNames extends string>(\n  appContext: AppContext,\n  context: Context<any>,\n  config: Config<GroupNames>,\n): Promise<RepoContext<GroupNames>> {\n  const {\n    id,\n    name,\n    full_name: fullName,\n    owner: org,\n    description,\n  } = context.payload.repository;\n  const repoEmoji = getEmojiFromRepoDescription(description);\n\n  const accountContext = await obtainAccountContext(\n    appContext,\n    context,\n    config,\n    org,\n  );\n  const repoContext = Object.create(accountContext);\n\n  const shouldIgnore = shouldIgnoreRepo(name, config);\n\n  const labels = shouldIgnore ? {} : await initRepoLabels(context, config);\n\n  const reviewGroupNames = Object.keys(config.groups) as GroupNames[];\n\n  const getReviewLabelIds = createGetReviewLabelIds(\n    shouldIgnore,\n    config,\n    reviewGroupNames,\n    labels,\n  );\n\n  const needsReviewLabelIds = getReviewLabelIds('needsReview');\n  const requestedReviewLabelIds = getReviewLabelIds('requested');\n  const changesRequestedLabelIds = getReviewLabelIds('changesRequested');\n  const approvedReviewLabelIds = getReviewLabelIds('approved');\n\n  const protectedLabelIds = [\n    ...requestedReviewLabelIds,\n    ...changesRequestedLabelIds,\n    ...approvedReviewLabelIds,\n  ];\n\n  const labelIdToGroupName = new Map<LabelResponse['id'], GroupNames>();\n  if (!shouldIgnore) {\n    reviewGroupNames.forEach((key) => {\n      const reviewGroupLabels = config.labels.review[key] as any;\n      Object.keys(reviewGroupLabels).forEach((labelKey: string) => {\n        labelIdToGroupName.set(labels[reviewGroupLabels[labelKey]].id, key);\n      });\n    });\n  }\n\n  // const updateStatusCheck = (context, reviewGroup, statusInfo) => {};\n\n  const hasNeedsReview = (labels: PullRequestLabels): boolean =>\n    labels.some((label) => needsReviewLabelIds.includes(label.id));\n  const hasRequestedReview = (labels: PullRequestLabels): boolean =>\n    labels.some((label) => requestedReviewLabelIds.includes(label.id));\n  const hasChangesRequestedReview = (labels: PullRequestLabels): boolean =>\n    labels.some((label) => changesRequestedLabelIds.includes(label.id));\n  const hasApprovesReview = (labels: PullRequestLabels): boolean =>\n    labels.some((label) => approvedReviewLabelIds.includes(label.id));\n\n  const getNeedsReviewGroupNames = (labels: PullRequestLabels): GroupNames[] =>\n    labels\n      .filter((label) => needsReviewLabelIds.includes(label.id))\n      .map((label) => labelIdToGroupName.get(label.id))\n      .filter(ExcludesFalsy);\n\n  const lock = Lock();\n  let lockMergePr: LockedMergePr | undefined;\n  let automergeQueue: LockedMergePr[] = [];\n\n  const lockPR = (\n    prOrPrIssueId: string,\n    prNumber: number,\n    callback: () => Promise<void> | void,\n  ): Promise<void> =>\n    new Promise((resolve, reject) => {\n      const logInfos = {\n        repo: fullName,\n        prOrPrIssueId,\n        prNumber,\n      };\n      context.log.debug('lock: try to lock pr', logInfos);\n      // eslint-disable-next-line @typescript-eslint/no-misused-promises\n      lock(String(prNumber), async (createReleaseCallback) => {\n        const release = createReleaseCallback(() => {});\n        context.log.info('lock: lock pr acquired', logInfos);\n        try {\n          await callback();\n        } catch (err) {\n          context.log.info('lock: release pr (with error)', logInfos);\n          release();\n          reject(err);\n          return;\n        }\n        context.log.info('lock: release pr', logInfos);\n        release();\n        resolve();\n      });\n    });\n\n  const lockPullRequest = (\n    pullRequest: PullRequestWithDecentData,\n    callback: () => Promise<void> | void,\n  ): Promise<void> => {\n    return lockPR(String(pullRequest.id), pullRequest.number, callback);\n  };\n\n  const reschedule = (context: Context<any>, pr: LockedMergePr): void => {\n    if (!pr) throw new Error('Cannot reschedule undefined');\n    context.log.info('reschedule', pr);\n    setTimeout(() => {\n      lockPR('reschedule', -1, () => {\n        return lockPR(String(pr.id), pr.number, async () => {\n          const [pullRequest, reviewflowPrContext] = await Promise.all([\n            fetchPr(context, pr.number),\n            getReviewflowPrContext(pr.number, context, repoContext),\n          ]);\n          await autoMergeIfPossible(\n            pullRequest,\n            context,\n            repoContext,\n            reviewflowPrContext,\n          );\n        });\n      });\n    }, 10_000);\n  };\n\n  return Object.assign(repoContext, {\n    appContext,\n    labels,\n    repoFullName: fullName,\n    repoEmbed: { id, name },\n    repoEmoji,\n    protectedLabelIds,\n    shouldIgnore,\n    hasNeedsReview,\n    hasRequestedReview,\n    hasChangesRequestedReview,\n    hasApprovesReview,\n    getNeedsReviewGroupNames,\n\n    getMergeLockedPr: () => lockMergePr,\n    addMergeLockPr: (pr: LockedMergePr): void => {\n      console.log('merge lock: lock', {\n        repo: fullName,\n        pr,\n      });\n      if (lockMergePr && String(lockMergePr.number) === String(pr.number)) {\n        return;\n      }\n      if (lockMergePr) throw new Error('Already have lock');\n      lockMergePr = pr;\n    },\n    removePrFromAutomergeQueue: (\n      context,\n      prNumber: number | string,\n      reason: string,\n    ): void => {\n      if (lockMergePr && String(lockMergePr.number) === String(prNumber)) {\n        lockMergePr = automergeQueue.shift();\n        context.log(`merge lock: remove ${fullName}#${prNumber}: ${reason}`);\n        context.log(`merge lock: next ${fullName}`, lockMergePr);\n        if (lockMergePr) {\n          reschedule(context, lockMergePr);\n        }\n      } else {\n        const previousLength = automergeQueue.length;\n        automergeQueue = automergeQueue.filter(\n          (value) => String(value.number) !== String(prNumber),\n        );\n        if (automergeQueue.length !== previousLength) {\n          context.log(`merge lock: remove ${fullName}#${prNumber}: ${reason}`);\n        }\n      }\n    },\n    pushAutomergeQueue: (pr: LockedMergePr): void => {\n      context.log('merge lock: push queue', {\n        repo: fullName,\n        pr,\n        lockMergePr,\n        automergeQueue,\n      });\n      if (!automergeQueue.some((p) => p.number === pr.number)) {\n        automergeQueue.push(pr);\n      }\n    },\n    reschedule,\n\n    lockPR,\n    lockPullRequest,\n  } as RepoContextWithoutTeamContext<GroupNames>);\n}\n\nconst repoContextsPromise = new Map<number, Promise<RepoContext>>();\nconst repoContexts = new Map<number, RepoContext>();\n\nexport const obtainRepoContext = (\n  appContext: AppContext,\n  context: Context<any>,\n): Promise<RepoContext> | RepoContext | null => {\n  const repo = context.payload.repository;\n  const owner = repo.owner;\n  const key = repo.id;\n\n  const existingRepoContext = repoContexts.get(key);\n  if (existingRepoContext) return existingRepoContext;\n\n  const existingPromise = repoContextsPromise.get(key);\n  if (existingPromise) return Promise.resolve(existingPromise);\n\n  let accountConfig = accountConfigs[owner.login];\n\n  if (!accountConfig) {\n    console.warn(`using default config for ${owner.login}`);\n    accountConfig = defaultConfig as Config<any, any>;\n  }\n\n  const promise = initRepoContext(appContext, context, accountConfig);\n  repoContextsPromise.set(key, promise);\n\n  return promise.then((repoContext) => {\n    repoContextsPromise.delete(key);\n    repoContexts.set(key, repoContext);\n    return repoContext;\n  });\n};\n","import type { EventPayloads } from '@octokit/webhooks';\nimport type { Context } from 'probot';\nimport type { OnCallback } from 'probot/lib/application';\nimport type { AppContext } from '../../../context/AppContext';\nimport type { RepoContext } from '../../../context/repoContext';\nimport { obtainRepoContext } from '../../../context/repoContext';\n\nexport const createRepoHandler = <\n  T extends { repository: EventPayloads.PayloadRepository }\n>(\n  appContext: AppContext,\n  callback: (\n    context: Context<T>,\n    repoContext: RepoContext,\n  ) => Promise<void> | void,\n): OnCallback<T> => {\n  return async (context): Promise<void> => {\n    const repoContext = await obtainRepoContext(appContext, context);\n    if (!repoContext) return;\n\n    return callback(context, repoContext);\n  };\n};\n","import type { EventPayloads } from '@octokit/webhooks';\nimport type { Context } from 'probot';\nimport type { OnCallback } from 'probot/lib/application';\nimport type { AppContext } from '../../../context/AppContext';\nimport type { RepoContext, LockedMergePr } from '../../../context/repoContext';\nimport { createRepoHandler } from '../../repository-handlers/utils/createRepoHandler';\nimport type {\n  PullRequestData,\n  PullRequestFromWebhook,\n} from './PullRequestData';\nimport type {\n  CreatePrContextOptions,\n  ReviewflowPrContext,\n} from './createPullRequestContext';\nimport { getReviewflowPrContext } from './createPullRequestContext';\n\nexport type CallbackWithPRAndRepoContext<T extends PullRequestData> = (\n  pullRequest: T,\n  repoContext: RepoContext,\n) => void | Promise<void>;\n\nexport const createPullRequestHandler = <\n  T extends\n    | EventPayloads.WebhookPayloadPullRequest\n    | EventPayloads.WebhookPayloadPullRequestReview\n    | EventPayloads.WebhookPayloadPullRequestReviewComment\n    | EventPayloads.WebhookPayloadIssueComment\n    | EventPayloads.WebhookPayloadPullRequestReviewComment,\n  U extends PullRequestFromWebhook\n>(\n  appContext: AppContext,\n  getPullRequestInPayload: (\n    payload: Context<T>['payload'],\n    context: Context<T>,\n    repoContext: RepoContext,\n  ) => U | null,\n  callbackPr: (\n    pullRequest: U,\n    context: Context<T>,\n    repoContext: RepoContext,\n    reviewflowPrContext: ReviewflowPrContext | null,\n  ) => void | Promise<void>,\n  callbackBeforeLock?: (\n    pullRequest: U,\n    context: Context<T>,\n    repoContext: RepoContext,\n  ) => CreatePrContextOptions,\n): OnCallback<T> => {\n  return createRepoHandler(appContext, async (context, repoContext) => {\n    const pullRequest: U | null = getPullRequestInPayload(\n      context.payload,\n      context,\n      repoContext,\n    );\n    if (pullRequest === null) return;\n    const options = callbackBeforeLock\n      ? callbackBeforeLock(pullRequest, context, repoContext)\n      : {};\n\n    await repoContext.lockPullRequest(pullRequest, async () => {\n      /*\n       * When repo are ignored, only slack notifications are sent.\n       * PR is not linted, commented, nor auto merged.\n       */\n      const reviewflowPrContext = repoContext.shouldIgnore\n        ? null\n        : await getReviewflowPrContext(\n            pullRequest.number,\n            context,\n            repoContext,\n            options.reviewflowCommentPromise,\n          );\n\n      return callbackPr(pullRequest, context, repoContext, reviewflowPrContext);\n    });\n  });\n};\n\nexport const createPullRequestsHandler = <\n  T extends { repository: EventPayloads.PayloadRepository },\n  U extends PullRequestFromWebhook | LockedMergePr\n>(\n  appContext: AppContext,\n  getPrs: (payload: Context<T>['payload'], repoContext: RepoContext) => U[],\n  callbackPr: (\n    pullRequest: U,\n    context: Context<T>,\n    repoContext: RepoContext,\n  ) => void | Promise<void>,\n): OnCallback<T> => {\n  return createRepoHandler(appContext, async (context, repoContext) => {\n    const prs = getPrs(context.payload, repoContext);\n    if (prs.length === 0) return;\n\n    await Promise.all(\n      prs.map((pr) =>\n        repoContext.lockPR(String(pr.id), pr.number, async () => {\n          return callbackPr(pr, context, repoContext);\n        }),\n      ),\n    );\n  });\n};\n","import type { Probot } from 'probot';\nimport type { AppContext } from '../../context/AppContext';\nimport { autoMergeIfPossible } from './actions/autoMergeIfPossible';\nimport { getReviewflowPrContext } from './utils/createPullRequestContext';\nimport { createPullRequestsHandler } from './utils/createPullRequestHandler';\nimport { fetchPr } from './utils/fetchPr';\n\nexport default function checkrunCompleted(\n  app: Probot,\n  appContext: AppContext,\n): void {\n  app.on(\n    'check_run.completed',\n    createPullRequestsHandler(\n      appContext,\n      (payload, repoContext) => {\n        if (repoContext.shouldIgnore) return [];\n        return payload.check_run.pull_requests;\n      },\n      async (pullRequest, context, repoContext) => {\n        const [updatedPr, reviewflowPrContext] = await Promise.all([\n          fetchPr(context, pullRequest.number),\n          getReviewflowPrContext(pullRequest.number, context, repoContext),\n        ]);\n\n        await autoMergeIfPossible(\n          updatedPr,\n          context,\n          repoContext,\n          reviewflowPrContext,\n        );\n      },\n    ),\n  );\n}\n","import type { Probot } from 'probot';\nimport type { AppContext } from '../../context/AppContext';\nimport { autoMergeIfPossible } from './actions/autoMergeIfPossible';\nimport { getReviewflowPrContext } from './utils/createPullRequestContext';\nimport { createPullRequestsHandler } from './utils/createPullRequestHandler';\nimport { fetchPr } from './utils/fetchPr';\n\nexport default function checksuiteCompleted(\n  app: Probot,\n  appContext: AppContext,\n): void {\n  app.on(\n    'check_suite.completed',\n    createPullRequestsHandler(\n      appContext,\n      (payload, repoContext) => {\n        if (repoContext.shouldIgnore) return [];\n        return payload.check_suite.pull_requests;\n      },\n      async (pullRequest, context, repoContext) => {\n        const [updatedPr, reviewflowPrContext] = await Promise.all([\n          fetchPr(context, pullRequest.number),\n          getReviewflowPrContext(pullRequest.number, context, repoContext),\n        ]);\n\n        await autoMergeIfPossible(\n          updatedPr,\n          context,\n          repoContext,\n          reviewflowPrContext,\n        );\n      },\n    ),\n  );\n}\n","import type { EventPayloads } from '@octokit/webhooks';\nimport type { Context } from 'probot';\n\nexport default async function createStatus<\n  T extends { repository: EventPayloads.PayloadRepository }\n>(\n  context: Context<T>,\n  name: string,\n  sha: string,\n  type: 'failure' | 'success',\n  description: string,\n  url?: string,\n): Promise<void> {\n  await context.octokit.repos.createCommitStatus(\n    context.repo({\n      context:\n        name === ''\n          ? process.env.REVIEWFLOW_NAME\n          : `${process.env.REVIEWFLOW_NAME}/${name}`,\n      sha,\n      state: type,\n      description,\n      target_url: url,\n    }),\n  );\n}\n","import type { EventPayloads } from '@octokit/webhooks';\nimport type { Context } from 'probot';\nimport type { RepoContext } from 'context/repoContext';\nimport type {\n  PullRequestLabels,\n  PullRequestWithDecentData,\n} from '../utils/PullRequestData';\nimport createStatus from './utils/createStatus';\n\nconst addStatusCheck = async function <\n  T extends { repository: EventPayloads.PayloadRepository }\n>(\n  pullRequest: PullRequestWithDecentData,\n  context: Context<T>,\n  { state, description }: { state: 'failure' | 'success'; description: string },\n  previousSha?: string,\n): Promise<void> {\n  const hasPrCheck = (\n    await context.octokit.checks.listForRef(\n      context.repo({\n        ref: pullRequest.head.sha,\n      }),\n    )\n  ).data.check_runs.find((check) => check.name === process.env.REVIEWFLOW_NAME);\n\n  context.log.debug('add status check', { hasPrCheck, state, description });\n\n  if (hasPrCheck) {\n    await context.octokit.checks.create(\n      context.repo({\n        name: process.env.REVIEWFLOW_NAME as string,\n        head_sha: pullRequest.head.sha,\n        started_at: pullRequest.created_at,\n        status: 'completed',\n        conclusion: state,\n        completed_at: new Date().toISOString(),\n        output: {\n          title: description,\n          summary: '',\n        },\n      }),\n    );\n  } else if (previousSha && state === 'failure') {\n    await Promise.all([\n      createStatus(\n        context,\n        '',\n        previousSha,\n        'success',\n        'New commits have been pushed',\n      ),\n      createStatus(context, '', pullRequest.head.sha, state, description),\n    ]);\n  } else {\n    await createStatus(context, '', pullRequest.head.sha, state, description);\n  }\n};\n\nexport const updateStatusCheckFromLabels = <\n  T extends { repository: EventPayloads.PayloadRepository }\n>(\n  pullRequest: PullRequestWithDecentData,\n  context: Context<T>,\n  repoContext: RepoContext,\n  labels: PullRequestLabels = pullRequest.labels || [],\n  previousSha?: string,\n): Promise<void> => {\n  context.log.debug('updateStatusCheckFromLabels', {\n    labels: labels.map((l) => l?.name),\n    hasNeedsReview: repoContext.hasNeedsReview(labels),\n    hasApprovesReview: repoContext.hasApprovesReview(labels),\n  });\n\n  const createFailedStatusCheck = (description: string): Promise<void> =>\n    addStatusCheck(\n      pullRequest,\n      context,\n      {\n        state: 'failure',\n        description,\n      },\n      previousSha,\n    );\n\n  if (pullRequest.requested_reviewers.length > 0) {\n    return createFailedStatusCheck(\n      // TODO remove `as`\n      // https://github.com/probot/probot/issues/1219\n      `Awaiting review from: ${pullRequest.requested_reviewers\n        .map((rr: any) => rr.login)\n        .join(', ')}`,\n    );\n  }\n\n  if (repoContext.hasChangesRequestedReview(labels)) {\n    return createFailedStatusCheck(\n      'Changes requested ! Push commits or discuss changes then re-request a review.',\n    );\n  }\n\n  const needsReviewGroupNames = repoContext.getNeedsReviewGroupNames(labels);\n\n  if (needsReviewGroupNames.length > 0) {\n    return createFailedStatusCheck(\n      `Awaiting review from: ${needsReviewGroupNames.join(\n        ', ',\n      )}. Perhaps request someone ?`,\n    );\n  }\n\n  if (!repoContext.hasApprovesReview(labels)) {\n    if (repoContext.config.requiresReviewRequest) {\n      return createFailedStatusCheck(\n        'Awaiting review... Perhaps request someone ?',\n      );\n    }\n  }\n\n  // if (\n  //   repoContext.config.requiresReviewRequest &&\n  //   !repoContext.hasRequestedReview(labels)\n  // ) {\n  //   return  createFailedStatusCheck(\n  //     context,\n  //     pr,\n  //     'You need to request someone to review the PR',\n  //   );\n  //   return;\n  // }\n  // return  createInProgressStatusCheck(context);\n  // } else if (repoContext.hasApprovesReview(labels)) {\n  return addStatusCheck(\n    pullRequest,\n    context,\n    {\n      state: 'success',\n      description: ' PR ready to merge !',\n    },\n    previousSha,\n  );\n  // }\n};\n","import type { EventPayloads } from '@octokit/webhooks';\nimport type { Context } from 'probot';\nimport type { RepoContext } from 'context/repoContext';\nimport type { GroupLabels } from '../../../accountConfigs/types';\nimport type {\n  PullRequestLabels,\n  PullRequestWithDecentData,\n} from '../utils/PullRequestData';\nimport { updateStatusCheckFromLabels } from './updateStatusCheckFromLabels';\n\nexport const updateReviewStatus = async <\n  E extends { repository: EventPayloads.PayloadRepository },\n  GroupNames extends string = any\n>(\n  pullRequest: PullRequestWithDecentData,\n  context: Context<E>,\n  repoContext: RepoContext,\n  reviewGroup: GroupNames,\n  {\n    add: labelsToAdd,\n    remove: labelsToRemove,\n  }: {\n    add?: (GroupLabels | false | undefined)[];\n    remove?: (GroupLabels | false | undefined)[];\n  },\n): Promise<PullRequestLabels> => {\n  context.log.debug('updateReviewStatus', {\n    reviewGroup,\n    labelsToAdd,\n    labelsToRemove,\n  });\n\n  let prLabels: PullRequestLabels = pullRequest.labels || [];\n  if (!reviewGroup) return prLabels;\n\n  const newLabelNames = new Set<string>(prLabels.map((label) => label.name));\n\n  const toAdd = new Set<GroupLabels | string>();\n  const toAddNames = new Set<string>();\n  const toDelete = new Set<GroupLabels>();\n  const toDeleteNames = new Set<string>();\n  const labels = repoContext.labels;\n\n  const getLabelFromKey = (\n    key: GroupLabels,\n  ): undefined | PullRequestLabels[number] => {\n    const reviewConfig = repoContext.config.labels.review[reviewGroup];\n    if (!reviewConfig) return undefined;\n\n    return reviewConfig[key] && labels[reviewConfig[key]]\n      ? labels[reviewConfig[key]]\n      : undefined;\n  };\n\n  if (labelsToAdd) {\n    labelsToAdd.forEach((key) => {\n      if (!key) return;\n      const label = getLabelFromKey(key);\n      if (!label || prLabels.some((prLabel) => prLabel.id === label.id)) {\n        return;\n      }\n      newLabelNames.add(label.name);\n      toAdd.add(key);\n      toAddNames.add(label.name);\n    });\n  }\n\n  if (labelsToRemove) {\n    labelsToRemove.forEach((key) => {\n      if (!key) return;\n      const label = getLabelFromKey(key);\n      if (!label) return;\n      const existing = prLabels.find((prLabel) => prLabel.id === label.id);\n      if (existing) {\n        newLabelNames.delete(existing.name);\n        toDelete.add(key);\n        toDeleteNames.add(existing.name);\n      }\n    });\n  }\n\n  // TODO move that elsewhere\n\n  repoContext.getTeamsForLogin(pullRequest.user.login).forEach((teamName) => {\n    const team = repoContext.config.teams[teamName];\n    if (team.labels) {\n      team.labels.forEach((labelKey) => {\n        const label = repoContext.labels[labelKey];\n        if (label && !prLabels.some((prLabel) => prLabel.id === label.id)) {\n          newLabelNames.add(label.name);\n          toAdd.add(labelKey);\n          toAddNames.add(label.name);\n        }\n      });\n    }\n  });\n\n  // if (process.env.DRY_RUN && process.env.DRY_RUN !== 'false') return;\n\n  if (toAdd.size !== 0 || toDelete.size !== 0) {\n    if (toDelete.size === 0 || toDelete.size < 4) {\n      context.log.debug('updateReviewStatus', {\n        reviewGroup,\n        toAdd: [...toAdd],\n        toDelete: [...toDelete],\n        toAddNames: [...toAddNames],\n        toDeleteNames: [...toDeleteNames],\n      });\n\n      if (toAdd.size !== 0) {\n        const result = await context.octokit.issues.addLabels(\n          context.issue({\n            labels: [...toAddNames],\n          }),\n        );\n        prLabels = result.data;\n      }\n\n      if (toDelete.size !== 0) {\n        for (const toDeleteName of [...toDeleteNames]) {\n          try {\n            const result = await context.octokit.issues.removeLabel(\n              context.issue({\n                name: toDeleteName,\n              }),\n            );\n            prLabels = result.data;\n          } catch (err) {\n            context.log.warn('error removing label', {\n              err: err?.message,\n            });\n          }\n        }\n      }\n    } else {\n      const newLabelNamesArray = [...newLabelNames];\n\n      context.log.debug('updateReviewStatus', {\n        reviewGroup,\n        toAdd: [...toAdd],\n        toDelete: [...toDelete],\n        oldLabels: prLabels.map((l) => l.name),\n        newLabelNames: newLabelNamesArray,\n      });\n\n      const result = await context.octokit.issues.setLabels(\n        context.issue({\n          labels: newLabelNamesArray,\n        }),\n      );\n      prLabels = result.data;\n    }\n  }\n\n  // if (toAdd.has('needsReview')) {\n  //   createInProgressStatusCheck(context);\n  // } else if (\n  //   toDelete.has('needsReview') ||\n  //   (prLabels.length === 0 && toAdd.size === 1 && toAdd.has('approved'))\n  // ) {\n  await updateStatusCheckFromLabels(\n    pullRequest,\n    context,\n    repoContext,\n    prLabels,\n  );\n  // }\n\n  return prLabels;\n};\n","import type { Probot } from 'probot';\nimport type { AppContext } from '../../context/AppContext';\nimport { updateReviewStatus } from './actions/updateReviewStatus';\nimport { parseOptions } from './actions/utils/body/parseBody';\nimport { createPullRequestHandler } from './utils/createPullRequestHandler';\n\nexport default function closed(app: Probot, appContext: AppContext): void {\n  app.on(\n    'pull_request.closed',\n    createPullRequestHandler(\n      appContext,\n      (payload) => payload.pull_request,\n      async (pullRequest, context, repoContext, reviewflowPrContext) => {\n        if (!repoContext.shouldIgnore && reviewflowPrContext) {\n          const repo = context.payload.repository;\n\n          if (pullRequest.merged) {\n            const isNotFork = pullRequest.head.repo.id === repo.id;\n            const options = parseOptions(\n              reviewflowPrContext.commentBody,\n              repoContext.config.prDefaultOptions,\n            );\n\n            await Promise.all([\n              repoContext.removePrFromAutomergeQueue(\n                context,\n                pullRequest.number,\n                'pr closed',\n              ),\n              isNotFork && options.deleteAfterMerge\n                ? context.octokit.git\n                    .deleteRef(\n                      context.repo({ ref: `heads/${pullRequest.head.ref}` }),\n                    )\n                    .catch(() => {})\n                : undefined,\n            ]);\n          } else {\n            await Promise.all([\n              repoContext.removePrFromAutomergeQueue(\n                context,\n                pullRequest.number,\n                'pr closed',\n              ),\n              updateReviewStatus(pullRequest, context, repoContext, 'dev', {\n                remove: ['needsReview'],\n              }),\n            ]);\n          }\n        }\n\n        if (pullRequest.assignees) {\n          pullRequest.assignees.forEach((assignee) => {\n            repoContext.slack.updateHome(assignee.login);\n          });\n        }\n      },\n    ),\n  );\n}\n","import type { RepoContext } from '../context/repoContext';\n\nexport const createLink = (url: string, text: string): string => {\n  return `<${url}|${text}>`;\n};\n\nexport const createPrLink = (\n  pr: { html_url: string; number: number },\n  repoContext: RepoContext,\n): string => {\n  return createLink(\n    pr.html_url,\n    `${repoContext.repoEmoji ? `${repoContext.repoEmoji} ` : ''}${\n      repoContext.repoFullName\n    }#${pr.number}`,\n  );\n};\n","import type { KnownBlock } from '@slack/web-api';\nimport type { SlackMessage } from '../../../context/SlackMessage';\n\nexport const createMrkdwnSectionBlock = (text: string): KnownBlock => ({\n  type: 'section',\n  text: {\n    type: 'mrkdwn',\n    text,\n  },\n});\n\nexport const createSlackMessageWithSecondaryBlock = (\n  message: string,\n  secondaryBlockText?: string | null,\n): SlackMessage => {\n  return {\n    text: message,\n    blocks: [\n      {\n        type: 'section',\n        text: {\n          type: 'mrkdwn',\n          text: message,\n        },\n      },\n    ],\n    secondaryBlocks: !secondaryBlockText\n      ? undefined\n      : [createMrkdwnSectionBlock(secondaryBlockText)],\n  };\n};\n","import type { EventPayloads } from '@octokit/webhooks';\n\ntype WebhookPr =\n  | EventPayloads.WebhookPayloadPullRequest['pull_request']\n  | EventPayloads.WebhookPayloadPullRequestReviewPullRequest;\n\ntype PullRequestHandlerAllowedPayloads =\n  | {\n      repository: EventPayloads.PayloadRepository;\n      pull_request: WebhookPr;\n    }\n  | {\n      repository: EventPayloads.PayloadRepository;\n      issue: EventPayloads.WebhookPayloadIssueCommentIssue;\n    };\n\nexport type PullRequestFromPayload<\n  T extends PullRequestHandlerAllowedPayloads\n> = T extends { pull_request: WebhookPr }\n  ? T['pull_request']\n  : T extends { issue: EventPayloads.WebhookPayloadIssueCommentIssue }\n  ? T['issue'] /* & T['issue']['pull_request'] */\n  : never;\n\n/** deprecated */\nexport const getPullRequestFromPayload = <\n  T extends PullRequestHandlerAllowedPayloads\n>(\n  payload: T,\n): PullRequestFromPayload<T> => {\n  const pullRequest: WebhookPr = (payload as any).pull_request;\n  if (pullRequest) {\n    return pullRequest as PullRequestFromPayload<T>;\n  }\n\n  const issue = (payload as any).issue;\n  if (issue?.pull_request) {\n    return {\n      ...issue,\n      ...issue.pull_request,\n    };\n  }\n\n  throw new Error('No pull_request in payload');\n};\n","import type { RestEndpointMethodTypes } from '@octokit/plugin-rest-endpoint-methods';\nimport type { Context } from 'probot';\nimport type { RepoContext } from '../../../context/repoContext';\nimport { getKeys } from '../../../context/utils';\n\ntype ReviewState = 'CHANGES_REQUESTED' | 'APPROVED' | 'DISMISSED';\n\ninterface ReviewStates {\n  approved: number;\n  changesRequested: number;\n  dismissed: number;\n}\ninterface Reviewer {\n  id: number;\n  login: string;\n}\n\nexport const getReviewersAndReviewStates = async <GroupNames extends string>(\n  context: Context,\n  repoContext: RepoContext<GroupNames>,\n): Promise<{\n  reviewers: Reviewer[];\n  reviewStates: Record<GroupNames, ReviewStates>;\n}> => {\n  const userIds = new Set<number>();\n  const reviewers: Reviewer[] = [];\n  const reviewStatesByUser = new Map<number, ReviewState>();\n\n  await context.octokit.paginate(\n    context.octokit.pulls.listReviews,\n    context.pullRequest(),\n    ({\n      data: reviews,\n    }: RestEndpointMethodTypes['pulls']['listReviews']['response']) => {\n      reviews.forEach((review) => {\n        if (!userIds.has(review.user.id)) {\n          userIds.add(review.user.id);\n          reviewers.push({ id: review.user.id, login: review.user.login });\n        }\n        const state = review.state.toUpperCase();\n        if (state !== 'COMMENTED') {\n          reviewStatesByUser.set(review.user.id, state as ReviewState);\n        }\n      });\n\n      return [];\n    },\n  );\n\n  const reviewStates: Record<GroupNames, ReviewStates> = {} as Record<\n    GroupNames,\n    ReviewStates\n  >;\n\n  getKeys(repoContext.config.groups).forEach((groupName) => {\n    reviewStates[groupName] = {\n      approved: 0,\n      changesRequested: 0,\n      dismissed: 0,\n    };\n  });\n\n  reviewers.forEach((reviewer) => {\n    const group = repoContext.getReviewerGroup(reviewer.login);\n    if (group) {\n      const state = reviewStatesByUser.get(reviewer.id);\n      switch (state) {\n        case 'APPROVED':\n          reviewStates[group].approved++;\n          break;\n        case 'CHANGES_REQUESTED':\n          reviewStates[group].changesRequested++;\n          break;\n        case 'DISMISSED':\n          reviewStates[group].dismissed++;\n          break;\n      }\n    }\n  });\n\n  return { reviewers, reviewStates };\n};\n","import type { RepoContext } from '../../../context/repoContext';\n\nexport const checkIfUserIsBot = (\n  repoContext: RepoContext,\n  user: { login: string; type: string },\n): boolean => {\n  if (user.type === 'Bot') return true;\n  if (repoContext.config.botUsers) {\n    return repoContext.config.botUsers.includes(user.login);\n  }\n  return false;\n};\n\nexport const checkIfIsThisBot = (user: {\n  login: string;\n  type: string;\n}): boolean => {\n  return (\n    user.type === 'Bot' && user.login === `${process.env.REVIEWFLOW_NAME}[bot]`\n  );\n};\n","import issueParser from 'issue-parser';\n\nconst parse = issueParser('github', { actions: {}, issuePrefixes: [] });\n\nexport const parseMentions = (body: string): readonly string[] => {\n  return parse(body).mentions.map((m) => m.user);\n};\n","import slackifyMarkdown from 'slackify-markdown';\n\nexport const slackifyCommentBody = (\n  body: string,\n  multipleLines: boolean,\n): string => {\n  return slackifyMarkdown(\n    body\n      .replace('```suggestion', '_Suggested change:_\\n```suggestion')\n      .replace(\n        '```suggestion\\r\\n```',\n        `_Suggestion to remove line${multipleLines ? 's' : ''}._\\n`,\n      ),\n  );\n};\n","import type { RestEndpointMethodTypes } from '@octokit/plugin-rest-endpoint-methods';\nimport type { EventPayloads } from '@octokit/webhooks';\nimport type { Probot, Context } from 'probot';\nimport type { AppContext } from '../../context/AppContext';\nimport type { SlackMessage } from '../../context/SlackMessage';\nimport type { PostSlackMessageResult } from '../../context/TeamSlack';\nimport type { AccountEmbed } from '../../mongo';\nimport * as slackUtils from '../../slack/utils';\nimport { ExcludesNullish } from '../../utils/Excludes';\nimport { createPullRequestHandler } from './utils/createPullRequestHandler';\nimport { createSlackMessageWithSecondaryBlock } from './utils/createSlackMessageWithSecondaryBlock';\nimport { fetchPr } from './utils/fetchPr';\nimport type { PullRequestFromPayload } from './utils/getPullRequestFromPayload';\nimport { getPullRequestFromPayload } from './utils/getPullRequestFromPayload';\nimport { getReviewersAndReviewStates } from './utils/getReviewersAndReviewStates';\nimport { checkIfUserIsBot, checkIfIsThisBot } from './utils/isBotUser';\nimport { parseMentions } from './utils/parseMentions';\nimport { slackifyCommentBody } from './utils/slackifyCommentBody';\n\nconst getDiscussion = async (\n  context: Context,\n  comment: any,\n): Promise<\n  RestEndpointMethodTypes['pulls']['listComments']['response']['data']\n> => {\n  if (!comment.in_reply_to_id) return [comment];\n  return context.octokit.paginate(\n    context.octokit.pulls.listComments.endpoint.merge(context.pullRequest()),\n    ({\n      data,\n    }: RestEndpointMethodTypes['pulls']['listComments']['response']) => {\n      return data.filter(\n        (c) =>\n          c.in_reply_to_id === comment.in_reply_to_id ||\n          c.id === comment.in_reply_to_id,\n      );\n    },\n  );\n};\n\nconst getMentions = (\n  discussion: RestEndpointMethodTypes['pulls']['listComments']['response']['data'],\n): string[] => {\n  const mentions = new Set<string>();\n\n  discussion.forEach((c) => {\n    parseMentions(c.body).forEach((m) => mentions.add(m));\n  });\n\n  return [...mentions];\n};\n\nconst getUsersInThread = (\n  discussion: RestEndpointMethodTypes['pulls']['listComments']['response']['data'],\n): { id: number; login: string }[] => {\n  const userIds = new Set<number>();\n  const users: { id: number; login: string }[] = [];\n\n  discussion.forEach((c) => {\n    if (userIds.has(c.user.id)) return;\n    userIds.add(c.user.id);\n    users.push({ id: c.user.id, login: c.user.login });\n  });\n\n  return users;\n};\n\nexport default function prCommentCreated(\n  app: Probot,\n  appContext: AppContext,\n): void {\n  const saveInDb = async (\n    type: 'review-comment' | 'issue-comment',\n    commentId: number,\n    accountEmbed: AccountEmbed,\n    results: PostSlackMessageResult[],\n    message: SlackMessage,\n  ): Promise<void> => {\n    const filtered = results.filter(ExcludesNullish);\n    if (filtered.length === 0) return;\n\n    await appContext.mongoStores.slackSentMessages.insertOne({\n      type,\n      typeId: commentId,\n      message,\n      account: accountEmbed,\n      sentTo: filtered,\n    });\n  };\n\n  app.on(\n    [\n      'pull_request_review_comment.created',\n      // comments without review and without path are sent with issue_comment.created.\n      // createHandlerPullRequestChange checks if pull_request event is present, removing real issues comments.\n      'issue_comment.created',\n    ],\n    createPullRequestHandler<\n      | EventPayloads.WebhookPayloadPullRequestReviewComment\n      | EventPayloads.WebhookPayloadIssueComment,\n      | PullRequestFromPayload<\n          | EventPayloads.WebhookPayloadPullRequestReviewComment\n          | EventPayloads.WebhookPayloadIssueComment\n        >\n      | any\n    >(\n      appContext,\n      (payload, context) => {\n        if (checkIfIsThisBot(payload.comment.user)) {\n          // ignore comments from this bot\n          return null;\n        }\n        return getPullRequestFromPayload(payload);\n      },\n      async (\n        pullRequest,\n        context,\n        repoContext,\n        reviewflowPrContext,\n      ): Promise<void> => {\n        const pr = await fetchPr(context, pullRequest.number);\n        const { comment } = context.payload;\n        const type = (comment as any).pull_request_review_id\n          ? 'review-comment'\n          : 'issue-comment';\n\n        const body = comment.body;\n        if (!body) return;\n\n        const commentByOwner = pr.user.login === comment.user.login;\n        const [discussion, { reviewers }] = await Promise.all([\n          getDiscussion(context, comment),\n          getReviewersAndReviewStates(context, repoContext),\n        ]);\n\n        const followers = reviewers.filter(\n          (u) => u.id !== pr.user.id && u.id !== comment.user.id,\n        );\n\n        if (pr.requested_reviewers) {\n          followers.push(\n            ...pr.requested_reviewers.filter((rr) => {\n              return (\n                !followers.find((f) => f.id === rr.id) &&\n                rr.id !== comment.user.id &&\n                rr.id !== pr.user.id\n              );\n            }),\n          );\n        }\n\n        const usersInThread = getUsersInThread(discussion).filter(\n          (u) =>\n            u.id !== pr.user.id &&\n            u.id !== comment.user.id &&\n            !followers.find((f) => f.id === u.id),\n        );\n        const mentions = getMentions(discussion).filter(\n          (m) =>\n            m !== pr.user.login &&\n            m !== comment.user.login &&\n            !followers.find((f) => f.login === m) &&\n            !usersInThread.find((u) => u.login === m),\n        );\n\n        const mention = repoContext.slack.mention(comment.user.login);\n        const prUrl = slackUtils.createPrLink(pr, repoContext);\n        const ownerMention = repoContext.slack.mention(pr.user.login);\n        const commentLink = slackUtils.createLink(\n          comment.html_url,\n          (comment as any).in_reply_to_id ? 'replied' : 'commented',\n        );\n\n        const createMessage = (toOwner?: boolean): string => {\n          const ownerPart = toOwner\n            ? 'your PR'\n            : `${\n                pr.user.id === comment.user.id ? 'his' : `${ownerMention}'s`\n              } PR`;\n          return `:speech_balloon: ${mention} ${commentLink} on ${ownerPart} ${prUrl}`;\n        };\n\n        const promisesOwner = [];\n        const promisesNotOwner = [];\n        const slackifiedBody = slackifyCommentBody(\n          comment.body,\n          (comment as any).start_line !== null,\n        );\n        const isBotUser = checkIfUserIsBot(repoContext, comment.user);\n\n        if (!commentByOwner) {\n          const slackMessage = createSlackMessageWithSecondaryBlock(\n            createMessage(true),\n            slackifiedBody,\n          );\n\n          promisesOwner.push(\n            repoContext.slack\n              .postMessage(\n                isBotUser ? 'pr-comment-bots' : 'pr-comment',\n                pr.user.id,\n                pr.user.login,\n                slackMessage,\n              )\n              .then((res) =>\n                saveInDb(\n                  type,\n                  comment.id,\n                  repoContext.accountEmbed,\n                  [res],\n                  slackMessage,\n                ),\n              ),\n          );\n        }\n\n        const message = createSlackMessageWithSecondaryBlock(\n          createMessage(false),\n          slackifiedBody,\n        );\n\n        promisesNotOwner.push(\n          ...followers.map((follower) =>\n            repoContext.slack.postMessage(\n              isBotUser ? 'pr-comment-follow-bots' : 'pr-comment-follow',\n              follower.id,\n              follower.login,\n              message,\n            ),\n          ),\n        );\n\n        promisesNotOwner.push(\n          ...usersInThread.map((user) =>\n            repoContext.slack.postMessage(\n              'pr-comment-thread',\n              user.id,\n              user.login,\n              message,\n            ),\n          ),\n        );\n\n        if (mentions.length > 0) {\n          await appContext.mongoStores.users\n            .findAll({ login: { $in: mentions } })\n            .then((users) => {\n              promisesNotOwner.push(\n                ...users.map((u) =>\n                  repoContext.slack.postMessage(\n                    'pr-comment-mention',\n                    u._id,\n                    u.login,\n                    message,\n                  ),\n                ),\n              );\n            });\n        }\n\n        await Promise.all([\n          Promise.all(promisesOwner),\n          Promise.all(promisesNotOwner).then((results) =>\n            saveInDb(\n              type,\n              comment.id,\n              repoContext.accountEmbed,\n              results,\n              message,\n            ),\n          ),\n        ]);\n      },\n    ),\n  );\n}\n","import type { EventPayloads } from '@octokit/webhooks';\nimport type { Context } from 'probot';\nimport type { RepoContext } from 'context/repoContext';\nimport type { ReviewflowPrContext } from '../utils/createPullRequestContext';\nimport type { Options } from './utils/body/prOptions';\nimport { updateCommentOptions } from './utils/body/updateBody';\n\nconst updatePrCommentBody = async <\n  E extends EventPayloads.WebhookPayloadPullRequest\n>(\n  context: Context<E>,\n  reviewflowPrContext: ReviewflowPrContext,\n  newBody: string,\n): Promise<void> => {\n  await context.octokit.issues.updateComment(\n    context.repo({\n      comment_id: reviewflowPrContext.reviewflowPr.commentId,\n      body: newBody,\n    }),\n  );\n  reviewflowPrContext.commentBody = newBody;\n};\n\nexport const updatePrCommentBodyIfNeeded = async <\n  E extends EventPayloads.WebhookPayloadPullRequest\n>(\n  context: Context<E>,\n  reviewflowPrContext: ReviewflowPrContext,\n  newBody: string,\n): Promise<void> => {\n  if (reviewflowPrContext.commentBody !== newBody) {\n    await updatePrCommentBody(context, reviewflowPrContext, newBody);\n  }\n};\n\nexport const updatePrCommentBodyOptions = async <\n  E extends EventPayloads.WebhookPayloadPullRequest\n>(\n  context: Context<E>,\n  repoContext: RepoContext,\n  reviewflowPrContext: ReviewflowPrContext,\n  updateOptions: Partial<Options>,\n): Promise<void> => {\n  const { commentBody: newBody } = updateCommentOptions(\n    reviewflowPrContext.commentBody,\n    repoContext.config.prDefaultOptions,\n    updateOptions,\n  );\n\n  await updatePrCommentBodyIfNeeded(context, reviewflowPrContext, newBody);\n};\n","import type { EventPayloads } from '@octokit/webhooks';\nimport type { Context } from 'probot';\nimport type { PullRequestWithDecentData } from 'events/pr-handlers/utils/PullRequestData';\nimport type { LabelResponse } from '../../../../context/initRepoLabels';\nimport hasLabelInPR from './hasLabelInPR';\n\ninterface SyncLabelOptions {\n  onRemove?: () => void | Promise<void>;\n  onAdd?: (prLabels: LabelResponse[]) => void | Promise<void>;\n}\n\nexport default async function syncLabel<\n  T extends EventPayloads.WebhookPayloadPullRequest\n>(\n  pullRequest: PullRequestWithDecentData,\n  context: Context<T>,\n  shouldHaveLabel: boolean,\n  label: LabelResponse,\n  prHasLabel = hasLabelInPR(pullRequest.labels, label),\n  { onRemove, onAdd }: SyncLabelOptions = {},\n): Promise<void> {\n  if (prHasLabel && !shouldHaveLabel) {\n    await context.octokit.issues.removeLabel(\n      context.issue({ name: label.name }),\n    );\n    if (onRemove) await onRemove();\n  }\n  if (shouldHaveLabel && !prHasLabel) {\n    const response = await context.octokit.issues.addLabels(\n      context.issue({ labels: [label.name] }),\n    );\n    if (onAdd) await onAdd(response.data);\n  }\n}\n","import type { Context } from 'probot';\nimport type { RepoContext } from 'context/repoContext';\nimport type {\n  PullRequestFromRestEndpoint,\n  PullRequestWithDecentData,\n} from '../utils/PullRequestData';\nimport type { ReviewflowPrContext } from '../utils/createPullRequestContext';\nimport { autoMergeIfPossible } from './autoMergeIfPossible';\nimport { updatePrCommentBodyIfNeeded } from './updatePrCommentBody';\nimport type { Options } from './utils/body/prOptions';\nimport { updateCommentOptions } from './utils/body/updateBody';\nimport hasLabelInPR from './utils/hasLabelInPR';\nimport syncLabel from './utils/syncLabel';\n\nexport const calcDefaultOptions = (\n  repoContext: RepoContext,\n  pullRequest: PullRequestWithDecentData,\n): Options => {\n  const featureBranchLabel = repoContext.labels['feature-branch'];\n  const automergeLabel = repoContext.labels['merge/automerge'];\n  const skipCiLabel = repoContext.labels['merge/skip-ci'];\n\n  const prHasFeatureBranchLabel = hasLabelInPR(\n    pullRequest.labels,\n    featureBranchLabel,\n  );\n  const prHasSkipCiLabel = hasLabelInPR(pullRequest.labels, skipCiLabel);\n  const prHasAutoMergeLabel = hasLabelInPR(pullRequest.labels, automergeLabel);\n\n  return {\n    ...repoContext.config.prDefaultOptions,\n    featureBranch: prHasFeatureBranchLabel,\n    autoMergeWithSkipCi: prHasSkipCiLabel,\n    autoMerge: prHasAutoMergeLabel,\n  };\n};\n\nexport const syncLabelsAfterCommentBodyEdited = async (\n  pullRequest: PullRequestFromRestEndpoint,\n  context: Context<any>,\n  repoContext: RepoContext,\n  reviewflowPrContext: ReviewflowPrContext,\n): Promise<void> => {\n  const featureBranchLabel = repoContext.labels['feature-branch'];\n  const automergeLabel = repoContext.labels['merge/automerge'];\n  const skipCiLabel = repoContext.labels['merge/skip-ci'];\n\n  const prHasFeatureBranchLabel = hasLabelInPR(\n    pullRequest.labels,\n    featureBranchLabel,\n  );\n  const prHasSkipCiLabel = hasLabelInPR(pullRequest.labels, skipCiLabel);\n  const prHasAutoMergeLabel = hasLabelInPR(pullRequest.labels, automergeLabel);\n\n  const { commentBody, options } = updateCommentOptions(\n    reviewflowPrContext.commentBody,\n    calcDefaultOptions(repoContext, pullRequest),\n  );\n\n  await updatePrCommentBodyIfNeeded(context, reviewflowPrContext, commentBody);\n\n  if (options && (featureBranchLabel || automergeLabel)) {\n    await Promise.all([\n      featureBranchLabel &&\n        syncLabel(\n          pullRequest,\n          context,\n          options.featureBranch,\n          featureBranchLabel,\n          prHasFeatureBranchLabel,\n        ),\n      skipCiLabel &&\n        syncLabel(\n          pullRequest,\n          context,\n          options.autoMergeWithSkipCi,\n          skipCiLabel,\n          prHasSkipCiLabel,\n        ),\n      automergeLabel &&\n        syncLabel(\n          pullRequest,\n          context,\n          options.autoMerge,\n          automergeLabel,\n          prHasAutoMergeLabel,\n          {\n            onAdd: async (prLabels) => {\n              await autoMergeIfPossible(\n                pullRequest,\n                context,\n                repoContext,\n                reviewflowPrContext,\n                prLabels,\n              );\n            },\n            onRemove: () => {\n              repoContext.removePrFromAutomergeQueue(\n                context,\n                pullRequest.number,\n                'label removed',\n              );\n            },\n          },\n        ),\n    ]);\n  }\n};\n","import type { EventPayloads } from '@octokit/webhooks';\nimport type { Probot } from 'probot';\nimport type { AppContext } from '../../context/AppContext';\nimport { syncLabelsAfterCommentBodyEdited } from './actions/syncLabelsAfterCommentBodyEdited';\nimport { createPullRequestHandler } from './utils/createPullRequestHandler';\nimport { createMrkdwnSectionBlock } from './utils/createSlackMessageWithSecondaryBlock';\nimport { fetchPr } from './utils/fetchPr';\nimport type { PullRequestFromPayload } from './utils/getPullRequestFromPayload';\nimport { getPullRequestFromPayload } from './utils/getPullRequestFromPayload';\nimport { checkIfIsThisBot } from './utils/isBotUser';\nimport { slackifyCommentBody } from './utils/slackifyCommentBody';\n\nexport default function prCommentEditedOrDeleted(\n  app: Probot,\n  appContext: AppContext,\n): void {\n  app.on(\n    [\n      'pull_request_review_comment.edited',\n      'pull_request_review_comment.deleted',\n      // comments without review and without path are sent with issue_comment.created.\n      // createHandlerPullRequestChange checks if pull_request event is present, removing real issues comments.\n      'issue_comment.edited',\n      'issue_comment.deleted',\n    ],\n    createPullRequestHandler<\n      | EventPayloads.WebhookPayloadPullRequestReviewComment\n      | EventPayloads.WebhookPayloadIssueComment,\n      | PullRequestFromPayload<\n          | EventPayloads.WebhookPayloadPullRequestReviewComment\n          | EventPayloads.WebhookPayloadIssueComment\n        >\n      | any\n    >(\n      appContext,\n      (payload) => {\n        if (checkIfIsThisBot(payload.sender)) {\n          // ignore edits made from this bot\n          return null;\n        }\n        return getPullRequestFromPayload(payload);\n      },\n      async (\n        pullRequest,\n        context,\n        repoContext,\n        reviewflowPrContext,\n      ): Promise<void> => {\n        const { comment } = context.payload;\n\n        if (\n          reviewflowPrContext !== null &&\n          context.payload.action === 'edited' &&\n          checkIfIsThisBot(comment.user)\n        ) {\n          const updatedPr = await fetchPr(context, pullRequest.number);\n          if (!updatedPr.closed_at) {\n            await syncLabelsAfterCommentBodyEdited(\n              updatedPr,\n              context,\n              repoContext,\n              reviewflowPrContext,\n            );\n          }\n          return;\n        }\n\n        const type = (comment as any).pull_request_review_id\n          ? 'review-comment'\n          : 'issue-comment';\n\n        const criteria = {\n          'account.id': repoContext.account._id,\n          'account.type': repoContext.accountType,\n          type,\n          typeId: comment.id,\n        };\n\n        const sentMessages = await appContext.mongoStores.slackSentMessages.findAll(\n          criteria,\n        );\n\n        if (sentMessages.length === 0) return;\n\n        if (context.payload.action === 'deleted') {\n          await Promise.all([\n            Promise.all(\n              sentMessages.map((sentMessage) =>\n                Promise.all(\n                  sentMessage.sentTo.map((sentTo) =>\n                    repoContext.slack.deleteMessage(sentTo.ts, sentTo.channel),\n                  ),\n                ),\n              ),\n            ),\n            appContext.mongoStores.slackSentMessages.deleteMany(criteria),\n          ]);\n        } else {\n          const secondaryBlocks = [\n            createMrkdwnSectionBlock(\n              slackifyCommentBody(\n                comment.body,\n                (comment as any).start_line !== null,\n              ),\n            ),\n          ];\n\n          await Promise.all([\n            Promise.all(\n              sentMessages.map((sentMessage) =>\n                Promise.all(\n                  sentMessage.sentTo.map((sentTo) =>\n                    repoContext.slack.updateMessage(sentTo.ts, sentTo.channel, {\n                      ...sentMessage.message,\n                      secondaryBlocks,\n                    }),\n                  ),\n                ),\n              ),\n            ),\n            appContext.mongoStores.slackSentMessages.partialUpdateMany(\n              criteria,\n              { $set: { 'message.secondaryBlocks': secondaryBlocks } },\n            ),\n          ]);\n        }\n      },\n    ),\n  );\n}\n","import type { CommitNote } from '@commitlint/parse';\nimport parse from '@commitlint/parse';\nimport type { RestEndpointMethodTypes } from '@octokit/plugin-rest-endpoint-methods';\nimport type { EventPayloads } from '@octokit/webhooks';\nimport type { Context } from 'probot';\nimport type { RepoContext } from 'context/repoContext';\nimport type { PullRequestWithDecentData } from '../utils/PullRequestData';\nimport type { ReviewflowPrContext } from '../utils/createPullRequestContext';\nimport { updatePrCommentBodyIfNeeded } from './updatePrCommentBody';\nimport { updateCommentBodyCommitsNotes } from './utils/body/updateBody';\nimport syncLabel from './utils/syncLabel';\n\ninterface BreakingChangesCommits {\n  commit: RestEndpointMethodTypes['pulls']['listCommits']['response']['data'][number];\n  breakingChangesNotes: CommitNote[];\n}\n\nexport const readCommitsAndUpdateInfos = async <\n  E extends EventPayloads.WebhookPayloadPullRequest\n>(\n  pullRequest: PullRequestWithDecentData,\n  context: Context<E>,\n  repoContext: RepoContext,\n  reviewflowPrContext: ReviewflowPrContext,\n  commentBody = reviewflowPrContext.commentBody,\n): Promise<void> => {\n  // tmp.data[0].sha\n  // tmp.data[0].commit.message\n\n  const commits = await context.octokit.paginate(\n    context.octokit.pulls.listCommits,\n    context.pullRequest({\n      // A custom page size up to 100. Default is 30.\n      per_page: 100,\n    }),\n    (res) => res.data,\n  );\n\n  const conventionalCommits = await Promise.all(\n    commits.map((c) => parse(c.commit.message)),\n  );\n\n  const breakingChangesCommits: BreakingChangesCommits[] = [];\n  conventionalCommits.forEach((c, index) => {\n    const breakingChangesNotes = c.notes.filter(\n      (note) => note.title === 'BREAKING CHANGE',\n    );\n    if (breakingChangesNotes.length > 0) {\n      breakingChangesCommits.push({\n        commit: commits[index],\n        breakingChangesNotes,\n      });\n    }\n  });\n\n  const breakingChangesLabel = repoContext.labels['breaking-changes'];\n  const newCommentBody = updateCommentBodyCommitsNotes(\n    commentBody,\n    breakingChangesCommits.length === 0\n      ? ''\n      : `Breaking Changes:\\n${breakingChangesCommits\n          .map(({ commit, breakingChangesNotes }) =>\n            breakingChangesNotes.map(\n              (note) => `- ${note.text.replace('\\n', ' ')} (${commit.sha})`,\n            ),\n          )\n          .join('')}`,\n  );\n\n  await Promise.all([\n    syncLabel(\n      pullRequest,\n      context,\n      breakingChangesCommits.length !== 0,\n      breakingChangesLabel,\n    ),\n    updatePrCommentBodyIfNeeded(context, reviewflowPrContext, newCommentBody),\n  ]);\n\n  // TODO auto update ! in front of : to signal a breaking change when https://github.com/conventional-changelog/commitlint/issues/658 is closed\n};\n","import type { EventPayloads } from '@octokit/webhooks';\nimport type { Context } from 'probot';\nimport type { PullRequestWithDecentData } from '../utils/PullRequestData';\n\ninterface UpdatePr {\n  title?: string;\n  body?: string;\n}\n\nconst cleanNewLines = (text: string): string => text.replace(/\\r\\n/g, '\\n');\nconst checkIfHasDiff = (text1: string, text2: string): boolean =>\n  cleanNewLines(text1) !== cleanNewLines(text2);\n\nexport const updatePrIfNeeded = async <\n  E extends EventPayloads.WebhookPayloadPullRequest\n>(\n  pullRequest: PullRequestWithDecentData,\n  context: Context<E>,\n  update: UpdatePr,\n): Promise<void> => {\n  const hasDiffInTitle = update.title && pullRequest.title !== update.title;\n  const hasDiffInBody =\n    update.body && checkIfHasDiff(pullRequest.body, update.body);\n\n  if (hasDiffInTitle || hasDiffInBody) {\n    const diff: Partial<Record<'title' | 'body', string>> = {};\n    if (hasDiffInTitle) {\n      diff.title = update.title;\n      pullRequest.title = update.title as string;\n    }\n    if (hasDiffInBody) {\n      diff.body = update.body;\n      pullRequest.body = update.body as string;\n    }\n\n    await context.octokit.pulls.update(\n      context.repo({\n        pull_number: pullRequest.number,\n        ...diff,\n      }),\n    );\n  }\n};\n","export const cleanTitle = (title: string): string =>\n  title\n    .trim()\n    .replace(\n      /[\\s-]+\\[?\\s*([A-Za-z][\\dA-Za-z]+)[ -](\\d+)\\s*]?\\s*$/,\n      (s, arg1, arg2) => ` ${arg1.toUpperCase()}-${arg2}`,\n    )\n    .replace(/^([A-Za-z]+)[/:]\\s*/, (s, arg1) => `${arg1.toLowerCase()}: `)\n    .replace(/^Revert \"([^\"]+)\"$/, 'revert: $1')\n    .replace(/\\s+[[\\]]\\s*no\\s*issue\\s*[[\\]]$/i, ' [no issue]')\n    // eslint-disable-next-line unicorn/no-unsafe-regex\n    .replace(/^(revert:.*)(\\s+\\(#\\d+\\))$/, '$1');\n","import type { EventPayloads } from '@octokit/webhooks';\nimport type { Context } from 'probot';\nimport type { RepoContext } from 'context/repoContext';\nimport type { StatusError, StatusInfo } from '../../../accountConfigs/types';\nimport { ExcludesFalsy } from '../../../utils/Excludes';\nimport type { PullRequestWithDecentData } from '../utils/PullRequestData';\nimport type { ReviewflowPrContext } from '../utils/createPullRequestContext';\nimport { readCommitsAndUpdateInfos } from './readCommitsAndUpdateInfos';\nimport { calcDefaultOptions } from './syncLabelsAfterCommentBodyEdited';\nimport { updatePrIfNeeded } from './updatePr';\nimport { updatePrCommentBodyIfNeeded } from './updatePrCommentBody';\nimport {\n  updateCommentBodyInfos,\n  defaultCommentBody,\n  createCommentBody,\n  removeDeprecatedReviewflowInPrBody,\n} from './utils/body/updateBody';\nimport { cleanTitle } from './utils/cleanTitle';\nimport createStatus from './utils/createStatus';\n\ninterface StatusWithInfo {\n  name: string;\n  info: StatusInfo;\n  error?: undefined;\n}\n\ninterface StatusWithError {\n  name: string;\n  error: StatusError;\n  info?: undefined;\n}\n\ntype Status = StatusWithInfo | StatusWithError;\n\nexport const editOpenedPR = async <\n  E extends EventPayloads.WebhookPayloadPullRequest\n>(\n  pullRequest: PullRequestWithDecentData,\n  context: Context<E>,\n  repoContext: RepoContext,\n  reviewflowPrContext: ReviewflowPrContext | null,\n  shouldUpdateCommentBodyInfos: boolean,\n  previousSha?: string,\n): Promise<void> => {\n  if (reviewflowPrContext === null) return;\n\n  const title = repoContext.config.trimTitle\n    ? cleanTitle(pullRequest.title)\n    : pullRequest.title;\n\n  const isPrFromBot = pullRequest.user.type === 'Bot';\n\n  const statuses: Status[] = [];\n\n  const errorRule = repoContext.config.parsePR.title.find((rule) => {\n    if (rule.bot === false && isPrFromBot) return false;\n\n    const match = rule.regExp.exec(title);\n    if (match === null) {\n      if (rule.status) {\n        statuses.push({ name: rule.status, error: rule.error });\n      }\n      return true;\n    }\n\n    if (rule.status && rule.statusInfoFromMatch) {\n      statuses.push({\n        name: rule.status,\n        info: rule.statusInfoFromMatch(match),\n      });\n      return false;\n    }\n\n    return false;\n  });\n\n  const date = new Date().toISOString();\n\n  const hasLintPrCheck = (\n    await context.octokit.checks.listForRef(\n      context.repo({\n        ref: pullRequest.head.sha,\n      }),\n    )\n  ).data.check_runs.find(\n    (check): boolean => check.name === `${process.env.REVIEWFLOW_NAME}/lint-pr`,\n  );\n\n  const promises: Promise<unknown>[] = [\n    ...statuses.map(\n      ({ name, error, info }): Promise<void> =>\n        createStatus(\n          context,\n          name,\n          pullRequest.head.sha,\n          error ? 'failure' : 'success',\n          error ? error.title : (info as StatusInfo).title,\n          error ? undefined : (info as StatusInfo).url,\n        ),\n    ),\n    ...(previousSha\n      ? statuses\n          .map(({ name, error, info }): Promise<void> | undefined =>\n            error\n              ? createStatus(\n                  context,\n                  name,\n                  previousSha,\n                  'success',\n                  'New commits have been pushed',\n                )\n              : undefined,\n          )\n          .filter(ExcludesFalsy)\n      : []),\n    hasLintPrCheck &&\n      context.octokit.checks.create(\n        context.repo({\n          name: `${process.env.REVIEWFLOW_NAME}/lint-pr`,\n          head_sha: pullRequest.head.sha,\n          status: 'completed' as const,\n          conclusion: (errorRule ? 'failure' : 'success') as\n            | 'failure'\n            | 'success',\n          started_at: date,\n          completed_at: date,\n          output: errorRule\n            ? errorRule.error\n            : {\n                title: ' Your PR is valid',\n                summary: '',\n              },\n        }),\n      ),\n    !hasLintPrCheck && previousSha && errorRule\n      ? createStatus(\n          context,\n          'lint-pr',\n          previousSha,\n          'success',\n          'New commits have been pushed',\n        )\n      : undefined,\n    !hasLintPrCheck &&\n      createStatus(\n        context,\n        'lint-pr',\n        pullRequest.head.sha,\n        errorRule ? 'failure' : 'success',\n        errorRule ? errorRule.error.title : ' Your PR is valid',\n      ),\n  ].filter(ExcludesFalsy);\n\n  const body = removeDeprecatedReviewflowInPrBody(pullRequest.body);\n  promises.push(updatePrIfNeeded(pullRequest, context, { title, body }));\n\n  const commentBodyInfos = statuses\n    .filter((status) => status.info?.inBody)\n    .map((status) => status.info) as StatusInfo[];\n\n  const shouldCreateCommentBody =\n    reviewflowPrContext.commentBody === defaultCommentBody;\n\n  const newBody = shouldCreateCommentBody\n    ? createCommentBody(\n        calcDefaultOptions(repoContext, pullRequest),\n        commentBodyInfos,\n      )\n    : updateCommentBodyInfos(reviewflowPrContext.commentBody, commentBodyInfos);\n\n  if (shouldCreateCommentBody || shouldUpdateCommentBodyInfos) {\n    promises.push(\n      readCommitsAndUpdateInfos(\n        pullRequest,\n        context,\n        repoContext,\n        reviewflowPrContext,\n        newBody,\n      ),\n    );\n  } else {\n    promises.push(\n      updatePrCommentBodyIfNeeded(context, reviewflowPrContext, newBody),\n    );\n  }\n\n  await Promise.all(promises);\n};\n","import type { Probot } from 'probot';\nimport type { AppContext } from '../../context/AppContext';\nimport { autoMergeIfPossible } from './actions/autoMergeIfPossible';\nimport { editOpenedPR } from './actions/editOpenedPR';\nimport { createPullRequestHandler } from './utils/createPullRequestHandler';\nimport { fetchPr } from './utils/fetchPr';\nimport { checkIfIsThisBot } from './utils/isBotUser';\n\nexport default function edited(app: Probot, appContext: AppContext): void {\n  app.on(\n    'pull_request.edited',\n    createPullRequestHandler(\n      appContext,\n      (payload, context, repoContext) => {\n        if (repoContext.shouldIgnore) return null;\n        return payload.pull_request;\n      },\n      async (\n        pullRequest,\n        context,\n        repoContext,\n        reviewflowPrContext,\n      ): Promise<void> => {\n        if (reviewflowPrContext == null) return;\n\n        const sender = context.payload.sender;\n        if (checkIfIsThisBot(sender)) {\n          return;\n        }\n\n        const updatedPullRequest = await fetchPr(\n          context,\n          context.payload.pull_request.number,\n        );\n\n        await editOpenedPR(\n          updatedPullRequest,\n          context,\n          repoContext,\n          reviewflowPrContext,\n          false,\n        );\n        await autoMergeIfPossible(\n          updatedPullRequest,\n          context,\n          repoContext,\n          reviewflowPrContext,\n        );\n      },\n    ),\n  );\n}\n","import type { Context } from 'probot';\nimport type { PullRequestWithDecentData } from '../utils/PullRequestData';\n\nexport const updateBranch = async (\n  pullRequest: PullRequestWithDecentData,\n  context: Context<any>,\n  login: string,\n): Promise<void> => {\n  context.log.info('update branch', {\n    head: pullRequest.head.ref,\n    base: pullRequest.base.ref,\n  });\n\n  const result = await context.octokit.repos\n    .merge({\n      owner: pullRequest.head.repo.owner.login,\n      repo: pullRequest.head.repo.name,\n      head: pullRequest.base.ref,\n      base: pullRequest.head.ref,\n    })\n    .catch((err) => ({ error: err } as any));\n\n  context.log.info('update branch result', {\n    status: result.status,\n    sha: result.data?.sha,\n    error: result.error,\n  });\n\n  if (result.status === 204) {\n    context.octokit.issues.createComment(\n      context.repo({\n        issue_number: pullRequest.number,\n        body: `@${login} could not update branch: base already contains the head, nothing to merge.`,\n      }),\n    );\n  } else if (result.status === 409) {\n    context.octokit.issues.createComment(\n      context.repo({\n        issue_number: pullRequest.number,\n        body: `@${login} could not update branch: merge conflict. Please resolve manually.`,\n      }),\n    );\n  } else if (!result || !result.data || !result.data.sha) {\n    context.octokit.issues.createComment(\n      context.repo({\n        issue_number: pullRequest.number,\n        body: `@${login} could not update branch (unknown error)`,\n      }),\n    );\n  } else {\n    context.octokit.issues.createComment(\n      context.repo({\n        issue_number: pullRequest.number,\n        body: `@${login} branch updated: ${result.data.sha}`,\n      }),\n    );\n  }\n};\n","import type { EventPayloads } from '@octokit/webhooks';\nimport type { Probot } from 'probot';\nimport type { AppContext } from '../../context/AppContext';\nimport { autoMergeIfPossible } from './actions/autoMergeIfPossible';\nimport { updateBranch } from './actions/updateBranch';\nimport { updatePrCommentBodyOptions } from './actions/updatePrCommentBody';\nimport { updateStatusCheckFromLabels } from './actions/updateStatusCheckFromLabels';\nimport hasLabelInPR from './actions/utils/hasLabelInPR';\nimport { createPullRequestHandler } from './utils/createPullRequestHandler';\nimport { fetchPr } from './utils/fetchPr';\n\nconst isFromRenovate = (\n  payload: EventPayloads.WebhookPayloadPullRequest,\n): boolean => {\n  const sender = payload.sender;\n  return (\n    sender.type === 'Bot' &&\n    sender.login === 'renovate[bot]' &&\n    payload.pull_request.head.ref.startsWith('renovate/')\n  );\n};\n\nexport default function labelsChanged(\n  app: Probot,\n  appContext: AppContext,\n): void {\n  app.on(\n    ['pull_request.labeled', 'pull_request.unlabeled'],\n    createPullRequestHandler<\n      EventPayloads.WebhookPayloadPullRequest,\n      EventPayloads.WebhookPayloadPullRequest['pull_request']\n    >(\n      appContext,\n      (payload, context, repoContext) => {\n        if (payload.sender.type === 'Bot' && !isFromRenovate(payload)) {\n          return null;\n        }\n\n        if (repoContext.shouldIgnore) return null;\n\n        return payload.pull_request;\n      },\n      async (pullRequest, context, repoContext, reviewflowPrContext) => {\n        if (reviewflowPrContext === null) return;\n\n        const fromRenovate = isFromRenovate(context.payload);\n        const updatedPr = await fetchPr(context, pullRequest.number);\n\n        const label = (context.payload as any).label;\n        if (fromRenovate) {\n          const codeApprovedLabel = repoContext.labels['code/approved'];\n          const autoMergeLabel = repoContext.labels['merge/automerge'];\n          const autoMergeSkipCiLabel = repoContext.labels['merge/skip-ci'];\n          if (context.payload.action === 'labeled') {\n            if (codeApprovedLabel && label.id === codeApprovedLabel.id) {\n              // const { data: reviews } = await context.octokit.pulls.listReviews(\n              //   context.pullRequest({ per_page: 1 }),\n              // );\n              // if (reviews.length !== 0) {\n              await context.octokit.pulls.createReview(\n                context.pullRequest({ event: 'APPROVE' }),\n              );\n\n              let labels = updatedPr.labels;\n              const autoMergeWithSkipCi =\n                autoMergeSkipCiLabel &&\n                repoContext.config.autoMergeRenovateWithSkipCi;\n              if (autoMergeWithSkipCi) {\n                const result = await context.octokit.issues.addLabels(\n                  context.issue({\n                    labels: [autoMergeSkipCiLabel.name],\n                  }),\n                );\n                labels = result.data;\n              }\n              await updateStatusCheckFromLabels(\n                updatedPr,\n                context,\n                repoContext,\n                labels,\n              );\n              await updatePrCommentBodyOptions(\n                context,\n                repoContext,\n                reviewflowPrContext,\n                {\n                  autoMergeWithSkipCi,\n                  // force label to avoid racing events (when both events are sent in the same time, reviewflow treats them one by one but the second event wont have its body updated)\n                  autoMerge: hasLabelInPR(labels, autoMergeLabel)\n                    ? true\n                    : repoContext.config.prDefaultOptions.autoMerge,\n                },\n              );\n              // }\n            } else if (autoMergeLabel && label.id === autoMergeLabel.id) {\n              await updatePrCommentBodyOptions(\n                context,\n                repoContext,\n                reviewflowPrContext,\n                {\n                  autoMerge: true,\n                  // force label to avoid racing events (when both events are sent in the same time, reviewflow treats them one by one but the second event wont have its body updated)\n                  // Note: si c'est renovate qui ajoute le label autoMerge, le label codeApprovedLabel n'aurait pu etre ajout que par renovate galement (on est a quelques secondes de l'ouverture de la pr par renovate)\n                  autoMergeWithSkipCi: hasLabelInPR(\n                    pullRequest.labels,\n                    codeApprovedLabel,\n                  )\n                    ? true\n                    : repoContext.config.prDefaultOptions.autoMergeWithSkipCi,\n                },\n              );\n            }\n            await autoMergeIfPossible(\n              updatedPr,\n              context,\n              repoContext,\n              reviewflowPrContext,\n            );\n          }\n          return;\n        }\n\n        if (repoContext.protectedLabelIds.includes(label.id)) {\n          if (context.payload.action === 'labeled') {\n            await context.octokit.issues.removeLabel(\n              context.issue({ name: label.name }),\n            );\n          } else {\n            await context.octokit.issues.addLabels(\n              context.issue({ labels: [label.name] }),\n            );\n          }\n          return;\n        }\n\n        await updateStatusCheckFromLabels(updatedPr, context, repoContext);\n\n        const updateBranchLabel = repoContext.labels['merge/update-branch'];\n        const featureBranchLabel = repoContext.labels['feature-branch'];\n        const automergeLabel = repoContext.labels['merge/automerge'];\n        const skipCiLabel = repoContext.labels['merge/skip-ci'];\n\n        const option = (() => {\n          if (featureBranchLabel && label.id === featureBranchLabel.id) {\n            return 'featureBranch';\n          }\n          if (automergeLabel && label.id === automergeLabel.id) {\n            return 'autoMerge';\n          }\n          if (skipCiLabel && label.id === skipCiLabel.id) {\n            return 'autoMergeWithSkipCi';\n          }\n          return null;\n        })();\n\n        if (option) {\n          await updatePrCommentBodyOptions(\n            context,\n            repoContext,\n            reviewflowPrContext,\n            {\n              [option]: context.payload.action === 'labeled',\n            },\n          );\n        } // not an else if\n        if (automergeLabel && label.id === automergeLabel.id) {\n          if (context.payload.action === 'labeled') {\n            await autoMergeIfPossible(\n              updatedPr,\n              context,\n              repoContext,\n              reviewflowPrContext,\n            );\n          } else {\n            repoContext.removePrFromAutomergeQueue(\n              context,\n              pullRequest.number,\n              'automerge label removed',\n            );\n          }\n        }\n        if (updateBranchLabel && label.id === updateBranchLabel.id) {\n          if (context.payload.action === 'labeled') {\n            await updateBranch(\n              updatedPr,\n              context,\n              context.payload.sender.login,\n            );\n            await context.octokit.issues.removeLabel(\n              context.issue({ name: label.name }),\n            );\n          }\n        }\n      },\n    ),\n  );\n}\n","import type { Context } from 'probot';\nimport type { RepoContext } from 'context/repoContext';\nimport type { PullRequestFromRestEndpoint } from '../utils/PullRequestData';\nimport type { ReviewflowPrContext } from '../utils/createPullRequestContext';\nimport { autoMergeIfPossible } from './autoMergeIfPossible';\nimport hasLabelInPR from './utils/hasLabelInPR';\n\nexport const autoApproveAndAutoMerge = async (\n  pullRequest: PullRequestFromRestEndpoint,\n  context: Context<any>,\n  repoContext: RepoContext,\n  reviewflowPrContext: ReviewflowPrContext,\n): Promise<boolean> => {\n  // const autoMergeLabel = repoContext.labels['merge/automerge'];\n  const codeApprovedLabel = repoContext.labels['code/approved'];\n  if (hasLabelInPR(pullRequest.labels, codeApprovedLabel)) {\n    await context.octokit.pulls.createReview(\n      context.pullRequest({ event: 'APPROVE' }),\n    );\n    await autoMergeIfPossible(\n      pullRequest,\n      context,\n      repoContext,\n      reviewflowPrContext,\n    );\n    return true;\n  }\n\n  return false;\n};\n","import type { EventPayloads } from '@octokit/webhooks';\nimport type { Context } from 'probot';\nimport type { RepoContext } from 'context/repoContext';\nimport type { PullRequestFromRestEndpoint } from '../utils/PullRequestData';\n\nexport const autoAssignPRToCreator = async <\n  E extends EventPayloads.WebhookPayloadPullRequest\n>(\n  pullRequest: E['pull_request'] | PullRequestFromRestEndpoint,\n  context: Context<E>,\n  repoContext: RepoContext,\n): Promise<void> => {\n  if (!repoContext.config.autoAssignToCreator) return;\n  if (pullRequest.assignees.length > 0) return;\n  if (pullRequest.user.type === 'Bot') return;\n\n  await context.octokit.issues.addAssignees(\n    context.issue({\n      assignees: [pullRequest.user.login],\n    }),\n  );\n};\n","import type { Probot } from 'probot';\nimport type { AppContext } from 'context/AppContext';\nimport { autoApproveAndAutoMerge } from './actions/autoApproveAndAutoMerge';\nimport { autoAssignPRToCreator } from './actions/autoAssignPRToCreator';\nimport { editOpenedPR } from './actions/editOpenedPR';\nimport { updateReviewStatus } from './actions/updateReviewStatus';\nimport { defaultCommentBody } from './actions/utils/body/updateBody';\nimport { createPullRequestHandler } from './utils/createPullRequestHandler';\nimport { fetchPr } from './utils/fetchPr';\nimport { createReviewflowComment } from './utils/reviewflowComment';\n\nexport default function opened(app: Probot, appContext: AppContext): void {\n  app.on(\n    'pull_request.opened',\n    createPullRequestHandler(\n      appContext,\n      (payload, context, repoContext) => {\n        if (repoContext.shouldIgnore) return null;\n        return payload.pull_request;\n      },\n      async (pullRequest, context, repoContext, reviewflowPrContext) => {\n        const fromRenovate = pullRequest.head.ref.startsWith('renovate/');\n        if (reviewflowPrContext === null) return;\n\n        await Promise.all<unknown>([\n          autoAssignPRToCreator(pullRequest, context, repoContext),\n          editOpenedPR(\n            pullRequest,\n            context,\n            repoContext,\n            reviewflowPrContext,\n            true,\n          ),\n          fromRenovate\n            ? fetchPr(context, pullRequest.number).then((updatedPr) =>\n                autoApproveAndAutoMerge(\n                  updatedPr,\n                  context,\n                  repoContext,\n                  reviewflowPrContext,\n                ).then(\n                  async (approved: boolean): Promise<void> => {\n                    if (!approved && repoContext.config.requiresReviewRequest) {\n                      await updateReviewStatus(\n                        pullRequest,\n                        context,\n                        repoContext,\n                        'dev',\n                        {\n                          add: ['needsReview'],\n                        },\n                      );\n                    }\n                  },\n                ),\n              )\n            : updateReviewStatus(pullRequest, context, repoContext, 'dev', {\n                add: repoContext.config.requiresReviewRequest\n                  ? ['needsReview']\n                  : [],\n                remove: ['approved', 'changesRequested'],\n              }),\n        ]);\n      },\n      (pullRequest, context, repoContext) => {\n        return {\n          reviewflowCommentPromise: createReviewflowComment(\n            pullRequest.number,\n            context,\n            defaultCommentBody,\n          ),\n        };\n      },\n    ),\n  );\n}\n","import type { Probot } from 'probot';\nimport type { AppContext } from '../../context/AppContext';\nimport { editOpenedPR } from './actions/editOpenedPR';\nimport { updateReviewStatus } from './actions/updateReviewStatus';\nimport { createPullRequestHandler } from './utils/createPullRequestHandler';\n\nexport default function closed(app: Probot, appContext: AppContext): void {\n  app.on(\n    'pull_request.reopened',\n    createPullRequestHandler(\n      appContext,\n      (payload, context, repoContext) => {\n        if (repoContext.shouldIgnore) return null;\n        return payload.pull_request;\n      },\n      async (\n        pullRequest,\n        context,\n        repoContext,\n        reviewflowPrContext,\n      ): Promise<void> => {\n        await Promise.all([\n          updateReviewStatus(pullRequest, context, repoContext, 'dev', {\n            add: ['needsReview'],\n            remove: ['approved'],\n          }),\n          editOpenedPR(\n            pullRequest,\n            context,\n            repoContext,\n            reviewflowPrContext,\n            true,\n          ),\n        ]);\n      },\n    ),\n  );\n}\n","import type { Probot } from 'probot';\nimport type { AppContext } from '../../context/AppContext';\nimport * as slackUtils from '../../slack/utils';\nimport { updateReviewStatus } from './actions/updateReviewStatus';\nimport { createPullRequestHandler } from './utils/createPullRequestHandler';\nimport { fetchPr } from './utils/fetchPr';\nimport { getReviewersAndReviewStates } from './utils/getReviewersAndReviewStates';\n\nexport default function reviewDismissed(\n  app: Probot,\n  appContext: AppContext,\n): void {\n  app.on(\n    'pull_request_review.dismissed',\n    createPullRequestHandler(\n      appContext,\n      (payload) => payload.pull_request,\n      async (\n        pullRequest,\n        context,\n        repoContext,\n        reviewflowPrContext,\n      ): Promise<void> => {\n        const sender = context.payload.sender;\n        const reviewer = (context.payload as any).review.user;\n        const reviewerGroup = repoContext.getReviewerGroup(reviewer.login);\n\n        if (\n          !repoContext.shouldIgnore &&\n          reviewerGroup &&\n          repoContext.config.labels.review[reviewerGroup]\n        ) {\n          const updatedPr = await fetchPr(context, pullRequest.number);\n\n          const { reviewStates } = await getReviewersAndReviewStates(\n            context,\n            repoContext,\n          );\n          const hasChangesRequestedInReviews =\n            reviewStates[reviewerGroup].changesRequested !== 0;\n          const hasApprovals = reviewStates[reviewerGroup].approved !== 0;\n          const hasRequestedReviewsForGroup = repoContext.approveShouldWait(\n            reviewerGroup,\n            updatedPr.requested_reviewers,\n            { includesReviewerGroup: true },\n          );\n\n          await updateReviewStatus(\n            updatedPr,\n            context,\n            repoContext,\n            reviewerGroup,\n            {\n              add: [\n                !hasApprovals && 'needsReview',\n                hasApprovals &&\n                  !hasRequestedReviewsForGroup &&\n                  !hasChangesRequestedInReviews &&\n                  'approved',\n              ],\n              remove: [\n                !hasRequestedReviewsForGroup &&\n                  !hasChangesRequestedInReviews &&\n                  'requested',\n                !hasChangesRequestedInReviews && 'changesRequested',\n                !hasApprovals && 'approved',\n              ],\n            },\n          );\n\n          if (updatedPr.assignees) {\n            updatedPr.assignees.forEach((assignee) => {\n              repoContext.slack.updateHome(assignee.login);\n            });\n          }\n          if (\n            !updatedPr.assignees.find(\n              (assignee) => assignee.login === reviewer.login,\n            )\n          ) {\n            repoContext.slack.updateHome(reviewer.login);\n          }\n        }\n\n        if (repoContext.slack) {\n          if (sender.login === reviewer.login) {\n            pullRequest.assignees.forEach((assignee) => {\n              repoContext.slack.postMessage(\n                'pr-review',\n                assignee.id,\n                assignee.login,\n                {\n                  text: `:skull: ${repoContext.slack.mention(\n                    reviewer.login,\n                  )} dismissed his review on ${slackUtils.createPrLink(\n                    pullRequest,\n                    repoContext,\n                  )}`,\n                },\n              );\n            });\n          } else {\n            repoContext.slack.postMessage(\n              'pr-review',\n              reviewer.id,\n              reviewer.login,\n              {\n                text: `:skull: ${repoContext.slack.mention(\n                  sender.login,\n                )} dismissed your review on ${slackUtils.createPrLink(\n                  pullRequest,\n                  repoContext,\n                )}`,\n              },\n            );\n          }\n        }\n      },\n    ),\n  );\n}\n","import type { Probot } from 'probot';\nimport type { AppContext } from '../../context/AppContext';\nimport * as slackUtils from '../../slack/utils';\nimport { updateReviewStatus } from './actions/updateReviewStatus';\nimport { createPullRequestHandler } from './utils/createPullRequestHandler';\nimport { getReviewersAndReviewStates } from './utils/getReviewersAndReviewStates';\n\nexport default function reviewRequestRemoved(\n  app: Probot,\n  appContext: AppContext,\n): void {\n  app.on(\n    'pull_request.review_request_removed',\n    createPullRequestHandler(\n      appContext,\n      (payload) => payload.pull_request,\n      async (\n        pullRequest,\n        context,\n        repoContext,\n        reviewflowPrContext,\n      ): Promise<void> => {\n        const sender = context.payload.sender;\n        const reviewer = (context.payload as any).requested_reviewer;\n\n        const reviewerGroup = repoContext.getReviewerGroup(reviewer.login);\n\n        if (\n          !repoContext.shouldIgnore &&\n          reviewerGroup &&\n          repoContext.config.labels.review[reviewerGroup]\n        ) {\n          const hasRequestedReviewsForGroup = repoContext.approveShouldWait(\n            reviewerGroup,\n            pullRequest.requested_reviewers,\n            {\n              includesReviewerGroup: true,\n            },\n          );\n\n          const { reviewStates } = await getReviewersAndReviewStates(\n            context,\n            repoContext,\n          );\n\n          const hasChangesRequestedInReviews =\n            reviewStates[reviewerGroup].changesRequested !== 0;\n\n          const hasApprovedInReviews =\n            reviewStates[reviewerGroup].approved !== 0;\n\n          const approved =\n            !hasRequestedReviewsForGroup &&\n            !hasChangesRequestedInReviews &&\n            hasApprovedInReviews;\n\n          await updateReviewStatus(\n            pullRequest,\n            context,\n            repoContext,\n            reviewerGroup,\n            {\n              add: [\n                // if changes requested by the one which requests was removed (should still be in changed requested anyway, but we never know)\n                hasChangesRequestedInReviews && 'changesRequested',\n                // if was already approved by another member in the group and has no other requests waiting\n                approved && 'approved',\n              ],\n              // remove labels if has no other requests waiting\n              remove: [\n                approved && 'needsReview',\n                !hasRequestedReviewsForGroup && 'requested',\n              ],\n            },\n          );\n\n          if (pullRequest.assignees) {\n            pullRequest.assignees.forEach((assignee) => {\n              repoContext.slack.updateHome(assignee.login);\n            });\n          }\n          if (\n            !pullRequest.assignees.find(\n              (assignee) => assignee.login === reviewer.login,\n            )\n          ) {\n            repoContext.slack.updateHome(reviewer.login);\n          }\n        }\n\n        if (sender.login === reviewer.login) return;\n\n        repoContext.slack.postMessage(\n          'pr-review',\n          reviewer.id,\n          reviewer.login,\n          {\n            text: `:skull_and_crossbones: ${repoContext.slack.mention(\n              sender.login,\n            )} removed the request for your review on ${slackUtils.createPrLink(\n              pullRequest,\n              repoContext,\n            )}`,\n          },\n        );\n\n        const sentMessageRequestedReview = await appContext.mongoStores.slackSentMessages.findOne(\n          {\n            'account.id': repoContext.account._id,\n            'account.type': repoContext.accountType,\n            type: 'review-requested',\n            typeId: `${pullRequest.id}_${reviewer.id}`,\n          },\n        );\n\n        if (sentMessageRequestedReview) {\n          const sentTo = sentMessageRequestedReview.sentTo[0];\n          const message = sentMessageRequestedReview.message;\n          await Promise.all([\n            repoContext.slack.updateMessage(sentTo.ts, sentTo.channel, {\n              ...message,\n              text: message.text\n                .split('\\n')\n                .map((l) => `~${l}~`)\n                .join('\\n'),\n            }),\n            repoContext.slack.addReaction(\n              sentTo.ts,\n              sentTo.channel,\n              'skull_and_crossbones',\n            ),\n            appContext.mongoStores.slackSentMessages.deleteOne(\n              sentMessageRequestedReview,\n            ),\n          ]);\n        }\n      },\n    ),\n  );\n}\n","import type { Probot } from 'probot';\nimport type { AppContext } from '../../context/AppContext';\nimport * as slackUtils from '../../slack/utils';\nimport { updateReviewStatus } from './actions/updateReviewStatus';\nimport { createPullRequestHandler } from './utils/createPullRequestHandler';\n\nexport default function reviewRequested(\n  app: Probot,\n  appContext: AppContext,\n): void {\n  app.on(\n    'pull_request.review_requested',\n    createPullRequestHandler(\n      appContext,\n      (payload) => payload.pull_request,\n      async (\n        pullRequest,\n        context,\n        repoContext,\n        reviewflowPrContext,\n      ): Promise<void> => {\n        const sender = context.payload.sender;\n\n        const reviewer = (context.payload as any).requested_reviewer;\n\n        const reviewerGroup = repoContext.getReviewerGroup(reviewer.login);\n        const shouldWait = false;\n        // repoContext.approveShouldWait(reviewerGroup, pr.requested_reviewers, { includesWaitForGroups: true });\n\n        if (\n          !repoContext.shouldIgnore &&\n          reviewerGroup &&\n          repoContext.config.labels.review[reviewerGroup]\n        ) {\n          await updateReviewStatus(\n            pullRequest,\n            context,\n            repoContext,\n            reviewerGroup,\n            {\n              add: ['needsReview', !shouldWait && 'requested'],\n              remove: ['approved'],\n            },\n          );\n\n          if (pullRequest.assignees) {\n            pullRequest.assignees.forEach((assignee) => {\n              repoContext.slack.updateHome(assignee.login);\n            });\n          }\n          if (\n            !pullRequest.assignees.find(\n              (assignee) => assignee.login === reviewer.login,\n            )\n          ) {\n            repoContext.slack.updateHome(reviewer.login);\n          }\n        }\n\n        if (sender.login === reviewer.login) return;\n\n        if (!shouldWait && repoContext.slack) {\n          const text = `:eyes: ${repoContext.slack.mention(\n            sender.login,\n          )} requests your review on ${slackUtils.createPrLink(\n            pullRequest,\n            repoContext,\n          )} !\\n> ${pullRequest.title}`;\n          const message = { text };\n          const result = await repoContext.slack.postMessage(\n            'pr-review',\n            reviewer.id,\n            reviewer.login,\n            message,\n          );\n          if (result) {\n            await appContext.mongoStores.slackSentMessages.insertOne({\n              type: 'review-requested',\n              typeId: `${pullRequest.id}_${reviewer.id}`,\n              message,\n              account: repoContext.accountEmbed,\n              sentTo: [result],\n            });\n          }\n        }\n      },\n    ),\n  );\n}\n","import type { Probot } from 'probot';\nimport slackifyMarkdown from 'slackify-markdown';\nimport type { AppContext } from '../../context/AppContext';\nimport * as slackUtils from '../../slack/utils';\nimport { autoMergeIfPossible } from './actions/autoMergeIfPossible';\nimport { updateReviewStatus } from './actions/updateReviewStatus';\nimport { createPullRequestHandler } from './utils/createPullRequestHandler';\nimport { createSlackMessageWithSecondaryBlock } from './utils/createSlackMessageWithSecondaryBlock';\nimport { fetchPr } from './utils/fetchPr';\nimport { getReviewersAndReviewStates } from './utils/getReviewersAndReviewStates';\n\nconst getEmojiFromState = (state: string): string => {\n  switch (state) {\n    case 'changes_requested':\n      return 'x';\n    case 'approved':\n      return 'white_check_mark';\n    default:\n      return 'speech_balloon';\n  }\n};\n\nexport default function reviewSubmitted(\n  app: Probot,\n  appContext: AppContext,\n): void {\n  app.on(\n    'pull_request_review.submitted',\n    createPullRequestHandler(\n      appContext,\n      (payload) => payload.pull_request,\n      async (\n        pullRequest,\n        context,\n        repoContext,\n        reviewflowPrContext,\n      ): Promise<void> => {\n        const { payload } = context;\n\n        const {\n          user: reviewer,\n          state,\n          body,\n          html_url: reviewUrl,\n        } = payload.review;\n\n        const reviewByOwner = pullRequest.user.login === reviewer.login;\n        const { reviewers, reviewStates } = await getReviewersAndReviewStates(\n          context,\n          repoContext,\n        );\n        const followers = reviewers.filter(\n          (user) => user.id !== reviewer.id && user.id !== pullRequest.user.id,\n        );\n\n        if (pullRequest.requested_reviewers) {\n          followers.push(\n            ...pullRequest.requested_reviewers.filter((rr) => {\n              return (\n                !followers.find((f) => f.id === rr.id) &&\n                rr.id !== reviewer.id &&\n                rr.id !== pullRequest.user.id\n              );\n            }),\n          );\n        }\n\n        if (!reviewByOwner) {\n          const reviewerGroup = repoContext.getReviewerGroup(reviewer.login);\n          let merged: boolean;\n\n          if (\n            reviewflowPrContext &&\n            !repoContext.shouldIgnore &&\n            reviewerGroup &&\n            repoContext.config.labels.review[reviewerGroup]\n          ) {\n            const hasRequestedReviewsForGroup = repoContext.approveShouldWait(\n              reviewerGroup,\n              pullRequest.requested_reviewers,\n              {\n                includesReviewerGroup: true,\n                // TODO reenable this when accepted can notify request review to slack (dev accepted => design requested) and flag to disable for label (approved design ; still waiting for dev ?)\n                // includesWaitForGroups: true,\n              },\n            );\n\n            const hasChangesRequestedInReviews =\n              reviewStates[reviewerGroup].changesRequested !== 0;\n\n            const approved =\n              !hasRequestedReviewsForGroup &&\n              !hasChangesRequestedInReviews &&\n              state === 'approved';\n\n            const updatedPr = await fetchPr(context, pullRequest.number);\n\n            const newLabels = await updateReviewStatus(\n              updatedPr,\n              context,\n              repoContext,\n              reviewerGroup,\n              {\n                add: [\n                  approved && 'approved',\n                  state === 'changes_requested' && 'needsReview',\n                  state === 'changes_requested' && 'changesRequested',\n                ],\n                remove: [\n                  approved && 'needsReview',\n                  !hasRequestedReviewsForGroup && 'requested',\n                  state === 'approved' &&\n                    !hasChangesRequestedInReviews &&\n                    'changesRequested',\n                  state === 'changes_requested' && 'approved',\n                ],\n              },\n            );\n\n            if (approved && !hasChangesRequestedInReviews) {\n              merged = await autoMergeIfPossible(\n                updatedPr,\n                context,\n                repoContext,\n                reviewflowPrContext,\n                newLabels,\n              );\n            }\n          }\n\n          if (pullRequest.assignees) {\n            pullRequest.assignees.forEach((assignee) => {\n              repoContext.slack.updateHome(assignee.login);\n            });\n          }\n          if (\n            !pullRequest.assignees.find(\n              (assignee) => assignee.login === reviewer.login,\n            )\n          ) {\n            repoContext.slack.updateHome(reviewer.login);\n          }\n\n          const sentMessageRequestedReview = await appContext.mongoStores.slackSentMessages.findOne(\n            {\n              'account.id': repoContext.account._id,\n              'account.type': repoContext.accountType,\n              type: 'review-requested',\n              typeId: `${pullRequest.id}_${reviewer.id}`,\n            },\n          );\n\n          const emoji = getEmojiFromState(state);\n\n          if (sentMessageRequestedReview) {\n            const sentTo = sentMessageRequestedReview.sentTo[0];\n            const message = sentMessageRequestedReview.message;\n            await Promise.all([\n              repoContext.slack.updateMessage(sentTo.ts, sentTo.channel, {\n                ...message,\n                text: message.text\n                  .split('\\n')\n                  .map((l) => `~${l}~`)\n                  .join('\\n'),\n              }),\n              repoContext.slack.addReaction(sentTo.ts, sentTo.channel, emoji),\n              appContext.mongoStores.slackSentMessages.deleteOne(\n                sentMessageRequestedReview,\n              ),\n            ]);\n          }\n\n          if (!body && state !== 'changes_requested' && state !== 'approved') {\n            return;\n          }\n\n          const mention = repoContext.slack.mention(reviewer.login);\n          const prUrl = slackUtils.createPrLink(pullRequest, repoContext);\n          const ownerMention = repoContext.slack.mention(\n            pullRequest.user.login,\n          );\n\n          const createMessage = (toOwner?: boolean): string => {\n            const ownerPart = toOwner ? 'your PR' : `${ownerMention}'s PR`;\n\n            if (state === 'changes_requested') {\n              return `:${emoji}: ${mention} requests changes on ${ownerPart} ${prUrl}`;\n            }\n            if (state === 'approved') {\n              return `${\n                toOwner ? ':clap: ' : ''\n              }:${emoji}: ${mention} approves ${ownerPart} ${prUrl}${\n                merged ? ' and PR is merged :tada:' : ''\n              }`;\n            }\n\n            const commentLink = slackUtils.createLink(reviewUrl, 'commented');\n            return `:${emoji}: ${mention} ${commentLink} on ${ownerPart} ${prUrl}`;\n          };\n\n          const slackifiedBody = slackifyMarkdown((body as unknown) as string);\n\n          repoContext.slack.postMessage(\n            'pr-review',\n            pullRequest.user.id,\n            pullRequest.user.login,\n            createSlackMessageWithSecondaryBlock(\n              createMessage(true),\n              slackifiedBody,\n            ),\n          );\n\n          const message = createSlackMessageWithSecondaryBlock(\n            createMessage(false),\n            slackifiedBody,\n          );\n\n          followers.forEach((follower) => {\n            repoContext.slack.postMessage(\n              'pr-review-follow',\n              follower.id,\n              follower.login,\n              message,\n            );\n          });\n        } else if (body) {\n          const mention = repoContext.slack.mention(reviewer.login);\n          const prUrl = slackUtils.createPrLink(pullRequest, repoContext);\n          const commentLink = slackUtils.createLink(reviewUrl, 'commented');\n\n          const message = createSlackMessageWithSecondaryBlock(\n            `:speech_balloon: ${mention} ${commentLink} on his PR ${prUrl}`,\n            body,\n          );\n\n          followers.forEach((follower) => {\n            repoContext.slack.postMessage(\n              'pr-review-follow',\n              follower.id,\n              follower.login,\n              message,\n            );\n          });\n        }\n      },\n    ),\n  );\n}\n","import type { EventPayloads } from '@octokit/webhooks';\nimport type { Probot, Context } from 'probot';\nimport type { AppContext } from '../../context/AppContext';\nimport type { LockedMergePr } from '../../context/repoContext';\nimport { createPullRequestsHandler } from './utils/createPullRequestHandler';\n\nconst isSameBranch = (\n  payload: Context<EventPayloads.WebhookPayloadStatus>['payload'],\n  lockedPr: LockedMergePr,\n): boolean => {\n  if (!lockedPr) return false;\n  return !!payload.branches.find((b) => b.name === lockedPr.branch);\n};\n\nexport default function status(app: Probot, appContext: AppContext): void {\n  app.on(\n    'status',\n    createPullRequestsHandler(\n      appContext,\n      (payload, repoContext): LockedMergePr[] => {\n        if (repoContext.shouldIgnore) return [];\n\n        const lockedPr = repoContext.getMergeLockedPr();\n        if (!lockedPr) return [];\n\n        if (payload.state !== 'loading' && isSameBranch(payload, lockedPr)) {\n          return [lockedPr];\n        }\n\n        return [];\n      },\n      (pr, context, repoContext): void => {\n        const lockedPr = repoContext.getMergeLockedPr();\n        // check if changed\n        if (isSameBranch(context.payload, lockedPr)) {\n          repoContext.reschedule(context, lockedPr);\n        }\n      },\n    ),\n  );\n}\n","import type { Probot } from 'probot';\nimport type { AppContext } from '../../context/AppContext';\nimport { autoMergeIfPossible } from './actions/autoMergeIfPossible';\nimport { editOpenedPR } from './actions/editOpenedPR';\nimport { updateStatusCheckFromLabels } from './actions/updateStatusCheckFromLabels';\nimport { createPullRequestHandler } from './utils/createPullRequestHandler';\nimport { fetchPr } from './utils/fetchPr';\n\nexport default function synchronize(app: Probot, appContext: AppContext): void {\n  app.on(\n    'pull_request.synchronize',\n    createPullRequestHandler(\n      appContext,\n      (payload, context, repoContext) => {\n        if (repoContext.shouldIgnore) return null;\n        return payload.pull_request;\n      },\n      async (\n        pullRequest,\n        context,\n        repoContext,\n        reviewflowPrContext,\n      ): Promise<void> => {\n        if (!reviewflowPrContext) return;\n\n        const updatedPr = await fetchPr(context, pullRequest.number);\n        // old and new sha\n        // const { before, after } = context.payload;\n        const previousSha = (context.payload as any).before as string;\n\n        await Promise.all([\n          editOpenedPR(\n            updatedPr,\n            context,\n            repoContext,\n            reviewflowPrContext,\n            true,\n            previousSha,\n          ),\n          // addStatusCheckToLatestCommit\n          updateStatusCheckFromLabels(\n            updatedPr,\n            context,\n            repoContext,\n            updatedPr.labels,\n            previousSha,\n          ),\n        ]);\n\n        // call autoMergeIfPossible to re-add to the queue when push is fixed\n        await autoMergeIfPossible(\n          updatedPr,\n          context,\n          repoContext,\n          reviewflowPrContext,\n        );\n      },\n    ),\n  );\n}\n","import type { Probot } from 'probot';\nimport type { AppContext } from '../../context/AppContext';\nimport { obtainRepoContext } from '../../context/repoContext';\nimport { getEmojiFromRepoDescription } from '../../context/utils';\nimport { createHandlerOrgChange } from '../account-handlers/utils/handler';\n\nexport default function repoEdited(app: Probot, appContext: AppContext): void {\n  app.on(\n    'repository.edited',\n    createHandlerOrgChange(\n      appContext,\n      async (context, orgContext): Promise<void> => {\n        const repoContext = await obtainRepoContext(appContext, context);\n        if (!repoContext) return;\n        const repo = context.payload.repository;\n        repoContext.repoFullName = repo.full_name;\n        repoContext.repoEmoji = getEmojiFromRepoDescription(repo.description);\n      },\n    ),\n  );\n}\n","import type { EventPayloads } from '@octokit/webhooks';\nimport type { Probot } from 'probot';\n// import commands from 'probot-commands';\nimport type { AppContext } from './context/AppContext';\nimport { syncOrg } from './events/account-handlers/actions/syncOrg';\nimport { syncTeams } from './events/account-handlers/actions/syncTeams';\nimport { createHandlerOrgChange } from './events/account-handlers/utils/handler';\nimport checkrunCompleted from './events/pr-handlers/checkrunCompleted';\nimport checksuiteCompleted from './events/pr-handlers/checksuiteCompleted';\nimport closedHandler from './events/pr-handlers/closed';\nimport commentCreated from './events/pr-handlers/commentCreated';\nimport commentEditedOrDeleted from './events/pr-handlers/commentEditedOrDeleted';\nimport editedHandler from './events/pr-handlers/edited';\nimport labelsChanged from './events/pr-handlers/labelsChanged';\nimport openedHandler from './events/pr-handlers/opened';\nimport reopenedHandler from './events/pr-handlers/reopened';\nimport reviewDismissedHandler from './events/pr-handlers/reviewDismissed';\nimport reviewRequestRemovedHandler from './events/pr-handlers/reviewRequestRemoved';\nimport reviewRequestedHandler from './events/pr-handlers/reviewRequested';\nimport reviewSubmittedHandler from './events/pr-handlers/reviewSubmitted';\nimport status from './events/pr-handlers/status';\nimport synchronizeHandler from './events/pr-handlers/synchronize';\nimport repoEdited from './events/repository-handlers/repoEdited';\n\nexport default function initApp(app: Probot, appContext: AppContext): void {\n  /* https://developer.github.com/webhooks/event-payloads/#organization */\n  app.on(\n    ['organization.member_added', 'organization.member_removed'],\n    createHandlerOrgChange<EventPayloads.WebhookPayloadOrganization>(\n      appContext,\n      async (context, accountContext) => {\n        await syncOrg(\n          appContext.mongoStores,\n          context.github,\n          accountContext.account.installationId as number,\n          context.payload.organization,\n        );\n      },\n    ),\n  );\n\n  /* https://developer.github.com/webhooks/event-payloads/#team */\n  app.on(\n    ['team.created', 'team.deleted', 'team.edited'],\n    createHandlerOrgChange<EventPayloads.WebhookPayloadTeam>(\n      appContext,\n      async (context, accountContext) => {\n        await syncTeams(\n          appContext.mongoStores,\n          context.github,\n          context.payload.organization,\n        );\n      },\n    ),\n  );\n\n  // /* https://developer.github.com/webhooks/event-payloads/#membership */\n  // app.on(\n  //   ['membership.added', 'membership.removed'],\n  //   createHandlerOrgChange<EventPayloads.WebhookPayloadMembership>(\n  //     mongoStores,\n  //     async (context, accountContext) => {\n  //       await syncTeamMembers(\n  //         mongoStores,\n  //         context.github,\n  //         context.payload.organization,\n  //         context.payload.team,\n  //       );\n  //     },\n  //   ),\n  // );\n\n  // Repo\n  /* https://developer.github.com/webhooks/event-payloads/#repository */\n  repoEdited(app, appContext);\n\n  // PR\n  /* https://developer.github.com/webhooks/event-payloads/#pull_request */\n  openedHandler(app, appContext);\n  editedHandler(app, appContext);\n  closedHandler(app, appContext);\n  reopenedHandler(app, appContext);\n\n  reviewRequestedHandler(app, appContext);\n  reviewRequestRemovedHandler(app, appContext);\n  reviewSubmittedHandler(app, appContext);\n  reviewDismissedHandler(app, appContext);\n  labelsChanged(app, appContext);\n  synchronizeHandler(app, appContext);\n\n  /* https://developer.github.com/webhooks/event-payloads/#pull_request_review_comment */\n  /* https://developer.github.com/webhooks/event-payloads/#issue_comment */\n  commentCreated(app, appContext);\n  commentEditedOrDeleted(app, appContext);\n\n  /* https://developer.github.com/webhooks/event-payloads/#check_run */\n  checkrunCompleted(app, appContext);\n\n  /* https://developer.github.com/webhooks/event-payloads/#check_suite */\n  checksuiteCompleted(app, appContext);\n\n  /* https://developer.github.com/webhooks/event-payloads/#status */\n  status(app, appContext);\n\n  /* commands */\n  // commands(app, 'update-branch', () => {});\n}\n","/* eslint-disable @typescript-eslint/no-floating-promises */\nimport type { MongoBaseModel } from 'liwi-mongo';\nimport { MongoStore, MongoConnection } from 'liwi-mongo';\nimport type { SlackMessage } from './context/SlackMessage';\nimport type { MessageCategory } from './dm/MessageCategory';\n\n// export interface PrEventsModel extends MongoModel {\n//   owner: string;\n//   repo: string;\n//   prId: string;\n//   prNumber: string;\n//   event: string;\n// }\n\nexport type AccountType = 'Organization' | 'User';\n\nexport interface AccountEmbed {\n  id: number;\n  login: string;\n  type: AccountType;\n}\n\ninterface RepoEmbed {\n  id: number;\n  name: string;\n}\n\ninterface PrEmbed {\n  number: number;\n}\n\ntype AccountEmbedWithoutType = Omit<AccountEmbed, 'type'>;\n\nexport interface UserDmSettings extends MongoBaseModel {\n  userId: number;\n  orgId: number;\n  settings: Record<MessageCategory, boolean>;\n}\n\n// TODO _id is number\ninterface BaseAccount extends MongoBaseModel<number> {\n  login: string;\n  installationId?: number;\n}\n\nexport interface User extends BaseAccount {\n  type: string;\n}\n\nexport interface Org extends BaseAccount {\n  slackToken?: string;\n}\n\nexport interface OrgMember extends MongoBaseModel {\n  org: AccountEmbedWithoutType;\n  user: AccountEmbedWithoutType;\n  slack?: { id: string };\n}\n\nexport interface OrgTeam extends MongoBaseModel<number> {\n  org: AccountEmbedWithoutType;\n  name: string;\n  slug: string;\n  description: string;\n}\n\nexport type SlackMessageType =\n  | 'review-comment'\n  | 'issue-comment'\n  | 'review-submitted'\n  | 'review-requested';\n\nexport interface SlackSentMessage extends MongoBaseModel {\n  type: SlackMessageType;\n  typeId: number | string;\n  account: AccountEmbed;\n  message: SlackMessage;\n  sentTo: {\n    channel: string;\n    ts: string;\n  }[];\n}\n\nexport interface AutomergeLog extends MongoBaseModel {\n  account: AccountEmbed;\n  repoFullName: string;\n  pr: {\n    id: number;\n    number: number;\n    isRenovate: boolean;\n    mergeableState: string;\n  };\n  type:\n    | 'rebase-renovate'\n    | 'unknown mergeable_state'\n    | 'blocked mergeable_state'\n    | 'behind mergeable_state'\n    | 'not mergeable'\n    | 'failed status or checks'\n    | 'already merged';\n  action: 'remove' | 'reschedule' | 'wait' | 'update branch';\n}\n\nexport interface ReviewflowPr extends MongoBaseModel {\n  account: AccountEmbed;\n  repo: RepoEmbed;\n  pr: PrEmbed;\n  commentId: number;\n}\n\nexport interface MongoStores {\n  connection: MongoConnection;\n  userDmSettings: MongoStore<UserDmSettings>;\n  users: MongoStore<User>;\n  orgs: MongoStore<Org>;\n  orgMembers: MongoStore<OrgMember>;\n  orgTeams: MongoStore<OrgTeam>;\n  slackSentMessages: MongoStore<SlackSentMessage>;\n  automergeLogs: MongoStore<AutomergeLog>;\n  prs: MongoStore<ReviewflowPr>;\n  // prEvents: MongoStore<PrEventsModel>;\n}\n\nif (!process.env.MONGO_DB) {\n  throw new Error('MONGO_DB is missing in process.env');\n}\n\nexport default function init(): MongoStores {\n  const config = new Map([\n    ['host', process.env.MONGO_HOST || 'localhost'],\n    ['port', process.env.MONGO_PORT || '27017'],\n    ['database', process.env.MONGO_DB as string],\n  ]);\n  if (process.env.MONGO_USER) {\n    config.set('user', process.env.MONGO_USER);\n    config.set('password', process.env.MONGO_PASSWORD as string);\n  }\n  const connection = new MongoConnection(config);\n\n  // const prEvents = new MongoStore<PrEventsModel>(connection, 'prEvents');\n  // prEvents.collection.then((coll) => {\n  //   coll.createIndex({ owner: 1, repo: 1, ???: 1 });\n  // });\n\n  const userDmSettings = new MongoStore<UserDmSettings>(\n    connection,\n    'userDmSettings',\n  );\n  userDmSettings.collection.then((coll) => {\n    coll.createIndex({ userId: 1, orgId: 1 }, { unique: true });\n  });\n\n  const users = new MongoStore<User>(connection, 'users');\n  users.collection.then((coll) => {\n    coll.createIndex({ login: 1 }, { unique: true });\n  });\n\n  const orgs = new MongoStore<Org>(connection, 'orgs');\n  orgs.collection.then((coll) => {\n    coll.createIndex({ login: 1 }, { unique: true });\n  });\n\n  const orgMembers = new MongoStore<OrgMember>(connection, 'orgMembers');\n  orgMembers.collection.then((coll) => {\n    coll.createIndex({ 'user.id': 1, 'org.id': 1 }, { unique: true });\n  });\n\n  const orgTeams = new MongoStore<OrgTeam>(connection, 'orgTeams');\n  orgTeams.collection.then((coll) => {\n    coll.createIndex({ 'org.id': 1 });\n  });\n\n  const slackSentMessages = new MongoStore<SlackSentMessage>(\n    connection,\n    'slackSentMessages',\n  );\n  slackSentMessages.collection.then((coll) => {\n    coll.createIndex({\n      'account.id': 1,\n      'account.type': 1,\n      type: 1,\n      typeId: 1,\n    });\n    // remove older than 14 days\n    coll.deleteMany({\n      created: { $lt: new Date(Date.now() - 14 * 24 * 60 * 60 * 1000) },\n    });\n  });\n\n  const automergeLogs = new MongoStore<AutomergeLog>(\n    connection,\n    'automergeLogs',\n  );\n  automergeLogs.collection.then((coll) => {\n    coll.createIndex({\n      repoFullName: 1,\n      type: 1,\n    });\n    coll.createIndex({\n      repoFullName: 1,\n      'pr.number': 1,\n    });\n    // remove older than 30 days\n    coll.deleteMany({\n      created: { $lt: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000) },\n    });\n  });\n\n  const prs = new MongoStore<ReviewflowPr>(connection, 'prs');\n  prs.collection.then((coll) => {\n    coll.createIndex(\n      {\n        'account.id': 1,\n        'repo.id': 1,\n        'pr.number': 1,\n      },\n      { unique: true },\n    );\n    // remove older than 12 * 30 days\n    coll.deleteMany({\n      created: { $lt: new Date(Date.now() - 12 * 30 * 24 * 60 * 60 * 1000) },\n    });\n  });\n\n  // return { connection, prEvents };\n  return {\n    connection,\n    userDmSettings,\n    users,\n    orgs,\n    orgMembers,\n    orgTeams,\n    slackSentMessages,\n    automergeLogs,\n    prs,\n  };\n}\n","import type { Octokit } from '@octokit/core';\nimport { WebClient } from '@slack/web-api';\nimport type { MongoStores, Org, OrgMember } from '../mongo';\nimport { createLink } from './utils';\n\ninterface QueueItem {\n  github: Octokit;\n  slackClient: WebClient;\n  member: OrgMember;\n}\n\nexport const createSlackHomeWorker = (mongoStores: MongoStores) => {\n  const updateMember = async (\n    github: Octokit,\n    slackClient: WebClient,\n    member: OrgMember,\n  ): Promise<void> => {\n    if (!member.slack?.id) return;\n    // console.log('update member', member.org.login, member.user.login);\n\n    /* search limit: 30 requests per minute = 7 update/min max */\n    const [\n      prsWithRequestedReviews,\n      prsToMerge,\n      prsWithRequestedChanges,\n      prsInDraft,\n    ] = await Promise.all([\n      github.search.issuesAndPullRequests({\n        q: `is:pr user:${member.org.login} is:open review-requested:${member.user.login} `,\n        sort: 'created',\n        order: 'desc',\n      }),\n      github.search.issuesAndPullRequests({\n        q: `is:pr user:${member.org.login} is:open assignee:${member.user.login} label:\":ok_hand: code/approved\"`,\n        sort: 'created',\n        order: 'desc',\n      }),\n      github.search.issuesAndPullRequests({\n        q: `is:pr user:${member.org.login} is:open assignee:${member.user.login} label:\":ok_hand: code/changes-requested\"`,\n        sort: 'created',\n        order: 'desc',\n      }),\n      github.search.issuesAndPullRequests({\n        q: `is:pr user:${member.org.login} is:open assignee:${member.user.login} draft:true`,\n        sort: 'created',\n        order: 'desc',\n        per_page: 5,\n      }),\n    ]);\n\n    const blocks: any[] = [];\n\n    const buildBlocks = (title: string, results: any) => {\n      if (!results.total_count) return;\n\n      blocks.push(\n        {\n          type: 'section',\n          text: {\n            type: 'mrkdwn',\n            text: `*${title}*`,\n          },\n        },\n        {\n          type: 'divider',\n        },\n        ...results.items\n          .map((pr: any) => {\n            const repoName = pr.repository_url.slice(\n              'https://api.github.com/repos/'.length,\n            );\n            const prFullName = `${repoName}#${pr.number}`;\n\n            return [\n              {\n                type: 'section',\n                text: {\n                  type: 'mrkdwn',\n                  text: `*${createLink(pr.html_url, pr.title)}*`,\n                  //  ${pr.labels.map((l) => `{${l.name}}`).join('  ')}\n                },\n              },\n              {\n                type: 'context',\n                elements: [\n                  {\n                    type: 'mrkdwn',\n                    text: `${createLink(pr.html_url, prFullName)} ${\n                      pr.draft ? ' _Draft_' : ''\n                    }`,\n                  },\n                  {\n                    type: 'image',\n                    image_url: pr.user.avatar_url,\n                    alt_text: pr.user.login,\n                  },\n                  {\n                    type: 'mrkdwn',\n                    text: `${pr.user.login}`,\n                  },\n                ],\n              },\n            ];\n          })\n          .flat(),\n        {\n          type: 'context',\n          elements: [\n            {\n              type: 'image',\n              image_url:\n                'https://api.slack.com/img/blocks/bkb_template_images/placeholder.png',\n              alt_text: 'placeholder',\n            },\n          ],\n        },\n      );\n    };\n\n    buildBlocks(':eyes: Requested Reviews', prsWithRequestedReviews.data);\n    buildBlocks(':white_check_mark: Ready to Merge', prsToMerge.data);\n    buildBlocks(':x: Changes Requested', prsWithRequestedChanges.data);\n    buildBlocks(':construction: Drafts', prsInDraft.data);\n\n    if (blocks.length === 0) {\n      blocks.push({\n        type: 'section',\n        text: {\n          type: 'mrkdwn',\n          text: \":tada: It looks like you don't have any PR to review!\",\n        },\n      });\n    }\n\n    slackClient.views.publish({\n      user_id: member.slack.id,\n      view: {\n        type: 'home',\n        blocks,\n      },\n    });\n  };\n\n  let workerInterval: ReturnType<typeof setInterval> | undefined;\n  const queueKeys = new Set<string>();\n  const queue: QueueItem[] = [];\n\n  const stop = (): void => {\n    if (workerInterval !== undefined) {\n      clearInterval(workerInterval);\n      workerInterval = undefined;\n    }\n  };\n\n  const start = (): void => {\n    if (workerInterval !== undefined) return;\n    workerInterval = setInterval(() => {\n      const item = queue.shift();\n      if (!item) {\n        stop();\n        return;\n      }\n\n      const { github, slackClient, member } = item;\n      const memberId = member.slack?.id;\n\n      const key = `${member.org.id}_${memberId}`;\n      queueKeys.delete(key);\n\n      updateMember(github, slackClient, member);\n    }, 9000); // 7/min 60s 1min = 1 ttes les 8.5s max\n  };\n\n  const scheduleUpdateMember = (\n    github: Octokit,\n    slackClient: WebClient,\n    member: OrgMember,\n  ): void => {\n    const memberId = member.slack?.id;\n    if (!memberId) return;\n\n    const key = `${member.org.id}_${memberId}`;\n\n    if (!queueKeys.has(key)) {\n      queueKeys.add(key);\n      queue.push({\n        github,\n        slackClient,\n        member,\n      });\n      start();\n    }\n  };\n\n  const scheduleUpdateOrg = async (\n    github: Octokit,\n    org: Org,\n    slackClient = new WebClient(org.slackToken),\n  ): Promise<void> => {\n    const cursor = await mongoStores.orgMembers.cursor();\n    cursor.forEach((member) => {\n      scheduleUpdateMember(github, slackClient, member);\n    });\n  };\n\n  const scheduleUpdateAllOrgs = async (\n    auth: (installationId: number) => Promise<Octokit>,\n  ): Promise<void> => {\n    const cursor = await mongoStores.orgs.cursor();\n    cursor.forEach(async (org) => {\n      if (!org.slackToken || !org.installationId) return;\n      const github = await auth(org.installationId);\n      await scheduleUpdateOrg(github, org);\n    });\n  };\n\n  return {\n    scheduleUpdateMember,\n    scheduleUpdateOrg,\n    scheduleUpdateAllOrgs,\n  };\n};\n","/* eslint-disable @typescript-eslint/no-floating-promises */\nimport 'dotenv/config';\nimport { run } from 'probot';\nimport appRouter from './appRouter';\nimport type { AppContext } from './context/AppContext';\nimport initApp from './initApp';\nimport mongoInit from './mongo';\nimport { createSlackHomeWorker } from './slack/home';\n\nif (!process.env.REVIEWFLOW_NAME) process.env.REVIEWFLOW_NAME = 'reviewflow';\nconsole.log({ name: process.env.REVIEWFLOW_NAME });\n\n// const getConfig = require('probot-config')\n// const { MongoClient } = require('mongodb');\n\n// const connect = MongoClient.connect(process.env.MONGO_URL);\n// const db = connect.then(client => client.db(process.env.MONGO_DB));\n\n// let config = await getConfig(context, 'reviewflow.yml');\n\nrun(({ app, getRouter }) => {\n  const mongoStores = mongoInit();\n  const slackHome = createSlackHomeWorker(mongoStores);\n  const appContext: AppContext = { mongoStores, slackHome };\n  appRouter(app, getRouter, appContext);\n  initApp(app, appContext);\n  slackHome.scheduleUpdateAllOrgs((id: number) => app.auth(id));\n});\n"],"names":["process","env","GITHUB_CLIENT_ID","Error","GITHUB_CLIENT_SECRET","oauth2","create","client","id","secret","auth","tokenHost","tokenPath","authorizePath","Layout","lang","title","REVIEWFLOW_NAME","children","React","padding","AUTH_SECRET_KEY","signPromisified","promisify","sign","verifyPromisified","verify","secure","SECURE_COOKIE","createRedirectUri","req","host","hostname","PORT","readAuthCookie","strategy","cookie","cookies","algorithm","audience","headers","getAuthInfoFromCookie","res","authInfo","clearCookie","undefined","createApi","octokitApp","accessToken","type","token","getUser","octokit","redirect","api","router","get","redirectUri","githubAuth","authorizationCode","authorizeURL","redirect_uri","scope","query","error","send","error_description","code","result","getToken","renderToStaticMarkup","access_token","user","users","getAuthenticated","data","login","time","Date","now","expiresIn","httpOnly","home","orgs","listForAuthenticatedUser","display","flexGrow","map","org","config","autoAssignToCreator","trimTitle","requiresReviewRequest","prDefaultOptions","featureBranch","autoMergeWithSkipCi","autoMerge","deleteAfterMerge","parsePR","regExp","summary","groups","dev","christophehurpeau","tilap","waitForGroups","teams","labels","list","name","color","review","ci","inProgress","succeeded","failed","needsReview","requested","changesRequested","approved","ignoreRepoPattern","autoMergeRenovateWithSkipCi","bot","status","statusInfoFromMatch","match","issue","inBody","url","botUsers","JulienBreux","ORNIKAR_EMAIL_DOMAIN","TheR3aLp3nGuinJM","abarreir","damienorny","darame07","Pixy","machartier","HugoGarrido","CorentinAndre","Mxime","vlbr","mdcarter","ChibiBlasphem","PSniezak","design","jperriere","CoralineColasse","Lenamari","loicleser","ops","logins","backends","frontends","description","duplicate","documentation","rfc","bug","enhancement","question","wontfix","chrisconfig","accountConfigs","ornikar","reviewflow","defaultDmSettings","cache","Map","getDefaultDmSettings","accountConfig","defaultConfig","updateCache","userId","newSettings","orgCache","set","getUserDmSettings","mongoStores","orgId","orgDefaultDmSettings","userDmSettingsConfig","userDmSettings","findOne","settings","syncOrg","github","installationId","orgInStore","upsertOne","_id","orgEmbed","memberIds","Promise","all","paginate","listMembers","endpoint","merge","member","push","orgMembers","deleteMany","$not","$in","syncTeams","teamIds","team","orgTeams","slug","dmMessages","orgSettings","find","o","params","findByKey","installation","apps","getOrgInstallation","catch","err","width","Object","entries","key","__html","patch","bodyParser","json","body","collection","updateOne","$set","value","updated","$setOnInsert","created","upsert","repository","repos","per_page","repo","owner","length","permissions","admin","data2","getRepoInstallation","syncUser","userInfo","userSettings","u","getUserInstallation","username","appRouter","app","getRouter","use","cookieParser","ExcludesFalsy","Boolean","ExcludesNullish","getOrCreateAccount","accountInfo","getKeys","keys","emojiRegex","createEmojiRegex","getEmojiFromRepoDescription","startsWith","emoji","exec","voidTeamSlack","mention","postMessage","resolve","updateMessage","deleteMessage","addReaction","updateHome","initTeamSlack","slackHome","context","account","payload","slackToken","githubLoginToSlackEmail","reduce","acc","groupName","assign","slackEmails","values","slackClient","WebClient","membersInDb","findAll","members","foundEmailMembers","forEach","email","m","slack","im","missingEmails","filter","includes","memberEmailToMemberId","page","profile","has","partialUpdateMany","conversations","open","channel","console","membersMap","getUserFromGithubLogin","githubLogin","category","githubId","message","log","debug","DRY_RUN","chat","text","blocks","attachments","secondaryBlocks","thread_ts","ts","ok","update","delete","reactions","add","timestamp","scheduleUpdateMember","initAccountContext","appContext","slackPromise","githubLoginToGroup","githubLoginToTeams","teamName","getReviewerGroups","githubLogins","Set","lock","Lock","accountEmbed","accountType","callback","reject","logInfos","info","createReleaseCallback","release","getReviewerGroup","getTeamsForLogin","approveShouldWait","reviewerGroup","requestedReviewers","includesReviewerGroup","includesWaitForGroups","requestedReviewerGroups","request","some","group","accountContextsPromise","accountContexts","obtainAccountContext","existingAccountContext","existingPromise","promise","then","accountContext","handlerOrgChange","organization","createHandlerOrgChange","options","optionsRegexps","option","regexp","RegExp","optionsLabels","label","parseOptions","content","defaultOptions","parseCommitNotes","commitNotes","replace","trim","parseBody","hasLabelInPR","prLabels","l","hasFailedStatusOrChecks","pr","checks","listForRef","ref","head","sha","failedChecks","check_runs","check","conclusion","combinedStatus","getCombinedStatusForRef","state","failedStatuses","statuses","autoMergeIfPossible","pullRequest","repoContext","reviewflowPrContext","autoMergeLabel","removePrFromAutomergeQueue","number","isRenovatePr","createMergeLockPrFromPr","branch","addLog","action","repoFullName","full_name","automergeLogs","insertOne","isRenovate","mergeableState","mergeable_state","hasNeedsReview","hasRequestedReview","requested_reviewers","lockedPr","getMergeLockedPr","String","prId","prNumber","pushAutomergeQueue","addMergeLockPr","mergeable","prResult","pulls","pull_number","merged","reschedule","renovateRebaseBody","issues","issue_number","base","parsedBody","commentBody","mergeResult","merge_method","commit_title","commit_message","defaultCommentBody","toMarkdownOptions","join","toMarkdownInfos","infos","getReplacement","updateOptions","optionsToUpdate","internalUpdateBodyOptionsAndInfos","infosAndCommitNotesParagraph","createCommentBody","updateCommentOptions","updatedOptions","updateCommentBodyInfos","updateCommentBodyCommitsNotes","removeDeprecatedReviewflowInPrBody","prBody","createReviewflowComment","pullRequestNumber","createComment","getReviewflowCommentById","commentId","getComment","comment_id","getReviewflowPrContext","reviewflowCommentPromise","prEmbed","comment","reviewflowPr","prs","repoEmbed","existing","partialUpdateByKey","fetchPr","getLabelsForRepo","listLabelsForRepo","initRepoLabels","finalLabels","labelKey","labelConfig","labelColor","slice","existingLabel","createLabel","current_name","updateLabel","shouldIgnoreRepo","repoName","ignoreRepoRegexp","test","createGetReviewLabelIds","shouldIgnore","reviewGroupNames","initRepoContext","fullName","repoEmoji","getReviewLabelIds","needsReviewLabelIds","requestedReviewLabelIds","changesRequestedLabelIds","approvedReviewLabelIds","protectedLabelIds","labelIdToGroupName","reviewGroupLabels","lockMergePr","automergeQueue","lockPR","prOrPrIssueId","setTimeout","hasChangesRequestedReview","hasApprovesReview","getNeedsReviewGroupNames","reason","shift","previousLength","p","lockPullRequest","repoContextsPromise","repoContexts","obtainRepoContext","existingRepoContext","warn","createRepoHandler","createPullRequestHandler","getPullRequestInPayload","callbackPr","callbackBeforeLock","createPullRequestsHandler","getPrs","checkrunCompleted","on","check_run","pull_requests","updatedPr","checksuiteCompleted","check_suite","createStatus","createCommitStatus","target_url","addStatusCheck","previousSha","hasPrCheck","head_sha","started_at","created_at","completed_at","toISOString","output","updateStatusCheckFromLabels","createFailedStatusCheck","rr","needsReviewGroupNames","updateReviewStatus","reviewGroup","labelsToAdd","remove","labelsToRemove","newLabelNames","toAdd","toAddNames","toDelete","toDeleteNames","getLabelFromKey","reviewConfig","prLabel","size","addLabels","toDeleteName","removeLabel","newLabelNamesArray","oldLabels","setLabels","closed","pull_request","isNotFork","git","deleteRef","assignees","assignee","createLink","createPrLink","html_url","createMrkdwnSectionBlock","createSlackMessageWithSecondaryBlock","secondaryBlockText","getPullRequestFromPayload","getReviewersAndReviewStates","userIds","reviewers","reviewStatesByUser","listReviews","reviews","toUpperCase","reviewStates","dismissed","reviewer","checkIfUserIsBot","checkIfIsThisBot","parse","issueParser","actions","issuePrefixes","parseMentions","mentions","slackifyCommentBody","multipleLines","slackifyMarkdown","getDiscussion","in_reply_to_id","listComments","c","getMentions","discussion","getUsersInThread","prCommentCreated","saveInDb","results","filtered","slackSentMessages","typeId","sentTo","pull_request_review_id","commentByOwner","followers","f","usersInThread","prUrl","slackUtils","ownerMention","commentLink","createMessage","toOwner","ownerPart","promisesOwner","promisesNotOwner","slackifiedBody","start_line","isBotUser","slackMessage","follower","updatePrCommentBody","newBody","updateComment","updatePrCommentBodyIfNeeded","updatePrCommentBodyOptions","syncLabel","shouldHaveLabel","prHasLabel","onRemove","onAdd","response","calcDefaultOptions","featureBranchLabel","automergeLabel","skipCiLabel","prHasFeatureBranchLabel","prHasSkipCiLabel","prHasAutoMergeLabel","syncLabelsAfterCommentBodyEdited","prCommentEditedOrDeleted","sender","closed_at","criteria","sentMessages","sentMessage","readCommitsAndUpdateInfos","commits","listCommits","conventionalCommits","commit","breakingChangesCommits","index","breakingChangesNotes","notes","note","breakingChangesLabel","newCommentBody","cleanNewLines","checkIfHasDiff","text1","text2","updatePrIfNeeded","hasDiffInTitle","hasDiffInBody","diff","cleanTitle","s","arg1","arg2","toLowerCase","editOpenedPR","shouldUpdateCommentBodyInfos","isPrFromBot","errorRule","rule","date","hasLintPrCheck","promises","commentBodyInfos","shouldCreateCommentBody","edited","updatedPullRequest","updateBranch","isFromRenovate","labelsChanged","fromRenovate","codeApprovedLabel","autoMergeSkipCiLabel","createReview","event","updateBranchLabel","autoApproveAndAutoMerge","autoAssignPRToCreator","addAssignees","opened","reviewDismissed","hasChangesRequestedInReviews","hasApprovals","hasRequestedReviewsForGroup","reviewRequestRemoved","requested_reviewer","hasApprovedInReviews","sentMessageRequestedReview","split","deleteOne","reviewRequested","getEmojiFromState","reviewSubmitted","reviewUrl","reviewByOwner","newLabels","isSameBranch","branches","b","synchronize","before","repoEdited","initApp","openedHandler","editedHandler","closedHandler","reopenedHandler","reviewRequestedHandler","reviewRequestRemovedHandler","reviewSubmittedHandler","reviewDismissedHandler","synchronizeHandler","commentCreated","commentEditedOrDeleted","MONGO_DB","init","MONGO_HOST","MONGO_PORT","MONGO_USER","MONGO_PASSWORD","connection","MongoConnection","MongoStore","coll","createIndex","unique","$lt","createSlackHomeWorker","updateMember","prsWithRequestedReviews","prsToMerge","prsWithRequestedChanges","prsInDraft","search","issuesAndPullRequests","q","sort","order","buildBlocks","total_count","items","repository_url","prFullName","elements","draft","image_url","avatar_url","alt_text","flat","views","publish","user_id","view","workerInterval","queueKeys","queue","stop","clearInterval","start","setInterval","item","memberId","scheduleUpdateOrg","cursor","scheduleUpdateAllOrgs","run","mongoInit"],"mappings":"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"}